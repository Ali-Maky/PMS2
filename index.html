<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#0d9488">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Zain PMS">
    <meta name="description" content="Zain Performance Management System - Enterprise Performance Tracking">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <link rel="apple-touch-icon" href="icon.svg">

    <!-- PERFORMANCE: Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- PERFORMANCE: DNS prefetch for faster resolution -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <title>Zain - Enterprise Performance Management</title>

    <!-- PERFORMANCE: Load fonts with display=swap for faster text rendering -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Main Stylesheet (flat path) -->
    <link rel="stylesheet" href="styles.css">

    <!-- PERFORMANCE: Defer non-critical scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight:700; color:#5eead4; font-size:1rem; letter-spacing:0.5px;">
            Initializing Zain Performance Management...
        </div>
    </div>

    <!-- Save Status Indicator -->
    <div id="save-status">
        <div class="save-dot" id="save-dot"></div>
        <span id="save-text">All changes saved</span>
    </div>

    <!-- Notification Center -->
    <div id="notification-overlay" class="notification-overlay" onclick="closeNotifications()"></div>
    <div id="notification-panel" class="notification-panel">
        <div class="notification-panel-header">
            <h3><i class="fa-solid fa-bell" style="margin-right:8px; color:var(--primary);"></i> Notifications</h3>
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="mark-all-read-btn" onclick="markAllNotificationsRead()" title="Mark all as read">
                    <i class="fa-solid fa-check-double"></i> Mark All Read
                </span>
                <button onclick="closeNotifications()" style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--text-muted);">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
        <div class="notification-panel-body" id="notification-list"></div>
    </div>

    <!-- User Modal -->
    <div id="modal-overlay">
        <div class="modal-card">
            <h3 id="modal-title" style="margin-top:0;">Add Employee</h3>
            <input type="hidden" id="edit-mode-id">
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Employee ID</label>
                <input id="u-id" class="login-input" placeholder="ZIQ...">
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Full Name</label>
                <input id="u-name" class="login-input" placeholder="John Doe">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Level</label>
                    <input id="u-lvl" class="login-input" placeholder="L4 Manager">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Job Title</label>
                    <input id="u-job" class="login-input" placeholder="Software Engineer">
                </div>
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Division</label>
                <input id="u-div" class="login-input" placeholder="Technology">
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Department</label>
                <input id="u-dept" class="login-input" placeholder="IT Development">
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Manager ID</label>
                <input id="u-mgr" class="login-input" placeholder="Manager ID or Name">
            </div>
            <div style="margin-bottom:25px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Password (Optional)</label>
                <input id="u-pass" type="password" class="login-input" placeholder="Set new password...">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-outline" onclick="closeUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveUser()">Save Employee</button>
            </div>
        </div>
    </div>

    <!-- OTP Modal -->
    <div id="otp-modal" class="modal-overlay" style="position:fixed; inset:0; z-index:9500; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,0.9); backdrop-filter:blur(5px);">
        <div class="modal-card" style="background:white; padding:40px; border-radius:24px; text-align:center; width:100%; max-width:400px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); border:1px solid #e5e7eb;">
            <div style="font-size:3rem; color:var(--primary); margin-bottom:16px;"><i class="fa-solid fa-shield-halved"></i></div>
            <h3 style="margin:0 0 8px 0; font-size:1.5rem; font-weight:800; color:#1f2937;">Verify Identity</h3>
            <p style="color:#6b7280; margin-bottom:24px; line-height:1.5;">Enter the 4-digit code sent to your registered contact.</p>
            <div style="display:flex; gap:12px; justify-content:center; margin-bottom:24px;">
                <input type="text" class="otp-digit" maxlength="1" style="width:50px; height:60px; font-size:1.5rem; text-align:center; border:2px solid #e5e7eb; border-radius:12px; font-weight:700;" onkeyup="focusNext(this)">
                <input type="text" class="otp-digit" maxlength="1" style="width:50px; height:60px; font-size:1.5rem; text-align:center; border:2px solid #e5e7eb; border-radius:12px; font-weight:700;" onkeyup="focusNext(this)">
                <input type="text" class="otp-digit" maxlength="1" style="width:50px; height:60px; font-size:1.5rem; text-align:center; border:2px solid #e5e7eb; border-radius:12px; font-weight:700;" onkeyup="focusNext(this)">
                <input type="text" class="otp-digit" maxlength="1" style="width:50px; height:60px; font-size:1.5rem; text-align:center; border:2px solid #e5e7eb; border-radius:12px; font-weight:700;" onkeyup="focusNext(this)">
            </div>
            <button class="btn btn-primary" onclick="verifyOTP()" style="width:100%; justify-content:center; padding:14px; font-size:1rem;">Verify & Login</button>
            <div style="margin-top:16px; font-size:0.85rem; color:#6b7280; cursor:pointer; text-decoration:underline;" onclick="resendOTP()">Resend Code</div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="login-screen" class="hidden">
        <div id="view-id" class="login-card">
            <div class="login-logo"><i class="fa-solid fa-rocket"></i></div>
            <h1 style="color:var(--text-main); margin:0 0 8px 0; font-size:1.8rem; font-weight:800;">Zain Performance Management System</h1>
            <p style="color:var(--text-muted); margin-bottom:32px; font-weight:500;">Enterprise Performance Management</p>
            <div style="text-align:left; margin-bottom:24px;">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Employee ID</label>
                <input type="text" id="inp-id" class="login-input" placeholder="e.g. ZIQ03130" onkeypress="if(event.key==='Enter') checkID()">
            </div>
            <button onclick="checkID()" class="login-btn" id="btn-check">Continue <i class="fa-solid fa-arrow-right" style="margin-left:8px;"></i></button>
            <p id="err-id" style="color:var(--danger); margin-top:16px; font-weight:600; font-size:0.9rem; display:none;"><i class="fa-solid fa-circle-exclamation"></i> ID not found</p>
        </div>

        <div id="view-pass" class="login-card hidden">
            <div class="login-logo"><i class="fa-solid fa-lock"></i></div>
            <h1 id="lbl-welcome" style="color:var(--text-main); margin:0 0 8px 0; font-size:1.8rem; font-weight:800;">Welcome Back</h1>
            <p style="color:var(--text-muted); margin-bottom:32px; font-weight:500;">Please enter your password</p>
            <div style="text-align:left; margin-bottom:24px;">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Password</label>
                <input type="password" id="inp-pass" class="login-input" placeholder="••••••••" onkeypress="if(event.key==='Enter') doLogin()">
            </div>
            <div id="grp-confirm" style="text-align:left; margin-bottom:24px;" class="hidden">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Confirm Password</label>
                <input type="password" id="inp-confirm" class="login-input" placeholder="••••••••" onkeypress="if(event.key==='Enter') doLogin()">
            </div>
            <button onclick="doLogin()" class="login-btn" id="btn-login">Log In</button>
            <div class="back-link" onclick="location.reload()" style="margin-top:20px; color:var(--text-muted); cursor:pointer; font-size:0.9rem; font-weight:600;">Switch Account</div>
            <p id="err-pass" style="color:var(--danger); margin-top:16px; font-weight:600; font-size:0.9rem; display:none;"><i class="fa-solid fa-circle-exclamation"></i> Incorrect Password</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container">
        <aside class="sidebar">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:32px;">
                <div class="brand" style="margin-bottom:0;"><i class="fa-solid fa-bolt"></i> <span>Performance Management System</span></div>
                <div class="notification-bell" onclick="toggleNotifications()">
                    <i class="fa-solid fa-bell"></i>
                    <span class="notification-badge" id="notification-count" style="display:none;">0</span>
                </div>
            </div>
            <nav id="nav-menu" style="flex:1; display:flex; flex-direction:column;"></nav>
            <div class="user-panel">
                <div style="font-weight:700; font-size:0.95rem; color:var(--text-main);" id="disp-user">User</div>
                <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;" id="disp-role">Role</div>
                <button class="btn btn-outline" style="width:100%; justify-content:center; color:#fca5a5; border-color:rgba(239, 68, 68, 0.3); background:rgba(239, 68, 68, 0.15);" onclick="logout()">
                    <i class="fa-solid fa-power-off"></i> <span>Log Out</span>
                </button>
            </div>
        </aside>
        <main class="main-content" id="main-view"></main>
        <input type="file" id="file-import" hidden accept=".xlsx, .xls, .csv" onchange="processFile(this)">
        <input type="file" id="file-bulk" hidden accept=".xlsx, .xls, .csv" onchange="processBulkImport(this)">
        <input type="file" id="file-users" hidden accept=".xlsx, .xls, .csv" onchange="processUserBulkImport(this)">
    </div>

    <!-- Division Weight Modal -->
    <div id="div-weight-modal" class="hidden" style="position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center;">
        <div style="width:min(860px,92vw); background:white; border-radius:20px; box-shadow:0 25px 60px rgba(0,0,0,0.25); overflow:hidden;">
            <div style="padding:18px 22px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div id="div-weight-title" style="font-weight:800; font-size:1.05rem;">Division Weights</div>
                    <div id="div-weight-sub" style="color:#6b7280; font-size:0.9rem; margin-top:4px;"></div>
                </div>
                <button class="btn btn-outline" onclick="closeDivisionWeights()">Close</button>
            </div>
            <div style="padding:18px 22px; max-height:70vh; overflow:auto;">
                <div style="display:flex; gap:14px; align-items:center; margin-bottom:16px;">
                    <div style="flex:1;">
                        <div style="font-size:0.75rem; font-weight:800; color:#6b7280; text-transform:uppercase;">Employees Weight (Default)</div>
                        <input id="div-weight-default" type="number" step="0.01" min="0" max="1" style="width:220px; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-weight:800;">
                        <div style="color:#6b7280; font-size:0.85rem; margin-top:6px;">Applies to all non-manager employees in this division.</div>
                    </div>
                </div>
                <div style="margin-top:10px; font-weight:800;">Managers (Overrides)</div>
                <div id="div-weight-managers" style="display:grid; gap:10px; margin-top:10px;"></div>
            </div>
            <div style="padding:16px 22px; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-primary" onclick="saveDivisionWeights()">Save</button>
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" style="display:none; position:fixed; bottom:20px; left:50%; transform:translateX(-50%); background:#ef4444; color:white; padding:12px 24px; border-radius:12px; font-weight:600; z-index:99999; box-shadow:0 4px 20px rgba(0,0,0,0.3);">
        <i class="fa-solid fa-wifi-slash"></i> &nbsp; You're offline
    </div>

    <!-- Toast Container -->
    <div id="toast-container" style="position:fixed; top:20px; right:20px; z-index:99999; display:flex; flex-direction:column; gap:10px;"></div>

    <!-- Confirm Modal -->
    <div id="confirm-overlay">
        <div class="confirm-card">
            <div style="width:64px; height:64px; background:linear-gradient(135deg, #0d9488, #14b8a6); border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 16px;">
                <i class="fa-solid fa-question" style="font-size:1.5rem; color:white;"></i>
            </div>
            <h3 id="conf-title" style="margin:0 0 8px 0; font-size:1.3rem; font-weight:800; color:#1f2937;">Confirm Action</h3>
            <p id="conf-msg" style="color:#6b7280; margin:0 0 24px 0; line-height:1.5;">Are you sure you want to proceed?</p>
            <div style="display:flex; gap:12px; justify-content:center;">
                <button class="btn btn-outline" onclick="closeConfirm()" style="padding:12px 24px;">Cancel</button>
                <button id="conf-btn-yes" class="btn btn-primary" onclick="doConfirm()" style="padding:12px 24px;"><i class="fa-solid fa-check"></i> Confirm</button>
            </div>
        </div>
    </div>

    <!-- Main Application Script (flat path) -->
    <script src="app-bundle.js"></script>

    <!-- Service Worker Registration & PWA Setup -->
    <script>
        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => {
                        console.log('✅ Service Worker registered:', reg.scope);
                        
                        // Check for updates periodically
                        setInterval(() => {
                            reg.update();
                        }, 60 * 60 * 1000); // Check every hour
                    })
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // Online/Offline detection
        function updateOnlineStatus() {
            const indicator = document.getElementById('offline-indicator');
            if (navigator.onLine) {
                indicator.style.display = 'none';
                // Sync any pending changes when back online
                if (typeof syncPendingChanges === 'function') {
                    syncPendingChanges();
                }
            } else {
                indicator.style.display = 'block';
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // PWA Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log('PWA install available');
        });
    </script>
</body>
</html>
