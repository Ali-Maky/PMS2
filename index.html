<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zain - Enterprise Suite</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- KEEPING ALL YOUR ORIGINAL STYLES EXACTLY AS THEY WERE --- */
        .pro-goal-meta { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
        .pro-unit-badge { background: #e0f2fe; color: #0369a1; font-weight: 700; font-size: 0.8rem; padding: 6px 12px; border-radius: 20px; border: 1px solid #bae6fd; display: flex; align-items: center; gap: 4px; }
        .badge-score { padding: 6px 12px; border-radius: 8px; font-weight: 800; font-family: monospace; display: inline-block; min-width: 60px; text-align: center; }
        .badge-rating { padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
        .lvl-6 { background: #592C82; color: white; }
        .lvl-5 { background: #10b981; color: white; }
        .lvl-4 { background: #3b82f6; color: white; }
        .lvl-3 { background: #f59e0b; color: white; }
        .lvl-2 { background: #ef4444; color: white; }
        .lvl-1 { background: #94a3b8; color: white; }
        .lvl-0 { background: #f1f5f9; color: var(--text-muted); }
        :root { --primary: #6366f1; --primary-dark: #4338ca; --primary-light: #e0e7ff; --secondary: #ec4899; --bg-body: #f3f4f6; --bg-card: #ffffff; --bg-sidebar: #ffffff; --text-main: #1f2937; --text-muted: #6b7280; --text-light: #9ca3af; --border: #e5e7eb; --border-hover: #d1d5db; --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #3b82f6; --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05); --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); --shadow-glow: 0 0 15px rgba(99, 102, 241, 0.3); --radius-lg: 16px; --radius-md: 12px; --radius-sm: 8px; --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); --font-main: 'Inter', sans-serif; }
        * { box-sizing: border-box; outline: none; }
        html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); -webkit-font-smoothing: antialiased; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        #loading-overlay { position: fixed; inset: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(8px); z-index: 3000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 3px solid var(--primary-light); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s cubic-bezier(0.55, 0.055, 0.675, 0.19) infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #save-status { position: fixed; bottom: 30px; right: 30px; background: var(--bg-card); padding: 12px 24px; border-radius: 30px; box-shadow: var(--shadow-lg); font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 12px; z-index: 2000; transform: translateY(100px); transition: var(--transition); border: 1px solid var(--border); }
        #save-status.show { transform: translateY(0); }
        .save-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--text-light); }
        .save-dot.saving { background: var(--warning); animation: pulse 1s infinite; }
        .save-dot.saved { background: var(--success); }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(0.8); } }
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #f0fdfa, #f5f3ff); display: flex; justify-content: center; align-items: center; z-index: 2000; background-image: radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.1) 0, transparent 50%), radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0, transparent 50%); }
        .login-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(12px); width: 420px; padding: 48px; border-radius: 24px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); border: 1px solid rgba(255, 255, 255, 0.5); animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        .login-logo { width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: 16px; color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px auto; box-shadow: var(--shadow-glow); }
        .login-input { width: 100%; padding: 14px 18px; border: 2px solid transparent; border-radius: 12px; font-size: 0.95rem; background: #f3f4f6; margin-top: 8px; transition: var(--transition); color: var(--text-main); }
        .login-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 4px var(--primary-light); }
        .login-btn { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 1rem; margin-top: 24px; transition: var(--transition); box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        #app-container { display: none; width: 100vw; height: 100vh; overflow: hidden; flex-direction: row; background: #f8fafc; }
        .sidebar { width: 280px; min-width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 32px 24px; display: flex; flex-direction: column; z-index: 10; flex-shrink: 0; height: 100%; box-shadow: var(--shadow-sm); }
        .main-content { flex: 1; height: 100%; overflow-y: auto; padding: 40px; background: #f9fafb; min-width: 0; }
        .brand { font-size: 1.4rem; font-weight: 800; color: var(--text-main); margin-bottom: 48px; display: flex; align-items: center; gap: 14px; letter-spacing: -0.5px; }
        .brand i { color: var(--primary); background: var(--primary-light); padding: 8px; border-radius: 8px; }
        .nav-item { padding: 14px 18px; border-radius: 12px; color: var(--text-muted); font-weight: 600; cursor: pointer; display: flex; gap: 14px; align-items: center; margin-bottom: 8px; transition: var(--transition); font-size: 0.95rem; }
        .nav-item:hover { background: #f3f4f6; color: var(--text-main); }
        .nav-item.active { background: linear-gradient(90deg, var(--primary-light), transparent); color: var(--primary); border-left: 3px solid var(--primary); border-radius: 4px 12px 12px 4px; }
        .user-panel { border-top: 1px solid var(--border); padding-top: 24px; margin-top: auto; display: flex; flex-direction: column; gap: 16px; }
        .card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); width: 100%; transition: var(--transition); }
        .card:hover { box-shadow: var(--shadow-md); border-color: var(--border-hover); }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; width: 100%; }
        .page-title { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 0; letter-spacing: -1px; background: linear-gradient(45deg, var(--text-main), var(--text-muted)); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .page-sub { color: var(--text-muted); margin: 6px 0 0 0; font-size: 1rem; font-weight: 500; }
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; width: 100%; }
        .metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 24px; margin-bottom: 32px; width: 100%; }
        .metric-card { background: white; padding: 24px; border-radius: var(--radius-lg); border: 1px solid var(--border); text-align: center; box-shadow: var(--shadow-sm); transition: var(--transition); }
        .metric-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); }
        .metric-card.highlight { background: linear-gradient(145deg, var(--primary), var(--primary-dark)); color: white; border: none; box-shadow: var(--shadow-glow); }
        .metric-val { font-size: 2.5rem; font-weight: 800; line-height: 1.1; letter-spacing: -1px; }
        .metric-lbl { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-top: 10px; opacity: 0.8; letter-spacing: 1px; }
        .shared-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 24px; }
        .shared-card { background: white; border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 0; overflow: hidden; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; transition: var(--transition); }
        .shared-card:hover { box-shadow: var(--shadow-md); transform: translateY(-2px); }
        .shared-header { padding: 16px 24px; background: #f9fafb; border-bottom: 1px solid var(--border); font-weight: 700; font-size: 1rem; color: var(--text-main); }
        .segment-bar { display: flex; padding: 12px; gap: 4px; flex: 1; align-items: stretch; min-height: 90px; }
        .segment { flex: 1; border-radius: 8px; background: #f1f5f9; border: 1px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: var(--transition); padding: 4px; }
        .seg-num { font-size: 0.8rem; font-weight: 800; color: var(--text-light); margin-bottom: 4px; }
        .seg-val { font-size: 0.65rem; color: var(--text-muted); text-align: center; line-height: 1.25; font-weight: 600; }
        .segment.is-target { background: #eff6ff; border-color: #bfdbfe; }
        .segment.is-target .seg-num { color: #3b82f6; }
        .target-badge { position: absolute; top: -6px; background: #3b82f6; color: white; font-size: 0.5rem; padding: 2px 6px; border-radius: 99px; font-weight: 800; text-transform: uppercase; box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3); }
        .segment.active { background: var(--primary) !important; color: white !important; transform: scale(1.1); z-index: 10; box-shadow: var(--shadow-lg); border-radius: 8px; }
        .segment.active .seg-num, .segment.active .seg-val { color: white !important; }
        .goal-card { background: white; border: 1px solid var(--border); border-radius: var(--radius-lg); margin-bottom: 24px; overflow: hidden; box-shadow: var(--shadow-sm); border-left: 6px solid var(--primary); transition: var(--transition); }
        .goal-card:hover { box-shadow: var(--shadow-md); }
        .goal-header-row { padding: 20px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fff; }
        .goal-input-title { font-weight: 700; color: var(--text-main); font-size: 1.1rem; border: none; width: 60%; background: transparent; font-family: inherit; }
        .chip { display: flex; align-items: center; gap: 8px; background: #f3f4f6; padding: 8px 16px; border-radius: 99px; border: 1px solid var(--border); font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }
        .chip input { border: none; background: transparent; width: 40px; text-align: right; font-weight: 800; color: var(--primary); }
        .goal-body { padding: 24px; background: #fcfcfc; }
        .goal-desc { width: 100%; border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 20px; font-family: inherit; font-size: 0.95rem; background: white; resize: none; transition: var(--transition); }
        .goal-desc:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }
        .target-table { width: 100%; border-collapse: separate; border-spacing: 4px; font-size: 0.85rem; }
        .target-table th { padding: 8px; color: var(--text-light); font-weight: 700; text-transform: uppercase; text-align: center; font-size: 0.7rem; letter-spacing: 0.5px; }
        .target-table td { padding: 0; }
        .target-input { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 16px; text-align: center; font-weight: 600; background: white; font-size: 0.9rem; transition: var(--transition); color: var(--text-main); }
        .target-input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); z-index: 2; position: relative; }
        .report-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; font-size: 0.95rem; margin-top: -8px; }
        .report-table th { text-align: left; padding: 0 20px 8px 20px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; font-weight: 700; letter-spacing: 0.5px; }
        .report-table td { padding: 20px; background: white; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); transition: var(--transition); }
        .report-table tr:hover td { background: #f9fafb; border-color: #cbd5e1; transform: scale(1.005); }
        .report-table tr td:first-child { border-left: 1px solid var(--border); border-top-left-radius: 12px; border-bottom-left-radius: 12px; font-weight: 600; color: var(--text-main); }
        .report-table tr td:last-child { border-right: 1px solid var(--border); border-top-right-radius: 12px; border-bottom-right-radius: 12px; }
        .prog-track { width: 100%; height: 8px; background: #e2e8f0; border-radius: 99px; overflow: hidden; }
        .prog-fill { height: 100%; border-radius: 99px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; }
        .member-card { background: white; border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; transition: var(--transition); cursor: pointer; display: flex; gap: 20px; align-items: center; box-shadow: var(--shadow-sm); }
        .member-card:hover { border-color: var(--primary); transform: translateY(-4px); box-shadow: var(--shadow-lg); }
        .avatar { width: 56px; height: 56px; background: linear-gradient(135deg, var(--primary-light), white); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.4rem; box-shadow: var(--shadow-sm); }
        .info-panel { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 32px; background: white; border: 1px solid var(--border); padding: 32px; border-radius: var(--radius-lg); margin-bottom: 32px; box-shadow: var(--shadow-sm); }
        .info-item label { display: block; font-size: 0.75rem; color: var(--text-light); font-weight: 700; text-transform: uppercase; margin-bottom: 8px; letter-spacing: 0.5px; }
        .info-value { font-weight: 600; color: var(--text-main); font-size: 1.05rem; }
        .btn { padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; transition: var(--transition); font-size: 0.95rem; border: 1px solid transparent; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f9fafb; border-color: var(--text-muted); box-shadow: var(--shadow-sm); }
        .btn-delete { width: 36px; height: 36px; border-radius: 50%; color: var(--text-light); display: flex; align-items: center; justify-content: center; cursor: pointer; background: transparent; border: none; transition: var(--transition); }
        .btn-delete:hover { background: #fee2e2; color: var(--danger); transform: scale(1.1); }
        .hidden { display: none !important; }
        .animate-in { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        .admin-tab { padding: 12px 24px; cursor: pointer; font-weight: 600; color: var(--text-muted); border-bottom: 2px solid transparent; transition: var(--transition); }
        .admin-tab:hover { color: var(--text-main); }
        .admin-tab.active { color: var(--primary); border-color: var(--primary); }
        .status-badge { padding: 6px 12px; border-radius: 99px; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.5px; }
        .status-badge.submitted { background: var(--primary-light); color: var(--primary); }
        .status-badge.approved { background: #d1fae5; color: var(--success); }
        .prog-container { width: 120px; height: 10px; background: #e2e8f0; border-radius: 99px; overflow: hidden; }
        .prog-bar { height: 100%; border-radius: 99px; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .target-input.active-highlight { border: 2px solid var(--primary) !important; background: var(--primary-light) !important; color: var(--primary); font-weight: 800; transform: scale(1.05); z-index: 5; box-shadow: var(--shadow-md); }
        .draft-badge { background: #fef3c7; color: #d97706; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; display: inline-flex; align-items: center; gap: 6px; border: 1px solid #fcd34d; }
        #modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(4px); z-index: 4000; display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: var(--transition); }
        #modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-card { background: white; width: 550px; padding: 40px; border-radius: 24px; transform: translateY(30px) scale(0.95); transition: var(--transition); box-shadow: var(--shadow-lg); max-height: 90vh; overflow-y: auto; }
        #modal-overlay.open .modal-card { transform: translateY(0) scale(1); }
        .pro-goal-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; transition: all 0.2s ease; position: relative; }
        .pro-goal-card:hover { border-color: var(--primary-light); box-shadow: var(--shadow-md); }
        .pro-goal-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 20px; margin-bottom: 20px; }
        .pro-goal-title-input { width: 100%; font-size: 1.1rem; font-weight: 700; color: var(--text-main); border: 1px solid transparent; background: transparent; padding: 8px; border-radius: 6px; transition: all 0.2s; }
        .pro-goal-title-input:focus, .pro-goal-title-input:hover { background: #f8fafc; border-color: var(--border); }
        .pro-goal-title-input:focus { border-color: var(--primary); background: white; }
        .pro-weight-badge { background: #f1f5f9; color: var(--text-main); font-weight: 600; font-size: 0.85rem; padding: 6px 12px; border-radius: 20px; border: 1px solid var(--border); display: flex; align-items: center; gap: 6px; }
        .pro-weight-input { width: 40px; text-align: right; background: transparent; border: none; font-weight: 700; color: var(--primary); outline: none; }
        .pro-goal-desc { width: 100%; border: 1px solid var(--border); border-radius: 8px; padding: 12px; font-family: inherit; font-size: 0.95rem; color: var(--text-slate); margin-bottom: 20px; background: #fdfdfd; resize: vertical; min-height: 60px; transition: all 0.2s; }
        .pro-goal-desc:focus { border-color: var(--primary); background: white; }
        .pro-targets-container { border: 1px solid var(--border); border-radius: 10px; overflow: hidden; display: grid; grid-template-columns: repeat(6, 1fr); }
        .pro-target-item { border-right: 1px solid var(--border); background: white; }
        .pro-target-item:last-child { border-right: none; }
        .pro-target-header { background: #f8fafc; padding: 8px; text-align: center; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        .pro-target-item.is-target .pro-target-header { background: var(--primary-soft); color: var(--primary); }
        .pro-target-val input { width: 100%; text-align: center; border: none; padding: 12px 4px; font-size: 0.9rem; font-weight: 600; outline: none; background: transparent; }
        .pro-target-val input:focus { background: #fffbeb; }
        .pro-goal-footer { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; align-items: center; gap: 16px; }
        .app-container { display: flex; min-height: 100vh; }
        .sidebar { background: white; border-right: 1px solid var(--border); box-shadow: var(--shadow-sm); width: 280px; height: 100vh; position: sticky; top: 0; display: flex; flex-direction: column; flex-shrink: 0; z-index: 100; }
        .user-panel { padding: 24px; border-top: 1px solid var(--border); flex-shrink: 0; background: white; }
        #nav-menu { overflow-y: auto; flex: 1; }
        .nav-item { padding: 12px 16px; margin: 4px 12px; border-radius: 8px; color: var(--text-muted); font-weight: 600; cursor: pointer; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); display: flex; align-items: center; gap: 12px; border: 1px solid transparent; }
        .nav-item:hover { background: #f8fafc; color: var(--text-main); }
        .nav-item.active { background: var(--primary-soft); color: var(--primary); border-color: #e0e7ff; }
        .nav-item i { width: 24px; text-align: center; font-size: 1.1rem; }
        #toast-container { position: fixed; bottom: 32px; right: 32px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast { background: white; border-left: 4px solid var(--primary); padding: 16px 24px; border-radius: 12px; box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 16px; min-width: 320px; max-width: 400px; transform: translateX(120%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: auto; }
        .toast.show { transform: translateX(0); }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .toast-icon { font-size: 1.4rem; flex-shrink: 0; }
        .toast.success .toast-icon { color: var(--success); }
        .toast.error .toast-icon { color: var(--danger); }
        .toast-msg { font-weight: 600; color: var(--text-main); font-size: 0.95rem; line-height: 1.4; }
        #confirm-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 9999; backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; }
        #confirm-overlay.open { display: flex; animation: fadeIn 0.2s forwards; }
        .confirm-card { background: white; width: 90%; max-width: 420px; padding: 32px; border-radius: 20px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); text-align: center; transform: scale(0.95); opacity: 0; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        #confirm-overlay.open .confirm-card { transform: scale(1); opacity: 1; }
        .premium-team-card { background: white; border-radius: 20px; padding: 32px 24px 24px 24px; box-shadow: var(--shadow-sm); transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); border: 1px solid var(--border); position: relative; overflow: hidden; cursor: pointer; display: flex; flex-direction: column; }
        .premium-team-card:hover { transform: translateY(-8px); box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1); border-color: var(--primary-light); }
        .pt-avatar { width: 72px; height: 72px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #818cf8); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; font-weight: 800; margin: 0 auto 20px auto; box-shadow: 0 4px 6px -1px rgb(99 102 241 / 0.3); }
        .pt-info { text-align: center; margin-bottom: 24px; flex-grow: 1; }
        .pt-name { font-weight: 800; font-size: 1.15rem; color: var(--text-main); margin-bottom: 6px; letter-spacing: -0.025em; }
        .pt-role { font-size: 0.9rem; color: var(--text-muted); font-weight: 500; }
        .pt-status { position: absolute; top: 16px; right: 16px; font-size: 0.7rem; letter-spacing: 0.05em; text-transform: uppercase; }
        #user-modal.open { opacity: 1 !important; pointer-events: auto; }
        #user-modal.open .modal-card { transform: scale(1) !important; opacity: 1 !important; }
        #goal-modal.open { opacity: 1 !important; pointer-events: auto; }
        #goal-modal.open .modal-card { transform: scale(1) !important; opacity: 1 !important; }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight:700; color:#592C82; font-size:1rem; letter-spacing:0.5px;">Initializing Zain Performance Management...</div>
    </div>

    <div id="save-status">
        <div class="save-dot" id="save-dot"></div>
        <span id="save-text">All changes saved</span>
    </div>

    <div id="login-screen" class="hidden">
        <div id="view-id" class="login-card">
            <div class="login-logo"><i class="fa-solid fa-rocket"></i></div>
            <h1 style="color:var(--text-main); margin:0 0 8px 0; font-size:1.8rem; font-weight:800;">Zain Performance Management System</h1>
            <p style="color:var(--text-muted); margin-bottom:32px; font-weight:500;">Enterprise Performance Management</p>
            <div style="text-align:left; margin-bottom:24px;">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Employee ID</label>
                <input type="text" id="inp-id" class="login-input" placeholder="e.g. ZIQ03130" onkeypress="if(event.key==='Enter') checkID()">
            </div>
            <button onclick="checkID()" class="login-btn" id="btn-check">Continue <i class="fa-solid fa-arrow-right" style="margin-left:8px;"></i></button>
            <p id="err-id" style="color:var(--danger); margin-top:16px; font-weight:600; font-size:0.9rem; display:none;"><i class="fa-solid fa-circle-exclamation"></i> ID not found</p>
        </div>

        <div id="view-pass" class="login-card hidden">
            <div class="login-logo"><i class="fa-solid fa-lock"></i></div>
            <h1 id="lbl-welcome" style="color:var(--text-main); margin:0 0 8px 0; font-size:1.8rem; font-weight:800;">Welcome Back</h1>
            <p style="color:var(--text-muted); margin-bottom:32px; font-weight:500;">Please enter your password</p>
            <div style="text-align:left; margin-bottom:24px;">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Password</label>
                <input type="password" id="inp-pass" class="login-input" placeholder="••••••••" onkeypress="if(event.key==='Enter') doLogin()">
            </div>
            <div id="grp-confirm" style="text-align:left; margin-bottom:24px;" class="hidden">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Confirm Password</label>
                <input type="password" id="inp-confirm" class="login-input" placeholder="••••••••" onkeypress="if(event.key==='Enter') doLogin()">
            </div>
            <button onclick="doLogin()" class="login-btn" id="btn-login">Log In</button>
            <div class="back-link" onclick="location.reload()" style="margin-top:20px; color:var(--text-muted); cursor:pointer; font-size:0.9rem; font-weight:600;">Switch Account</div>
            <p id="err-pass" style="color:var(--danger); margin-top:16px; font-weight:600; font-size:0.9rem; display:none;"><i class="fa-solid fa-circle-exclamation"></i> Incorrect Password</p>
        </div>
    </div>

    <div id="app-container">
        <aside class="sidebar">
            <div class="brand"><i class="fa-solid fa-bolt"></i> Performance Management System </div>
            <nav id="nav-menu" style="flex:1; display:flex; flex-direction:column;"></nav>
            <div class="user-panel">
                <div style="font-weight:700; font-size:0.95rem; color:var(--text-main);" id="disp-user">User</div>
                <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;" id="disp-role">Role</div>
                <button class="btn btn-outline" style="width:100%; justify-content:center; color:var(--danger); border-color:#fee2e2; background:#fff1f2;" onclick="logout()"><i class="fa-solid fa-power-off"></i> Log Out</button>
            </div>
        </aside>
        <main class="main-content" id="main-view"></main>
        <input type="file" id="file-import" hidden accept=".xlsx, .xls, .csv" onchange="processFile(this)">
        <input type="file" id="file-bulk" hidden accept=".xlsx, .xls, .csv" onchange="processBulkImport(this)">
        <input type="file" id="file-users" hidden accept=".xlsx, .xls, .csv" onchange="processUserBulkImport(this)">
    </div>

    <div id="toast-container"></div>
    <div id="confirm-overlay">
        <div class="confirm-card">
            <div style="font-size:3rem; color:var(--text-muted); margin-bottom:16px;"><i class="fa-regular fa-circle-question"></i></div>
            <h3 id="conf-title" style="margin:0 0 8px 0; font-size:1.4rem;">Confirm Action</h3>
            <p id="conf-msg" style="color:var(--text-muted); margin-bottom:32px; line-height:1.5;">Are you sure you want to proceed?</p>
            <div style="display:flex; justify-content:center; gap:16px;">
                <button class="btn btn-outline" onclick="closeConfirm()">Cancel</button>
                <button id="conf-btn-yes" class="btn btn-primary" onclick="doConfirm()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="user-modal" class="modal-overlay" style="position:fixed; inset:0; z-index:9000; display:none; align-items:center; justify-content:center; transition: opacity 0.3s;">
        <div class="modal-card" style="background:white; width:90%; max-width:600px; padding:32px; border-radius:20px; transform:scale(0.95); opacity:0; transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h3 id="um-title" style="margin:0; font-size:1.4rem; font-weight:700;">Edit Employee</h3>
                <button onclick="closeUserModal()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <input type="hidden" id="um-orig-id">
            <div class="dash-grid" style="grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px;">
                <div style="grid-column:1/-1;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Full Name</label>
                    <input id="um-name" class="login-input" style="margin-top:4px;" placeholder="Full Name">
                </div>
                <div style="grid-column:1/-1;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Email Address</label>
                    <input id="um-email" class="login-input" style="margin-top:4px;" placeholder="employee@zain.com">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Phone Number</label>
                    <input id="um-phone" class="login-input" style="margin-top:4px;" placeholder="077XXXXXXXX">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Employee ID</label>
                    <input id="um-id" class="login-input" style="margin-top:4px;" placeholder="ID (e.g. ZIQ...)">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Division</label>
                    <input id="um-div" class="login-input" style="margin-top:4px;" placeholder="e.g. Technology">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Direct Manager</label>
                    <input id="um-mgr" class="login-input" style="margin-top:4px;" placeholder="Manager Name or ID">
                </div>
                <div style="grid-column:1/-1;">
                     <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Job Title</label>
                     <input id="um-job" class="login-input" style="margin-top:4px;" placeholder="Software Engineer">
                </div>
                <div style="grid-column:1/-1;">
                     <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Role (User/Admin)</label>
                     <input id="um-role" class="login-input" style="margin-top:4px;" placeholder="User">
                </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn btn-outline" onclick="closeUserModal()">Cancel</button>
                <button id="um-btn" class="btn btn-primary" onclick="saveUser()">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="goal-modal" class="modal-overlay" style="position:fixed; inset:0; z-index:9000; display:none; align-items:center; justify-content:center; transition: opacity 0.3s;">
        <div class="modal-card" style="background:white; width:90%; max-width:800px; padding:32px; border-radius:20px; transform:scale(0.95); opacity:0; transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h3 id="gm-title" style="margin:0; font-size:1.4rem; font-weight:700;">Add New Objective</h3>
                <button onclick="closeGoalModal()" style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text-muted);"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="dash-grid" style="grid-template-columns:2fr 1fr 1fr; gap:20px; margin-bottom:24px;">
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Objective Title</label>
                    <input id="gm-title-inp" class="login-input" style="margin-top:4px;" placeholder="e.g. Increase Market Share">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Unit</label>
                    <input id="gm-unit" class="login-input" style="margin-top:4px;" placeholder="e.g. %, USD, #">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Weight (%)</label>
                    <input id="gm-weight" type="number" class="login-input" style="margin-top:4px;" placeholder="e.g. 20">
                </div>
                <div style="grid-column:1/-1;">
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Description & KPI</label>
                    <textarea id="gm-desc" class="login-input" rows="3" style="margin-top:4px; height:auto; padding:12px;" placeholder="Describe the objective and how it is measured..."></textarea>
                </div>
            </div>
            <div style="margin-bottom:24px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; display:block; margin-bottom:8px;">Target Definition (KPI Levels)</label>
                <div style="display:grid; grid-template-columns:repeat(6, 1fr); gap:8px;">
                    <div style="text-align:center;">
                        <div class="pro-target-header" style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">IDLE</div>
                        <input class="gm-target-inp login-input" style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header" style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">STAGNANT</div>
                        <input class="gm-target-inp login-input" style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header" style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">WALKER</div>
                        <input class="gm-target-inp login-input" style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header" style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0; background:var(--primary-soft); color:var(--primary);">RUNNER (Target)</div>
                        <input class="gm-target-inp login-input" style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem; border-color:var(--primary-light); background:var(--primary-soft);" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header" style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">FLYER</div>
                        <input class="gm-target-inp login-input" style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header" style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">ASTRONAUT</div>
                        <input class="gm-target-inp login-input" style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                </div>
            </div>
            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn btn-outline" onclick="closeGoalModal()">Cancel</button>
                <button id="gm-btn" class="btn btn-primary" onclick="saveGoal()">Save Objective</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // **** PASTE YOUR RAILWAY URL BELOW ****
        const BACKEND_URL = 'https://pms-back-production-b693.up.railway.app'; 
        const IDLE_LIMIT = 3600000;
        const MASTER_ADMIN_TITLE = "Head of Employee Growth and Relation Department";
        const SHARED_GOALS_ID = 'shared_goals_v1';

        // --- 2. BACKEND BRIDGE ---
        async function callBackend(action, body = {}) {
            try {
                // Use the action query param for routing
                const response = await fetch(`${BACKEND_URL}?action=${action}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });
                return await response.json();
            } catch (err) {
                console.error("Backend Error:", err);
                showToast("Connection to server lost.", "error");
                return { error: true, message: "Network Error" };
            }
        }

        // --- 3. DATA & STATE ---
        const defaultIndivGoals = [
            { title: "Functional Objective 1", weight: 0.40, desc: "", rating: 0, targets: ["", "", "", "", "", ""] },
            { title: "Functional Objective 2", weight: 0.30, desc: "", rating: 0, targets: ["", "", "", "", "", ""] },
            { title: "Development Objective", weight: 0.30, desc: "", rating: 0, targets: ["", "", "", "", "", ""] }
        ];
        const ratingLabels = { 1: "IDLE", 2: "STAGNANT", 3: "WALKER", 4: "RUNNER", 5: "FLYER", 6: "ASTRONAUT" };

        let user, targetUser, isManager, isDirectSupervisor, isRegistering;
        let masterData = { rating: 0, goals: [] };
        let hasDraft = false;
        let saveTimer;
        let chart1, chartAdmin, chartOrg;
        let COL = { id: 'id', name: 'name', lvl: 'level', job: 'job', mgr: 'manager_id', stat: 'status', goals: 'goals', div: 'division', dept: 'department', pass: 'password', role: 'access_role', phone: 'phone_number', email: 'Email' };
        let adminCache = [];
        let allCompanyData = [];
        let globalReports = [];

        // --- 4. INITIALIZATION ---
        window.onload = async function () {
            // Fetch Shared Goals from Backend
            const sgResponse = await callBackend('getSettings', { id: SHARED_GOALS_ID });
            // Since proxyRequest returns raw curl output, Supabase returns array
            const sg = Array.isArray(sgResponse) ? sgResponse[0] : sgResponse;
            
            if (sg && sg.data) {
                masterData = Array.isArray(sg.data) ? { rating: 0, goals: sg.data } : sg.data;
            } else { 
                masterData = { rating: 0, goals: [] }; 
            }

            const uid = localStorage.getItem('zpms_uid');
            if (uid && (Date.now() - localStorage.getItem('zpms_time') < IDLE_LIMIT)) restoreSession(uid);
            else showLogin();
        }

        async function restoreSession(id) {
            const data = await callBackend('checkID', { id: id });
            const res = Array.isArray(data) ? data[0] : data;
            
            if (res && !res.error) { 
                user = res; 
                startIdleTimer(); 
                launchApp(); 
            } else { 
                showLogin(); 
            }
        }

        function showLogin() { 
            document.getElementById('loading-overlay').classList.add('hidden'); 
            document.getElementById('login-screen').classList.remove('hidden'); 
        }
        
        function startIdleTimer() { 
            ['click', 'keydown'].forEach(e => window.addEventListener(e, () => localStorage.setItem('zpms_time', Date.now()))); 
        }
        
        function logout() { 
            localStorage.clear(); 
            location.reload(); 
        }

        // --- 5. AUTH & ROUTING ---
        async function checkID() {
            const id = document.getElementById('inp-id').value.trim();
            const btn = document.getElementById('btn-check');
            if (!id) return;
            
            btn.innerText = "Checking...";
            document.getElementById('err-id').style.display = 'none';

            // Secure Call to Railway
            const data = await callBackend('checkID', { id: id });
            const res = Array.isArray(data) ? data[0] : data;

            if (!res || res.error) { 
                btn.innerText = "Continue"; 
                document.getElementById('err-id').innerText = "ID not found or Access Denied"; 
                document.getElementById('err-id').style.display = 'block'; 
                return; 
            }

            user = res;
            document.getElementById('view-id').classList.add('hidden');
            document.getElementById('view-pass').classList.remove('hidden');

            if (!(user[COL.pass] || user['password'])) {
                isRegistering = true;
                document.getElementById('lbl-welcome').innerText = "Set Password";
                document.getElementById('grp-confirm').classList.remove('hidden');
                document.getElementById('btn-login').innerText = "Create & Login";
            }
        }

        async function doLogin() {
            const p1 = document.getElementById('inp-pass').value;
            const storedPass = (user[COL.pass] || user['password'] || "").toString().trim();

            if (isRegistering) {
                if (p1 !== document.getElementById('inp-confirm').value) { alert("Passwords match error"); return; }
                
                // Secure Update via Backend
                const res = await callBackend('saveUser', {
                    id: user[COL.id],
                    payload: { password: p1 }
                });

                if (res.error) { alert("Save error: " + res.error); return; }
            } else {
                if (p1 !== storedPass) { alert("Incorrect Password"); return; }
            }

            localStorage.setItem('zpms_uid', user[COL.id]);
            localStorage.setItem('zpms_time', Date.now());
            document.getElementById('loading-overlay').classList.remove('hidden');
            location.reload();
        }

        // --- 6. DATA FETCHING ---
        async function fetchAllData() {
            let allRows = [];
            let from = 0;
            while (true) {
                // Secure Batch Fetch
                const data = await callBackend('fetchAll', { from: from });
                
                if (!data || data.error || data.length === 0) break;
                allRows = allRows.concat(data);
                if (data.length < 1000) break;
                from += 1000;
            }
            return allRows;
        }

        function getCompany(id) {
            if (!id) return "Unknown";
            const clean = id.toString().toUpperCase().trim();
            if (clean.startsWith("HISP") || clean.startsWith("HCS") || clean.startsWith("HSC") || clean.startsWith("AWO")) return "Horizon";
            if (clean.startsWith("NG") || clean.startsWith("NGM") || clean.startsWith("NGT")) return "Next Generation";
            if (clean.startsWith("ZIQ") || clean.startsWith("ZIQT")) return "Zain Iraq";
            return "Other";
        }

        async function launchApp() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').style.display = 'flex';
            document.getElementById('disp-user').innerText = user[COL.name];
            document.getElementById('disp-role').innerText = user[COL.lvl];

            if (allCompanyData.length === 0) {
                document.getElementById('save-text').innerText = "Syncing directory...";
                document.getElementById('save-status').classList.add('show');
                allCompanyData = await fetchAllData();
                document.getElementById('save-status').classList.remove('show');
            }

            let hasReports = false;
            const myId = user[COL.id].toString().toLowerCase();
            const myName = (user[COL.name] || "").toString().toLowerCase();

            hasReports = allCompanyData.some(u => {
                const m = (u[COL.mgr] || "").toString().toLowerCase();
                return m.includes(myId) || (myName.length > 3 && m.includes(myName));
            });

            const role = getRole(user, hasReports);
            renderNav(role);

            if (role === 'Admin' || role === 'Master') loadHRAdmin();
            else if (role === 'Chief' || role === 'Director' || role === 'Senior Manager') loadReports();
            else if (role === 'Manager') loadTeam();
            else loadEval(user[COL.id]);
        }

        // --- 7. FILE PROCESSING ---
        function triggerImport() { document.getElementById('file-import').click(); }

        function processFile(inp) {
            const file = inp.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
                    if (json.length === 0) { alert("Empty Excel file"); return; }
                    
                    const getVal = (row, candidates) => {
                        const keys = Object.keys(row);
                        const clean = (s) => s.toString().toLowerCase().trim().replace(/[^a-z0-9]/g, '');
                        for (let c of candidates) { const found = keys.find(k => clean(k) === clean(c)); if (found && row[found] !== undefined) return row[found]; }
                        return "";
                    };

                    const newGoals = json.map(r => {
                        let w = getVal(r, ['Weight', 'Wt', 'W%']); w = parseFloat(w) || 0; if (w > 1) w = w / 100;
                        return {
                            title: getVal(r, ['Objective', 'Title', 'Item', 'Items', 'Goal', 'KPI']) || "Imported Goal",
                            weight: w,
                            desc: getVal(r, ['Description', 'Desc', 'Details']),
                            unit: getVal(r, ['Unit', 'UoM']),
                            rating: 0,
                            targets: [getVal(r, ['L1', '1']), getVal(r, ['L2', '2']), getVal(r, ['L3', '3']), getVal(r, ['Target', 'L4', 'Runner']), getVal(r, ['L5', '5']), getVal(r, ['L6', '6'])]
                        };
                    });

                    if (confirm(`Found ${newGoals.length} goals. This will REPLACE your current Individual Goals. Continue?`)) {
                        targetUser[COL.goals] = newGoals;
                        renderGoals(true);
                        calc();
                        autoSave();
                        alert("Goals imported successfully!");
                    }
                    inp.value = '';
                } catch (err) { console.error(err); alert("Error reading Excel file. Check format."); }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 8. ADMIN FUNCTIONS ---
        async function loadHRAdmin() {
            document.getElementById('main-view').innerHTML = `
            <div class="animate-in">
                <div class="header-bar">
                    <div>
                        <h2 class="page-title">HR Portal</h2>
                        <p class="page-sub">Master Administration & Analytics</p>
                    </div>
                </div>
                <div class="card" style="padding: 10px; display: flex; gap: 10px; overflow-x: auto; margin-bottom: 32px; border-radius: 12px; background: white;">
                    <div class="admin-tab active" id="tab-shared" onclick="switchAdminTab('shared')"><i class="fa-solid fa-bullseye"></i> &nbsp; Shared Goals</div>
                    <div class="admin-tab" id="tab-directory" onclick="switchAdminTab('directory')"><i class="fa-solid fa-address-book"></i> &nbsp; Directory</div>
                    <div class="admin-tab" id="tab-search" onclick="switchAdminTab('search')"><i class="fa-solid fa-magnifying-glass"></i> &nbsp; Search</div>
                </div>
                <div id="admin-content" class="animate-in"></div>
            </div>`;
            switchAdminTab('shared');
        }

        function switchAdminTab(t) {
            document.querySelectorAll('.admin-tab').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            if (t === 'shared') loadAdminSharedGoals();
            else if (t === 'directory') loadAdminDirectory();
            else if (t === 'search') loadAdminSearch();
        }

        async function loadAdminDirectory() {
            if (allCompanyData.length === 0) allCompanyData = await fetchAllData();
            const content = `
            <div class="animate-in">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <h3>Employee Directory</h3>
                        <div style="display:flex; gap:12px;">
                            <button class="btn btn-outline" onclick="document.getElementById('file-users').click()"><i class="fa-solid fa-file-csv"></i> &nbsp; Bulk Import</button>
                            <button class="btn btn-primary" onclick="openUserModal()"><i class="fa-solid fa-plus"></i> &nbsp; Add Employee</button>
                        </div>
                    </div>
                    <div style="margin-bottom:20px;">
                         <input class="login-input" placeholder="Search by Name, ID..." onkeyup="searchDirectory(this.value)">
                    </div>
                    <div style="max-height:600px; overflow-y:auto;">
                        <table class="report-table" id="dir-table">
                            <thead><tr><th>ID</th><th>Name</th><th>Job</th><th>Manager</th><th style="text-align:right">Actions</th></tr></thead>
                            <tbody id="dir-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            document.getElementById('admin-content').innerHTML = content;
            renderDirectoryTable(allCompanyData.slice(0, 50));
        }

        function searchDirectory(q) {
            q = q.toLowerCase();
            const filtered = allCompanyData.filter(u =>
                (u[COL.id] || "").toLowerCase().includes(q) || (u[COL.name] || "").toLowerCase().includes(q)
            ).slice(0, 50);
            renderDirectoryTable(filtered);
        }

        function renderDirectoryTable(list) {
            document.getElementById('dir-tbody').innerHTML = list.map(u => `
            <tr>
                <td>${u[COL.id]}</td>
                <td>${u[COL.name]}</td>
                <td>${u[COL.job] || '-'}</td>
                <td>${u[COL.mgr] || '-'}</td>
                <td style="text-align:right;">
                    <button class="btn btn-outline" onclick="openUserModal('${u[COL.id]}')"><i class="fa-solid fa-pen"></i></button>
                    <button class="btn btn-outline" onclick="deleteUser('${u[COL.id]}')"><i class="fa-solid fa-trash"></i></button>
                </td>
            </tr>`).join('');
        }

        async function saveUser() {
            const isEdit = !!document.getElementById('um-orig-id').value;
            const uId = document.getElementById('um-id').value.trim();
            const uName = document.getElementById('um-name').value.trim();
            if (!uId || !uName) { alert("ID and Name required"); return; }
            
            const payload = {
                [COL.id]: uId,
                [COL.name]: uName,
                [COL.job]: document.getElementById('um-job').value.trim(),
                [COL.div]: document.getElementById('um-div').value.trim(),
                [COL.mgr]: document.getElementById('um-mgr').value.trim(),
                [COL.role]: document.getElementById('um-role').value.trim(),
                [COL.email]: document.getElementById('um-email').value.trim(),
                [COL.phone]: document.getElementById('um-phone').value.trim()
            };

            // Secure Save via Backend
            const res = await callBackend('saveUser', { id: uId, payload: payload });
            
            if (res.error) alert("Error: " + res.error);
            else {
                alert("Saved!");
                closeUserModal();
                allCompanyData = await fetchAllData();
                loadAdminDirectory();
            }
        }

        async function deleteUser(id) {
            if(confirm("Delete this user?")) {
                const res = await callBackend('deleteUser', { id: id });
                if(!res.error) {
                    allCompanyData = allCompanyData.filter(u => u[COL.id] !== id);
                    loadAdminDirectory();
                } else {
                    alert("Error deleting user");
                }
            }
        }

        function openUserModal(empId = null) {
            const modal = document.getElementById('user-modal');
            const origIdField = document.getElementById('um-orig-id');
            const idField = document.getElementById('um-id');
            // Reset fields
            document.querySelectorAll('#user-modal input').forEach(i => i.value = '');
            
            if (empId) {
                const u = allCompanyData.find(x => x[COL.id].toString() === empId.toString());
                if(u) {
                    origIdField.value = u[COL.id];
                    idField.value = u[COL.id];
                    document.getElementById('um-name').value = u[COL.name];
                    document.getElementById('um-job').value = u[COL.job] || '';
                    document.getElementById('um-div').value = u[COL.div] || '';
                    document.getElementById('um-mgr').value = u[COL.mgr] || '';
                    document.getElementById('um-role').value = u[COL.role] || '';
                }
                document.getElementById('um-title').innerText = "Edit Employee";
            } else {
                document.getElementById('um-title').innerText = "Add New Employee";
            }
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('open'), 10);
        }

        function closeUserModal() {
            const modal = document.getElementById('user-modal');
            modal.classList.remove('open');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function loadAdminSharedGoals() {
            // Fetch directly from backend
            const sgResponse = await callBackend('getSettings', { id: SHARED_GOALS_ID });
            const sg = Array.isArray(sgResponse) ? sgResponse[0] : sgResponse;
            if (sg && sg.data) masterData = Array.isArray(sg.data) ? { rating: 0, goals: sg.data } : sg.data;

            const h = `
            <div class="animate-in">
                <div class="card" style="border-left: 6px solid var(--primary);">
                    <h3 style="margin-bottom:24px;">Company Performance</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h4>Shared Objectives</h4>
                        <button class="btn btn-primary" onclick="saveMasterGoals()"><i class="fa-regular fa-floppy-disk"></i> &nbsp; Publish Changes</button>
                    </div>
                    <div id="master-goals-list" style="display:grid; gap:20px;"></div>
                    <button class="btn btn-outline" style="margin-top:24px; width:100%; justify-content:center; border-style:dashed;" onclick="addMasterGoal()">
                        <i class="fa-solid fa-plus"></i> &nbsp; Create New Shared Objective
                    </button>
                </div>
            </div>`;
            document.getElementById('admin-content').innerHTML = h;
            renderMasterGoals();
        }

        function renderMasterGoals() {
            const c = document.getElementById('master-goals-list');
            const allDivs = [...new Set(allCompanyData.map(u => u[COL.div]).filter(Boolean))].sort();
            
            c.innerHTML = (masterData.goals || []).map((g, i) => `
            <div class="card" style="border-left: 5px solid var(--primary); background: #fff;">
                <div style="display:grid; grid-template-columns: 2fr 1fr; gap:15px; margin-bottom:15px;">
                    <input class="login-input" value="${g.title}" onchange="masterData.goals[${i}].title=this.value; renderMasterGoals();" placeholder="Goal Title">
                    <select class="login-input" onchange="updateGoalAssignment(${i}, this.value)" style="margin:0;">
                        <option value="">+ Assign Division</option>
                        ${allDivs.map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                </div>
                <div style="background:#f8fafc; padding:12px; border-radius:10px; margin-bottom:15px;">
                    <div style="font-size:0.7rem; font-weight:800; color:var(--text-muted); margin-bottom:8px;">ASSIGNMENTS & WEIGHTS</div>
                    ${(g.assignments || []).map((assign, ai) => `
                        <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px; background:white; padding:8px; border-radius:8px; border:1px solid var(--border);">
                            <span style="flex:1; font-weight:600; font-size:0.85rem;">${assign.target}</span>
                            <div style="display:flex; align-items:center; gap:5px;">
                                <input type="number" value="${(assign.weight * 100) || 0}" 
                                    style="width:50px; border:1px solid var(--primary); border-radius:4px; text-align:center; font-weight:700;"
                                    onchange="masterData.goals[${i}].assignments[${ai}].weight=(this.value/100);">
                                <span style="font-size:0.75rem;">%</span>
                            </div>
                            <button class="btn-delete" onclick="removeAssignment(${i}, ${ai})" style="color:var(--danger);"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                    `).join('')}
                </div>
                <div style="display:flex; justify-content:space-between; align-items:center; padding-top:10px; border-top:1px solid #eee;">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <span style="font-size:0.75rem; font-weight:700; color:var(--text-muted);">ACHIEVEMENT:</span>
                        <select onchange="masterData.goals[${i}].rating=parseInt(this.value);" style="padding:6px 12px; border-radius:8px; border:2px solid var(--primary); font-weight:700; background:white;">
                            <option value="0">Not Rated</option>
                            <option value="1" ${g.rating == 1 ? 'selected' : ''}>1 - IDLE</option>
                            <option value="2" ${g.rating == 2 ? 'selected' : ''}>2 - STAGNANT</option>
                            <option value="3" ${g.rating == 3 ? 'selected' : ''}>3 - WALKER</option>
                            <option value="4" ${g.rating == 4 ? 'selected' : ''}>4 - RUNNER</option>
                            <option value="5" ${g.rating == 5 ? 'selected' : ''}>5 - FLYER</option>
                            <option value="6" ${g.rating == 6 ? 'selected' : ''}>6 - ASTRONAUT</option>
                        </select>
                    </div>
                     <button class="btn btn-outline" style="color:var(--danger); padding:4px 10px;" onclick="masterData.goals.splice(${i},1); renderMasterGoals();"><i class="fa-solid fa-trash"></i></button>
                </div>
            </div>`).join('');
        }

        function updateGoalAssignment(gi, val) {
            if(!val) return;
            if(!masterData.goals[gi].assignments) masterData.goals[gi].assignments = [];
            if(!masterData.goals[gi].assignments.find(a => a.target === val)) {
                masterData.goals[gi].assignments.push({ target: val, weight: 0 });
                renderMasterGoals();
            }
        }
        function removeAssignment(gi, ai) {
             masterData.goals[gi].assignments.splice(ai, 1);
             renderMasterGoals();
        }
        function addMasterGoal() {
            if (!masterData.goals) masterData.goals = [];
            masterData.goals.push({ title: "New Shared Goal", weight: 0, targets: ["", "", "", "", "", ""], assignments: [] });
            renderMasterGoals();
        }

        async function saveMasterGoals() {
            if(confirm("Publish Shared Goals?")) {
                showSaving();
                const res = await callBackend('saveSettings', { id: SHARED_GOALS_ID, data: masterData });
                if(res.error) alert("Error: " + res.error);
                else { showSaved(); alert("Published!"); }
            }
        }
        
        async function loadAdminSearch() {
             document.getElementById('admin-content').innerHTML = `
            <div class="animate-in">
                <div class="card" style="max-width:600px; margin:0 auto; padding:32px;">
                    <h3 style="text-align:center; margin-bottom:24px;">Global Search</h3>
                    <div style="display:flex; gap:12px; margin-bottom:32px;">
                        <input id="search-q" class="login-input" style="margin:0;" placeholder="Enter Name or ID..." onkeypress="if(event.key==='Enter') doGlobalSearch()">
                        <button class="btn btn-primary" onclick="doGlobalSearch()">Search</button>
                    </div>
                    <div id="search-results"></div>
                </div>
            </div>`;
        }

        function doGlobalSearch() {
            const q = document.getElementById('search-q').value.trim().toLowerCase();
            const results = allCompanyData.filter(r => (r[COL.id] && r[COL.id].toLowerCase().includes(q)) || (r[COL.name] && r[COL.name].toLowerCase().includes(q))).slice(0, 10);
            document.getElementById('search-results').innerHTML = results.map(r => `<div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;"><div><strong>${r[COL.name]}</strong><br><small>${r[COL.id]}</small></div><button class="btn btn-outline" onclick="loadEval('${r[COL.id]}', true)">View</button></div>`).join('');
        }

        // --- 9. MANAGER/USER FUNCTIONS ---
        async function loadTeam() {
            const myId = user[COL.id];
            const myName = user[COL.name];
            const data = allCompanyData.filter(u => {
                 const m = (u[COL.mgr] || "").toString().toLowerCase();
                 return m.includes(myId.toLowerCase()) || (myName.length > 3 && m.includes(myName.toLowerCase()));
            });
            
            let h = `<div class="animate-in"><div class="header-bar"><div><h2 class="page-title">My Team</h2></div></div><div class="team-grid">`;
            if (data.length > 0) {
                data.forEach(e => {
                    const comp = getCompany(e[COL.id]);
                    h += `<div class="premium-team-card" onclick="loadEval('${e[COL.id]}')">
                        <div class="pt-status status-badge ${e[COL.stat] === 'Approved' ? 'approved' : 'submitted'}">${e[COL.stat] || 'Draft'}</div>
                        <div class="pt-avatar">${e[COL.name].charAt(0)}</div>
                        <div class="pt-info"><div class="pt-name">${e[COL.name]}</div><div class="pt-role">${e[COL.job] || 'Staff'}</div><div style="font-size:0.75rem; color:var(--primary); font-weight:700; margin-top:4px;">${comp}</div></div>
                        <div style="border-top:1px solid var(--border); padding-top:16px; display:flex; justify-content:center;"><button class="btn btn-outline" style="width:100%;">View Scorecard</button></div>
                    </div>`;
                });
            } else { h += `<div>No direct reports found.</div>`; }
            h += `</div></div>`;
            document.getElementById('main-view').innerHTML = h;
        }

        async function loadEval(tid, isSearchMode = false) {
            // Re-fetch fresh user data
            const data = await callBackend('checkID', { id: tid });
            const freshUser = Array.isArray(data) ? data[0] : data;

            if (!freshUser || freshUser.error) { alert("Error loading user"); return; }
            targetUser = freshUser;

            const uRole = getRole(user);
            const myId = (user[COL.id] || '').toString();
            const targetId = (targetUser[COL.id] || '').toString();
            const viewingSelf = (myId === targetId);
            const mgrStr = (targetUser[COL.mgr] || "").toString().toLowerCase();
            isDirectSupervisor = (mgrStr.includes(myId.toLowerCase()));
            isManager = !viewingSelf && (isDirectSupervisor || ['Admin', 'Master'].includes(uRole));
            
            const w = getW(targetUser[COL.lvl], targetUser[COL.job]);
            let userGoals = targetUser[COL.goals];
            if (typeof userGoals === 'string') { try { userGoals = JSON.parse(userGoals); } catch (e) { userGoals = []; } }
            if (!Array.isArray(userGoals) || userGoals.length === 0) userGoals = JSON.parse(JSON.stringify(defaultIndivGoals));
            targetUser[COL.goals] = userGoals;

            const stat = targetUser[COL.stat] || 'Draft';
            let canEdit = false;
            if (viewingSelf) canEdit = (stat === 'Draft' || stat === 'Returned');
            else if (isDirectSupervisor) canEdit = (stat === 'Submitted to Manager');
            if (isSearchMode) canEdit = false;

            let h = `
            <div class="animate-in">
                <div class="header-bar">
                    <div>
                        <h2 class="page-title">${isManager ? 'Evaluation' : 'My Scorecard'}</h2>
                        <p class="page-sub">${targetUser[COL.name]} • <span class="status-badge ${stat === 'Approved' ? 'approved' : 'submitted'}">${stat}</span></p>
                    </div>
                    ${isManager ? `<button onclick="loadTeam()" class="btn btn-outline">Back</button>` : ''}
                </div>
                
                <div class="metrics-row">
                     <div class="metric-card highlight"><div class="metric-val" id="score">--</div><div class="metric-lbl">Score</div></div>
                     <div class="metric-card"><div class="metric-val" id="rating">--</div><div class="metric-lbl">Rating</div></div>
                     <div class="metric-card"><div class="metric-val">${w.s}%</div><div class="metric-lbl">Shared</div></div>
                     <div class="metric-card"><div class="metric-val">${w.i}%</div><div class="metric-lbl">Individual</div></div>
                </div>

                ${w.s > 0 ? `<div class="card"><h3>Shared Goals</h3><div class="shared-grid" id="shared-goals-container"></div></div>` : ''}
                
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <h3>Individual Goals</h3>
                        ${canEdit ? `<button class="btn btn-primary" onclick="openGoalModal()">Add Goal</button>` : ''}
                    </div>
                    <div id="goal-list"></div>
                </div>

                <div style="display:flex; justify-content:flex-end; gap:16px; margin-top:40px;">
                     ${canEdit ? `<button class="btn btn-outline" onclick="autoSave()">Save Draft</button><button class="btn btn-primary" onclick="submitFinal()">Submit</button>` : ''}
                </div>
            </div>`;
            document.getElementById('main-view').innerHTML = h;
            
            renderGoals(canEdit);
            renderSharedGoals(w.s); // Helper to render shared goals
            calc();
        }
        
        function renderSharedGoals(weight) {
             const userDiv = (targetUser[COL.div] || "").trim();
             const userId = (targetUser[COL.id] || "").trim();
             const relevant = (masterData.goals || []).map(g => {
                 const assign = (g.assignments || []).find(a => a.target === userDiv || a.target === userId);
                 return assign ? { ...g, myWeight: assign.weight } : null;
             }).filter(Boolean);
             
             document.getElementById('shared-goals-container').innerHTML = relevant.map(g => `
                 <div class="shared-card">
                     <div class="shared-header" style="display:flex; justify-content:space-between;">
                         <span>${g.title}</span><span class="pro-unit-badge">Weight: ${(g.myWeight*100).toFixed(1)}%</span>
                     </div>
                     <div class="segment-bar">
                         ${[1,2,3,4,5,6].map(n => `<div class="segment ${n===4?'is-target':''} ${n===g.rating?'active':''}"><div class="seg-num">${n}</div><div class="seg-val">${g.targets[n-1]||'-'}</div></div>`).join('')}
                     </div>
                 </div>
             `).join('');
        }

        function renderGoals(edit) {
            document.getElementById('goal-list').innerHTML = targetUser[COL.goals].map((g, i) => `
            <div class="pro-goal-card">
                <div class="pro-goal-header">
                    <div style="font-size:1.1rem; font-weight:700;">${g.title}</div>
                    <div class="pro-goal-meta">
                        <div class="pro-weight-badge">Weight: ${(g.weight*100).toFixed(0)}%</div>
                        ${edit ? `<button class="btn btn-outline" onclick="openGoalModal(${i})"><i class="fa-solid fa-pen"></i></button>` : ''}
                    </div>
                </div>
                <div class="pro-goal-desc">${g.desc || 'No description.'}</div>
                <div class="pro-targets-container">
                    ${['IDLE','STAGNANT','WALKER','RUNNER','FLYER','ASTRONAUT'].map((h, ti) => `<div class="pro-target-item ${ti===3?'is-target':''}"><div class="pro-target-header">${h}</div><div style="padding:10px; text-align:center;">${g.targets[ti]||'-'}</div></div>`).join('')}
                </div>
                <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:700; color:var(--text-muted);">ACHIEVEMENT:</span>
                    ${edit && isDirectSupervisor ? `<select class="rating-select" onchange="updG(${i},'rating',this.value);"><option value="0">Select...</option>${[1,2,3,4,5,6].map(n=>`<option value="${n}" ${g.rating==n?'selected':''}>${n}</option>`).join('')}</select>` : `<span class="badge-rating lvl-${g.rating}">${g.rating} - ${ratingLabels[g.rating]}</span>`}
                </div>
            </div>`).join('');
        }

        function updG(i, f, v) { 
            if(f==='rating') v=parseInt(v); 
            targetUser[COL.goals][i][f]=v; 
            calc(); 
            autoSave(); 
        }

        function calc() {
            if (!targetUser) return;
            const w = getW(targetUser[COL.lvl], targetUser[COL.job]);
            const userDiv = (targetUser[COL.div] || "").trim();
            const userId = (targetUser[COL.id] || "").trim();
            
            let sharedScore = 0;
            (masterData.goals || []).forEach(g => {
                const assign = (g.assignments || []).find(a => a.target === userDiv || a.target === userId);
                if (assign) sharedScore += (Number(g.rating) || 0) * (Number(assign.weight) || 0);
            });

            let indivScore = 0;
            (targetUser[COL.goals] || []).forEach(g => indivScore += (Number(g.rating) || 0) * (Number(g.weight) || 0));

            const total = (sharedScore * (w.s / 100)) + (indivScore * (w.i / 100));
            
            // Logic to hide score if not finalized
            const canSee = (targetUser[COL.stat] === 'Approved') || isManager;
            if(canSee) {
                 if(document.getElementById('score')) document.getElementById('score').innerText = total.toFixed(2);
                 let lbl = "-";
                 if(total>=5.5) lbl="ASTRONAUT"; else if(total>=4.5) lbl="FLYER"; else if(total>=3.5) lbl="RUNNER"; else if(total>=2.5) lbl="WALKER"; else if(total>=1.5) lbl="STAGNANT"; else if(total>0) lbl="IDLE";
                 if(document.getElementById('rating')) document.getElementById('rating').innerText = lbl;
            } else {
                 if(document.getElementById('score')) document.getElementById('score').innerHTML = '<i class="fa-solid fa-lock" style="opacity:0.3;"></i>';
            }
        }

        async function submitFinal() {
            if(confirm("Submit Final Evaluation?")) {
                const newStat = isDirectSupervisor ? "Approved" : "Submitted to Manager";
                const res = await callBackend('saveUser', {
                    id: targetUser[COL.id],
                    payload: { [COL.stat]: newStat }
                });
                if(!res.error) location.reload();
            }
        }
        
        async function autoSave() {
             showSaving();
             const res = await callBackend('saveUser', {
                 id: targetUser[COL.id],
                 payload: { [COL.goals]: targetUser[COL.goals] }
             });
             if(!res.error) showSaved();
        }

        function showSaving() { document.getElementById('save-status').classList.add('show'); document.getElementById('save-dot').className = 'save-dot saving'; document.getElementById('save-text').innerText = "Saving..."; }
        function showSaved() { document.getElementById('save-dot').className = 'save-dot saved'; document.getElementById('save-text').innerText = "All changes saved"; setTimeout(() => document.getElementById('save-status').classList.remove('show'), 2000); }
        function showConfirm(t,m,b,type,cb) { if(confirm(m)) cb(); } // Simplified for brevity in this consolidated script
        function showToast(m,t) { alert(m); } // Simplified

        function getRole(u, hasReports) {
            if (!u) return 'Staff';
            const job = (u[COL.job] || "").toString().trim().toUpperCase();
            if (job === MASTER_ADMIN_TITLE.toUpperCase()) return 'Master';
            if (hasReports) return 'Manager';
            const l = (u[COL.lvl] || "").toUpperCase();
            if (l.includes('L1')) return 'Chief';
            if (l.includes('L2')) return 'Director';
            if (l.includes('L3')) return 'Senior Manager';
            if (l.includes('L4')) return 'Manager';
            return 'Staff';
        }

        function getW(l, j) {
            const job = (j || "").toLowerCase().trim();
            const levelStr = (l || "").toUpperCase();
            if (job.includes('ceo')) return { s: 100, i: 0 };
            if (job.includes('chief')) return { s: 20, i: 80 };
            return { s: 5, i: 95 };
        }

        // --- 10. GOAL MODAL LOGIC (Kept same as original) ---
        let editingGoalIndex = null;
        function openGoalModal(index = null) {
            editingGoalIndex = index;
            const modal = document.getElementById('goal-modal');
            document.querySelectorAll('.gm-target-inp').forEach(i => i.value = '');
            if(index !== null) {
                const g = targetUser[COL.goals][index];
                document.getElementById('gm-title-inp').value = g.title;
                document.getElementById('gm-unit').value = g.unit||'';
                document.getElementById('gm-weight').value = g.weight*100;
                document.getElementById('gm-desc').value = g.desc||'';
                const inps = document.querySelectorAll('.gm-target-inp');
                (g.targets||[]).forEach((t,i) => { if(inps[i]) inps[i].value=t; });
            }
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('open'), 10);
        }
        function closeGoalModal() {
            const modal = document.getElementById('goal-modal');
            modal.classList.remove('open');
            setTimeout(() => modal.style.display = 'none', 300);
        }
        function saveGoal() {
            const title = document.getElementById('gm-title-inp').value;
            const weight = parseFloat(document.getElementById('gm-weight').value)/100;
            const targets = [];
            document.querySelectorAll('.gm-target-inp').forEach(i => targets.push(i.value));
            
            const newGoal = { title, weight, unit: document.getElementById('gm-unit').value, desc: document.getElementById('gm-desc').value, rating: 0, targets };
            
            if(editingGoalIndex !== null) {
                newGoal.rating = targetUser[COL.goals][editingGoalIndex].rating;
                targetUser[COL.goals][editingGoalIndex] = newGoal;
            } else {
                targetUser[COL.goals].push(newGoal);
            }
            closeGoalModal();
            renderGoals(true);
            autoSave();
        }
        
        function renderNav(r) {
             let h = `<div style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; padding:16px 12px 8px 12px; margin-top:8px;">Menu</div>`;
             if (['Admin','Master'].includes(r)) h += `<div class="nav-item" onclick="loadHRAdmin()"><i class="fa-solid fa-user-shield"></i> <span>HR Admin</span></div>`;
             if (['Chief','Director','Manager','Admin'].includes(r)) h += `<div class="nav-item" onclick="loadTeam()"><i class="fa-solid fa-users"></i> <span>My Team</span></div>`;
             h += `<div class="nav-item" onclick="loadEval('${user[COL.id]}')"><i class="fa-solid fa-address-card"></i> <span>My Scorecard</span></div>`;
             document.getElementById('nav-menu').innerHTML = h;
        }
    </script>
</body>
</html>
