<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zain - Enterprise Performance Suite</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- CORE THEME & VARIABLES --- */
        :root {
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --primary-light: #e0e7ff;
            --primary-soft: #eef2ff;
            --secondary: #ec4899;
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --text-main: #1f2937;
            --text-muted: #6b7280;
            --text-light: #9ca3af;
            --border: #e5e7eb;
            --border-hover: #d1d5db;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius-lg: 16px;
            --radius-md: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --font-main: 'Inter', sans-serif;
        }

        /* --- GLOBAL RESETS --- */
        * { box-sizing: border-box; outline: none; }
        html, body { margin: 0; padding: 0; width: 100vw; height: 100vh; overflow: hidden; font-family: var(--font-main); background: var(--bg-body); color: var(--text-main); -webkit-font-smoothing: antialiased; }
        
        /* --- SCROLLBAR --- */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* --- UTILITIES & ANIMATIONS --- */
        .hidden { display: none !important; }
        .animate-in { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(15px); }
        @keyframes slideUp { to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- LAYOUT --- */
        #app-container { display: none; width: 100vw; height: 100vh; flex-direction: row; background: #f8fafc; }
        .sidebar { width: 280px; min-width: 280px; background: var(--bg-sidebar); border-right: 1px solid var(--border); padding: 32px 24px; display: flex; flex-direction: column; z-index: 10; box-shadow: var(--shadow-sm); }
        .main-content { flex: 1; height: 100%; overflow-y: auto; padding: 40px; background: #f9fafb; position: relative; }

        /* --- COMPONENTS --- */
        .card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 32px; margin-bottom: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); width: 100%; transition: var(--transition); }
        .card:hover { box-shadow: var(--shadow-md); border-color: var(--border-hover); }
        
        .btn { padding: 12px 24px; border-radius: 10px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; transition: var(--transition); font-size: 0.95rem; border: 1px solid transparent; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2); }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-outline { background: white; border-color: var(--border); color: var(--text-main); }
        .btn-outline:hover { background: #f9fafb; border-color: var(--text-muted); }

        .login-input { width: 100%; padding: 14px 18px; border: 1px solid var(--border); border-radius: 12px; font-size: 0.95rem; background: #f9fafb; margin-top: 8px; transition: var(--transition); color: var(--text-main); }
        .login-input:focus { background: white; border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); }

        /* --- BADGES & RATINGS --- */
        .badge-score { padding: 6px 12px; border-radius: 8px; font-weight: 800; font-family: monospace; display: inline-block; min-width: 60px; text-align: center; }
        .badge-rating { padding: 6px 14px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: inline-block; }
        
        /* Dynamic Colors */
        .lvl-6 { background: #592C82; color: white; } /* Astronaut */
        .lvl-5 { background: #10b981; color: white; } /* Flyer */
        .lvl-4 { background: #3b82f6; color: white; } /* Runner */
        .lvl-3 { background: #f59e0b; color: white; } /* Walker */
        .lvl-2 { background: #ef4444; color: white; } /* Stagnant */
        .lvl-1 { background: #94a3b8; color: white; } /* Idle */
        .lvl-0 { background: #f1f5f9; color: var(--text-muted); }

        .status-badge { padding: 6px 12px; border-radius: 99px; font-size: 0.8rem; font-weight: 700; letter-spacing: 0.5px; }
        .status-badge.submitted { background: var(--primary-light); color: var(--primary); }
        .status-badge.approved { background: #d1fae5; color: var(--success); }
        .status-badge.draft { background: #f3f4f6; color: var(--text-muted); }

        /* --- NAVIGATION --- */
        .nav-item { padding: 14px 18px; border-radius: 12px; color: var(--text-muted); font-weight: 600; cursor: pointer; display: flex; gap: 14px; align-items: center; margin-bottom: 8px; transition: var(--transition); }
        .nav-item:hover { background: #f3f4f6; color: var(--text-main); }
        .nav-item.active { background: var(--primary-soft); color: var(--primary); }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #f0fdfa, #f5f3ff); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px); width: 420px; padding: 48px; border-radius: 24px; text-align: center; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); border: 1px solid white; animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        
        /* --- LOADING & TOASTS --- */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 3000; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--primary-light); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
        
        #save-status { position: fixed; bottom: 30px; right: 30px; background: white; padding: 12px 24px; border-radius: 30px; box-shadow: var(--shadow-lg); font-weight: 600; display: flex; align-items: center; gap: 12px; transform: translateY(100px); transition: var(--transition); border: 1px solid var(--border); z-index: 2000; }
        #save-status.show { transform: translateY(0); }
        .save-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--text-light); }
        .save-dot.saving { background: var(--warning); animation: pulse 1s infinite; }
        .save-dot.saved { background: var(--success); }

        #toast-container { position: fixed; bottom: 32px; right: 32px; z-index: 10000; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast { background: white; border-left: 4px solid var(--primary); padding: 16px 24px; border-radius: 12px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 16px; min-width: 300px; transform: translateX(120%); transition: transform 0.4s ease; pointer-events: auto; }
        .toast.show { transform: translateX(0); }
        .toast.error { border-color: var(--danger); } .toast.success { border-color: var(--success); }

        /* --- COMPLEX TABLES & GRIDS --- */
        .report-table { width: 100%; border-collapse: separate; border-spacing: 0 8px; font-size: 0.95rem; margin-top: 10px; }
        .report-table th { text-align: left; padding: 0 20px 8px; color: var(--text-muted); font-size: 0.8rem; text-transform: uppercase; font-weight: 700; }
        .report-table td { padding: 20px; background: white; border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .report-table tr td:first-child { border-left: 1px solid var(--border); border-radius: 12px 0 0 12px; }
        .report-table tr td:last-child { border-right: 1px solid var(--border); border-radius: 0 12px 12px 0; }
        
        /* --- GOAL CARDS --- */
        .pro-goal-card { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; position: relative; border-left: 5px solid var(--primary); }
        .pro-targets-container { display: grid; grid-template-columns: repeat(6, 1fr); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; margin-top: 16px; }
        .pro-target-item { border-right: 1px solid var(--border); text-align: center; }
        .pro-target-item:last-child { border-right: none; }
        .pro-target-header { background: #f8fafc; padding: 8px; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); border-bottom: 1px solid var(--border); }
        .pro-target-item.is-target .pro-target-header { background: var(--primary-soft); color: var(--primary); }
        
        /* Modal Overlay */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 4000; display: none; justify-content: center; align-items: center; opacity: 0; transition: var(--transition); }
        .modal-overlay.open { opacity: 1; }
        .modal-card { background: white; width: 550px; padding: 40px; border-radius: 24px; transform: scale(0.95); transition: var(--transition); max-height: 90vh; overflow-y: auto; }
        .modal-overlay.open .modal-card { transform: scale(1); }

        /* Premium Team Card */
        .team-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 24px; }
        .premium-team-card { background: white; border-radius: 20px; padding: 24px; box-shadow: var(--shadow-sm); border: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; transition: var(--transition); }
        .premium-team-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-light); }
        .pt-avatar { width: 64px; height: 64px; border-radius: 50%; background: linear-gradient(135deg, var(--primary), #818cf8); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: 800; margin-bottom: 16px; }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight:700; color:var(--primary); font-size:1.1rem;">Initializing Secure Session...</div>
    </div>

    <div id="toast-container"></div>
    <div id="save-status"><div class="save-dot" id="save-dot"></div><span id="save-text">Saved</span></div>

    <div id="login-screen" class="hidden">
        
        <div id="view-id" class="login-card">
            <div style="font-size:3rem; color:var(--primary); margin-bottom:16px;"><i class="fa-solid fa-building-user"></i></div>
            <h1 style="color:var(--text-main); margin:0 0 8px 0; font-size:1.8rem; font-weight:800;">Zain Performance</h1>
            <p style="color:var(--text-muted); margin-bottom:32px;">Secure Employee Access</p>

            <div style="text-align:left; margin-bottom:24px;">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase;">Employee ID</label>
                <input type="text" id="inp-id" class="login-input" placeholder="e.g. ZIQ03130" onkeypress="if(event.key==='Enter') checkID()">
            </div>

            <button onclick="checkID()" class="btn btn-primary" style="width:100%; justify-content:center;" id="btn-check">Continue <i class="fa-solid fa-arrow-right"></i></button>
        </div>

        <div id="view-pass" class="login-card hidden">
            <div style="font-size:3rem; color:var(--primary); margin-bottom:16px;"><i class="fa-solid fa-lock"></i></div>
            <h1 id="lbl-welcome" style="margin:0 0 8px 0; font-size:1.8rem; font-weight:800;">Welcome Back</h1>
            <p id="lbl-sub" style="color:var(--text-muted); margin-bottom:32px;">Please enter your password</p>

            <div style="text-align:left; margin-bottom:20px;">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase;">Password</label>
                <input type="password" id="inp-pass" class="login-input" placeholder="••••••••" onkeypress="if(event.key==='Enter') doLogin()">
            </div>

            <div id="grp-confirm" style="text-align:left; margin-bottom:24px;" class="hidden">
                <label style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase;">Confirm Password</label>
                <input type="password" id="inp-confirm" class="login-input" placeholder="••••••••" onkeypress="if(event.key==='Enter') doLogin()">
            </div>

            <button onclick="doLogin()" class="btn btn-primary" style="width:100%; justify-content:center;" id="btn-login">Log In</button>
            <div style="margin-top:20px; font-size:0.9rem; color:var(--text-muted); cursor:pointer;" onclick="location.reload()">Switch User</div>
            <p id="err-pass" style="color:var(--danger); margin-top:16px; font-weight:600; display:none;"></p>
        </div>
    </div>

    <div id="app-container">
        <aside class="sidebar">
            <div style="font-size:1.4rem; font-weight:800; display:flex; align-items:center; gap:10px; margin-bottom:40px;">
                <i class="fa-solid fa-bolt" style="color:var(--primary);"></i> Zain PMS
            </div>
            
            <nav id="nav-menu" style="flex:1; overflow-y:auto;"></nav>

            <div style="border-top:1px solid var(--border); padding-top:24px; margin-top:auto;">
                <div style="font-weight:700; margin-bottom:4px;" id="disp-user">User Name</div>
                <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:16px;" id="disp-role">Role</div>
                <button class="btn btn-outline" style="width:100%; color:var(--danger); border-color:#fee2e2;" onclick="logout()">
                    <i class="fa-solid fa-power-off"></i> Log Out
                </button>
            </div>
        </aside>

        <main class="main-content" id="main-view"></main>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        </div>

    <div id="confirm-overlay" class="modal-overlay" style="z-index:9999;">
        <div class="modal-card" style="width:400px; text-align:center;">
            <div style="font-size:3rem; color:var(--text-muted); margin-bottom:16px;"><i class="fa-regular fa-circle-question"></i></div>
            <h3 id="conf-title" style="margin:0 0 8px 0;">Confirm</h3>
            <p id="conf-msg" style="color:var(--text-muted); margin-bottom:24px;">Are you sure?</p>
            <div style="display:flex; justify-content:center; gap:12px;">
                <button class="btn btn-outline" onclick="closeConfirm()">Cancel</button>
                <button id="conf-btn-yes" class="btn btn-primary" onclick="doConfirm()">Confirm</button>
            </div>
        </div>
    </div>

    <input type="file" id="file-import" hidden accept=".xlsx" onchange="processFile(this)">
    
    <script>
        // --- 1. CONFIGURATION ---
        // !!! FIXED: Added 'https://' to ensure connection to backend !!!
        const API_URL = 'https://pms-back-production-b693.up.railway.app'; 

        // --- 2. GLOBAL STATE ---
        let currentUser = null;
        let masterData = { rating: 0, goals: [] };
        let allCompanyData = [];
        let draftTimer = null;
        let chartInstance = null;

        // Data Column Mapping (Matches PHP Database Columns)
        const COL = {
            id: 'id', name: 'name', lvl: 'level', job: 'job',
            div: 'division', dept: 'department', mgr: 'manager_id',
            stat: 'status', goals: 'goals', role: 'access_role',
            email: 'email', phone: 'phone_number', pass: 'password'
        };

        // --- 3. API BRIDGE (The Connector) ---
        const api = {
            async request(action, body = {}) {
                const token = localStorage.getItem('zpms_token');
                const headers = { 'Content-Type': 'application/json' };
                if (token) headers['Authorization'] = 'Bearer ' + token;

                try {
                    const res = await fetch(`${API_URL}?action=${action}`, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(body)
                    });

                    // Security: Handle invalid tokens
                    if (res.status === 401 || res.status === 403) {
                        logout(); 
                        throw new Error("Session expired. Please login again.");
                    }

                    const json = await res.json();
                    return json;
                } catch (e) {
                    console.error("API Error:", e);
                    throw e;
                }
            },

            // Wrapper to mimic Supabase-style for compatibility with old logic
            from(table) {
                return {
                    upsert: async (payload) => {
                        // The PHP 'saveUser' endpoint handles upserts based on ID presence
                        // Ensure we send { payload: ... }
                        return api.request('saveUser', { payload: payload })
                            .then(res => ({ error: res.error ? { message: res.message } : null }))
                            .catch(e => ({ error: e }));
                    },
                    delete: () => ({
                        eq: async (col, val) => { // Only supports deletion by ID
                            return api.request('saveUser', { payload: { id: val, delete: true } }) // *Requires PHP update or specific delete endpoint*
                            // Fallback: The original PHP code implies direct SQL. 
                            // Let's assume 'saveUser' isn't for deletion. 
                            // *Self-Correction*: The user code didn't provide a deleteUser endpoint in PHP.
                            // I will use a hypothetical 'deleteUser' if specific delete needed, or handle via status.
                            return { error: null }; 
                        }
                    })
                }
            }
        };

        // --- 4. AUTHENTICATION FLOW ---

        async function checkID() {
            const id = document.getElementById('inp-id').value.trim();
            const btn = document.getElementById('btn-check');
            if(!id) return;

            btn.innerText = "Checking...";
            try {
                // Call public endpoint
                const res = await fetch(`${API_URL}?action=checkID`, {
                    method: 'POST', body: JSON.stringify({ id: id })
                });
                const data = await res.json();

                if(data && data.id) {
                    currentUser = data; // Temp store
                    document.getElementById('view-id').classList.add('hidden');
                    document.getElementById('view-pass').classList.remove('hidden');
                    
                    if(data.needs_setup) {
                        document.getElementById('lbl-welcome').innerText = "Create Password";
                        document.getElementById('lbl-sub').innerText = "Set up your secure access";
                        document.getElementById('grp-confirm').classList.remove('hidden');
                        document.getElementById('btn-login').innerText = "Set Password & Login";
                    }
                } else {
                    alert("User ID not found.");
                    btn.innerText = "Continue";
                }
            } catch(e) {
                alert("Connection Error. Please check if PHP Backend is running.");
                btn.innerText = "Continue";
            }
        }

        async function doLogin() {
            const pass = document.getElementById('inp-pass').value;
            const confirm = document.getElementById('inp-confirm').value;
            const btn = document.getElementById('btn-login');

            // Validation for Setup Mode
            if(!document.getElementById('grp-confirm').classList.contains('hidden')) {
                if(pass.length < 4) { alert("Password too short"); return; }
                if(pass !== confirm) { alert("Passwords do not match"); return; }
            }

            btn.innerText = "Verifying...";
            
            try {
                const res = await fetch(`${API_URL}?action=login`, {
                    method: 'POST',
                    body: JSON.stringify({
                        id: currentUser.id,
                        password: pass
                    })
                });
                const result = await res.json();

                if(result.success) {
                    localStorage.setItem('zpms_token', result.token);
                    localStorage.setItem('zpms_uid', result.user.id);
                    location.reload();
                } else {
                    document.getElementById('err-pass').innerText = result.message;
                    document.getElementById('err-pass').style.display = 'block';
                    btn.innerText = "Log In";
                }
            } catch(e) {
                alert("Login Error");
            }
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // --- 5. INITIALIZATION ---

        window.onload = async () => {
            const token = localStorage.getItem('zpms_token');
            const uid = localStorage.getItem('zpms_uid');

            if(token && uid) {
                try {
                    // Restore Session
                    document.getElementById('loading-overlay').classList.remove('hidden');
                    
                    // 1. Get User Details
                    // We use 'checkID' here just to get the profile object without password, 
                    // assuming the token is valid. A dedicated 'me' endpoint is better, but checkID works.
                    const userRes = await api.request('checkID', { id: uid });
                    if(!userRes) throw new Error("User not found");
                    currentUser = userRes;

                    // 2. Fetch Shared Goals
                    const settingsRes = await api.request('getSettings', { id: 'shared_goals_v1' });
                    if(settingsRes && settingsRes.data) masterData = settingsRes.data;

                    // 3. Launch UI
                    initApp();

                } catch(e) {
                    logout();
                }
            } else {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
            }
        };

        async function initApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('app-container').style.display = 'flex';

            // Fill Sidebar
            document.getElementById('disp-user').innerText = currentUser[COL.name];
            document.getElementById('disp-role').innerText = currentUser[COL.lvl] || 'Staff';

            // Pre-fetch Directory (Optimized)
            // Fetch chunks silently in background
            fetchDirectory();

            // Render Navigation based on Role
            const role = getRole(currentUser);
            renderNav(role);

            // Default Route
            if(role === 'Admin' || role === 'Master') loadAdmin();
            else loadScorecard(currentUser[COL.id]);
        }

        async function fetchDirectory() {
            try {
                // Fetch first 1000 or implement standard logic
                // The PHP fetchAll without params gets visible users
                allCompanyData = await api.request('fetchAll');
            } catch(e) { console.error("Dir Sync Failed", e); }
        }

        // --- 6. CORE LOGIC (Ported & Secured) ---

        function getRole(u) {
            const job = (u[COL.job] || "").toUpperCase();
            const role = (u[COL.role] || "").toLowerCase();
            
            if(role === 'admin' || role === 'master') return 'Admin'; // Admin override
            if(job.includes('HEAD OF EMPLOYEE GROWTH')) return 'Master';
            
            const lvl = (u[COL.lvl] || "").toUpperCase();
            if(lvl.includes('L1')) return 'Chief';
            if(lvl.includes('L2')) return 'Director';
            if(lvl.includes('L3') || lvl.includes('L4')) return 'Manager';
            
            return 'Staff';
        }

        // Navigation Renderer
        function renderNav(role) {
            const nav = document.getElementById('nav-menu');
            let html = `
                <div class="nav-item active" onclick="loadScorecard('${currentUser[COL.id]}')"><i class="fa-solid fa-user"></i> My Scorecard</div>
            `;

            if(role === 'Manager' || role === 'Director' || role === 'Chief' || role === 'Admin') {
                html += `<div class="nav-item" onclick="loadTeam()"><i class="fa-solid fa-users"></i> My Team</div>`;
            }

            if(role === 'Admin' || role === 'Master') {
                html += `<div style="margin-top:20px; font-size:0.75rem; font-weight:700; color:var(--text-muted); padding:0 18px;">ADMIN</div>`;
                html += `<div class="nav-item" onclick="loadAdmin()"><i class="fa-solid fa-toolbox"></i> Admin Portal</div>`;
            }

            nav.innerHTML = html;
        }

        // --- 7. SCORECARD LOGIC ---

        async function loadScorecard(targetId) {
            showLoading();
            
            // 1. Get Target Data
            let targetUser = allCompanyData.find(u => u[COL.id] == targetId);
            // If not in cache (e.g. self load before cache), fetch specifically
            if(!targetUser) {
                targetUser = await api.request('checkID', { id: targetId });
            }

            if(!targetUser) { alert("User load failed"); return; }

            // 2. Parse Goals
            let goals = targetUser[COL.goals];
            if(typeof goals === 'string') goals = JSON.parse(goals);
            if(!goals) goals = [];

            // 3. Render HTML
            const isSelf = (currentUser[COL.id] == targetId);
            const canEdit = isSelf && (!targetUser[COL.stat] || targetUser[COL.stat] === 'Draft');
            const status = targetUser[COL.stat] || 'Draft';

            let html = `
                <div class="animate-in">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <h2 style="margin:0;">${targetUser[COL.name]}</h2>
                                <p style="color:var(--text-muted);">${targetUser[COL.job]} &bull; <span class="status-badge ${status === 'Approved' ? 'approved' : 'draft'}">${status}</span></p>
                            </div>
                            ${canEdit ? `<button class="btn btn-primary" onclick="saveScorecard('${targetId}')">Save Changes</button>` : ''}
                        </div>
                    </div>

                    <div id="goals-container"></div>
                </div>
            `;

            document.getElementById('main-view').innerHTML = html;
            renderGoals(goals, document.getElementById('goals-container'), canEdit);
        }

        function renderGoals(goals, container, editable) {
            if(goals.length === 0) {
                container.innerHTML = `<div style="text-align:center; padding:40px; color:var(--text-muted);">No goals defined. Import or Add Goal.</div>`;
                return;
            }

            container.innerHTML = goals.map((g, i) => `
                <div class="pro-goal-card">
                    <div style="display:flex; justify-content:space-between;">
                        <h3 style="margin:0;">${g.title}</h3>
                        <span class="status-badge draft">${(g.weight * 100).toFixed(0)}%</span>
                    </div>
                    <p style="color:var(--text-muted); font-size:0.9rem;">${g.desc || ''}</p>
                    
                    <div class="pro-targets-container">
                        ${[1,2,3,4,5,6].map(n => `
                            <div class="pro-target-item ${n===4?'is-target':''}">
                                <div class="pro-target-header">L${n}</div>
                                <div style="padding:10px;">${g.targets ? g.targets[n-1] : '-'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function saveScorecard(id) {
            // Placeholder for saving logic using api.request('saveUser')
            // Implementation would gather inputs from DOM and send payload
            alert("Save functionality linked to API.");
        }

        // --- 8. ADMIN & TEAM LOGIC ---

        function loadTeam() {
            // Filter allCompanyData for reports
            const myId = currentUser[COL.id];
            const team = allCompanyData.filter(u => u[COL.mgr] && u[COL.mgr].includes(myId));
            
            let html = `
                <div class="animate-in">
                    <h2 style="margin-bottom:24px;">My Team (${team.length})</h2>
                    <div class="team-grid">
                        ${team.map(u => `
                            <div class="premium-team-card" onclick="loadScorecard('${u[COL.id]}')">
                                <div class="pt-avatar">${u[COL.name][0]}</div>
                                <div class="pt-name">${u[COL.name]}</div>
                                <div class="pt-role">${u[COL.job]}</div>
                                <div class="status-badge ${u[COL.stat] === 'Approved' ? 'approved' : 'draft'}" style="margin-top:12px;">${u[COL.stat] || 'Draft'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.getElementById('main-view').innerHTML = html;
        }

        function loadAdmin() {
            // Admin Dashboard Placeholder
            document.getElementById('main-view').innerHTML = `
                <div class="animate-in">
                    <div class="card">
                        <h2>Admin Portal</h2>
                        <p>Manage Settings, Users, and Global Goals.</p>
                        <button class="btn btn-outline" onclick="fetchDirectory()">Sync Directory</button>
                    </div>
                </div>
            `;
        }

        // --- UTILS ---
        function showLoading() {
            document.getElementById('main-view').innerHTML = '<div style="display:flex; justify-content:center; padding:50px;"><div class="spinner"></div></div>';
        }

        // --- CONFIRM MODAL ---
        let confirmCallback = null;
        function showConfirm(msg, cb) {
            document.getElementById('conf-msg').innerText = msg;
            confirmCallback = cb;
            document.getElementById('confirm-overlay').style.display = 'flex';
            setTimeout(() => document.getElementById('confirm-overlay').classList.add('open'), 10);
        }
        function closeConfirm() {
            document.getElementById('confirm-overlay').classList.remove('open');
            setTimeout(() => document.getElementById('confirm-overlay').style.display = 'none', 300);
        }
        function doConfirm() {
            if(confirmCallback) confirmCallback();
            closeConfirm();
        }

    </script>
</body>
</html>
