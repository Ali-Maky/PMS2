<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PERFORMANCE: Preconnect to external domains for faster loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://pms-back-production-b693.up.railway.app">
    
    <!-- PERFORMANCE: DNS prefetch for faster resolution -->
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">

    <!-- Security: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' 'unsafe-eval' 
            https://cdn.jsdelivr.net 
            https://cdnjs.cloudflare.com;
        style-src 'self' 'unsafe-inline' 
            https://fonts.googleapis.com 
            https://cdnjs.cloudflare.com;
        font-src 'self' 
            https://fonts.gstatic.com 
            https://cdnjs.cloudflare.com;
        img-src 'self' data: blob:;
        connect-src 'self' 
            https://pms-back-production-b693.up.railway.app
            https://cdn.jsdelivr.net
            https://cdnjs.cloudflare.com;
        form-action 'self';
        base-uri 'self';
    ">

    <title>Zain- Enterprise Suite</title>

    <!-- PERFORMANCE: Load fonts with display=swap for faster text rendering -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- PERFORMANCE: Defer non-critical scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" defer></script>

    <!-- PDF Export - Load only when needed -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

    <style>
        .pro-goal-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .pro-unit-badge {
            background: #e0f2fe;
            /* Light Blue */
            color: #0369a1;
            /* Dark Blue text */
            font-weight: 700;
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid #bae6fd;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Dynamic Rating Badges */
        .badge-score {
            padding: 6px 12px;
            border-radius: 8px;
            font-weight: 800;
            font-family: monospace;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .badge-rating {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            display: inline-block;
            white-space: nowrap;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Color Levels */
        .lvl-6 {
            background: #0f766e;
            color: white;
        }

        /* Astronaut - Purple */
        .lvl-5 {
            background: #10b981;
            color: white;
        }

        /* Flyer - Green */
        .lvl-4 {
            background: #3b82f6;
            color: white;
        }

        /* Runner - Blue */
        .lvl-3 {
            background: #f59e0b;
            color: white;
        }

        /* Walker - Orange */
        .lvl-2 {
            background: #ef4444;
            color: white;
        }

        /* Stagnant - Red */
        .lvl-1 {
            background: #94a3b8;
            color: white;
        }

        /* Idle - Gray */
        .lvl-0 {
            background: #f1f5f9;
            color: var(--text-muted);
        }

        /* N/A - Light Gray */
        :root {
            /* New Modern Palette - Teal & Coral Accent */
            --primary: #0d9488;
            /* Teal 600 */
            --primary-dark: #0f766e;
            /* Teal 700 */
            --primary-light: #ccfbf1;
            /* Teal 100 */
            --primary-soft: rgba(13, 148, 136, 0.1);
            --secondary: #f97316;
            /* Orange 500 */
            --accent: #06b6d4;
            /* Cyan 500 */

            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-sidebar: linear-gradient(180deg, #1e3a5f 0%, #2d4a6f 100%);
            --bg-sidebar-solid: #1e3a5f;

            --text-main: #0f172a;
            --text-muted: #64748b;
            --text-light: #94a3b8;
            --text-sidebar: #ffffff;
            --text-sidebar-muted: #bfdbfe;

            --border: #e2e8f0;
            --border-hover: #cbd5e1;

            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;

            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.05), 0 1px 2px -1px rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            --shadow-lg: 0 10px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.05);
            --shadow-xl: 0 20px 40px -10px rgb(0 0 0 / 0.15);
            --shadow-glow: 0 0 20px rgba(13, 148, 136, 0.25);
            --shadow-card: 0 1px 3px rgba(0,0,0,0.04), 0 4px 12px rgba(0,0,0,0.04);

            --radius-xl: 20px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;
            --radius-xs: 6px;

            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease;
            --font-main: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            font-family: var(--font-main);
            background: var(--bg-body);
            color: var(--text-main);
            -webkit-font-smoothing: antialiased;
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* --- Skeleton Loaders --- */
        .skeleton {
            background: linear-gradient(90deg,
                    var(--border) 25%,
                    rgba(255, 255, 255, 0.3) 50%,
                    var(--border) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        .skeleton-text {
            height: 16px;
            width: 100%;
            margin-bottom: 8px;
        }

        .skeleton-text.sm {
            height: 12px;
            width: 60%;
        }

        .skeleton-text.md {
            height: 16px;
            width: 80%;
        }

        .skeleton-text.lg {
            height: 24px;
            width: 70%;
        }

        .skeleton-text.xl {
            height: 32px;
            width: 50%;
        }

        .skeleton-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
        }

        .skeleton-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 16px;
        }

        .skeleton-row {
            display: flex;
            gap: 16px;
            align-items: center;
            margin-bottom: 16px;
        }

        .skeleton-metric {
            flex: 1;
            height: 100px;
            border-radius: var(--radius-lg);
        }

        .skeleton-table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
        }

        .skeleton-cell {
            height: 20px;
            border-radius: 4px;
        }

        /* --- Loading & Overlays --- */
        #loading-overlay {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 100%);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .spinner {
            width: 56px;
            height: 56px;
            border: 4px solid rgba(13, 148, 136, 0.2);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 0.8s cubic-bezier(0.5, 0, 0.5, 1) infinite;
            margin-bottom: 24px;
            box-shadow: 0 0 30px rgba(13, 148, 136, 0.3);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #save-status {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 14px 24px;
            border-radius: 14px;
            box-shadow: var(--shadow-xl);
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            transform: translateY(100px);
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        #save-status.show {
            transform: translateY(0);
        }

        .save-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--text-light);
        }

        .save-dot.saving {
            background: var(--warning);
            animation: pulse 1s infinite;
        }

        .save-dot.saved {
            background: var(--success);
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.8);
            }
        }

        /* --- Enhanced Micro-Animations & Transitions --- */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0);
                opacity: 1;
            }

            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        .animate-in {
            animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        .animate-fade {
            animation: fadeIn 0.3s ease-out;
        }

        .animate-scale {
            animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Button Hover Enhancement */
        .btn {
            position: relative;
            overflow: hidden;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.25);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn-primary:hover {
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.35);
        }

        /* Card Hover Effects */
        .metric-card,
        .member-card,
        .premium-team-card,
        .goal-card,
        .pro-goal-card,
        .shared-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .metric-card:hover,
        .premium-team-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
        }

        .goal-card:hover,
        .pro-goal-card:hover {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-soft);
        }

        /* Navigation Link Transitions */
        .nav-item {
            transition: all 0.2s ease;
        }

        .nav-item:hover {
            padding-left: 20px;
        }

        .nav-item.active {
            animation: slideInRight 0.3s ease-out;
        }

        /* Table Row Hover Effect */
        tr {
            transition: background-color 0.15s ease;
        }

        /* Input Focus Effects */
        input,
        select,
        textarea {
            transition: all 0.25s ease;
        }

        input:focus,
        select:focus,
        textarea:focus {
            transform: scale(1.005);
        }

        /* Badge Animations */
        .status-badge {
            transition: all 0.2s ease;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        /* Notification Badge Pulse */
        .notification-badge {
            animation: pulse 2s infinite;
        }

        /* Stagger Animation Helper */
        .stagger-1 {
            animation-delay: 0.05s;
        }

        .stagger-2 {
            animation-delay: 0.1s;
        }

        .stagger-3 {
            animation-delay: 0.15s;
        }

        .stagger-4 {
            animation-delay: 0.2s;
        }

        .stagger-5 {
            animation-delay: 0.25s;
        }

        /* Keyboard Shortcut Modal Styles */
        kbd {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.85rem;
            font-family: 'Inter', monospace;
            background: var(--bg-page);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 2px 0 var(--border);
            color: var(--text-main);
            min-width: 28px;
            text-align: center;
        }

        .shortcut-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .shortcut-row:last-child {
            border-bottom: none;
        }

        .shortcut-row kbd {
            min-width: 60px;
        }

        .shortcut-row span {
            color: var(--text-muted);
        }

        /* --- Login Screen --- */
        #login-screen {
            position: fixed;
            inset: 0;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d4a6f 50%, #1e3a5f 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow: hidden;
        }

        #login-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 30% 30%, rgba(13, 148, 136, 0.2) 0%, transparent 50%),
                        radial-gradient(circle at 70% 70%, rgba(249, 115, 22, 0.15) 0%, transparent 50%);
            animation: bgPulse 15s ease-in-out infinite;
        }

        @keyframes bgPulse {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-5%, -5%) scale(1.1); }
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            width: 440px;
            padding: 56px 48px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 25px 80px -20px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: cardFloat 0.8s cubic-bezier(0.16, 1, 0.3, 1);
            position: relative;
            z-index: 1;
        }

        @keyframes cardFloat {
            from { opacity: 0; transform: translateY(40px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .login-logo {
            width: 72px;
            height: 72px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            border-radius: 20px;
            color: white;
            font-size: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 28px auto;
            box-shadow: 0 10px 30px -10px rgba(13, 148, 136, 0.5);
            position: relative;
        }

        .login-logo::after {
            content: '';
            position: absolute;
            inset: -4px;
            border-radius: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            z-index: -1;
            opacity: 0.3;
            filter: blur(10px);
        }

        .login-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 14px;
            font-size: 1rem;
            background: #f8fafc;
            margin-top: 8px;
            transition: var(--transition);
            color: var(--text-main);
            font-weight: 500;
        }

        .login-input:focus {
            background: white;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(13, 148, 136, 0.15);
            outline: none;
        }

        .login-input::placeholder {
            color: #94a3b8;
        }

        .login-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 14px;
            font-weight: 700;
            cursor: pointer;
            font-size: 1rem;
            margin-top: 28px;
            transition: var(--transition);
            box-shadow: 0 4px 15px -3px rgba(13, 148, 136, 0.4);
            position: relative;
            overflow: hidden;
        }

        .login-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }

        .login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px -5px rgba(13, 148, 136, 0.5);
        }

        .login-btn:hover::before {
            left: 100%;
        }

        /* --- Main Layout --- */
        #app-container {
            display: none;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            flex-direction: row;
            background: var(--bg-body);
        }

        .sidebar {
            width: 280px;
            min-width: 280px;
            background: var(--bg-sidebar);
            padding: 28px 20px;
            display: flex;
            flex-direction: column;
            z-index: 10;
            flex-shrink: 0;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, transparent, rgba(255,255,255,0.1), transparent);
        }

        .main-content {
            flex: 1;
            height: 100%;
            overflow-y: auto;
            padding: 36px 44px;
            background: linear-gradient(180deg, #f1f5f9 0%, #f8fafc 100%);
            min-width: 0;
        }

        .main-content::-webkit-scrollbar {
            width: 10px;
        }

        .main-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .main-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 5px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .main-content::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .brand {
            font-size: 1.3rem;
            font-weight: 800;
            color: white;
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 14px;
            letter-spacing: -0.3px;
            padding: 0 8px;
        }

        .brand i {
            color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--accent));
            padding: 10px;
            border-radius: 12px;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px -3px rgba(13, 148, 136, 0.4);
        }

        .nav-item {
            padding: 14px 16px;
            border-radius: 12px;
            color: var(--text-sidebar-muted);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            gap: 14px;
            align-items: center;
            margin-bottom: 6px;
            transition: var(--transition-fast);
            font-size: 0.9rem;
            position: relative;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
            opacity: 0.8;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-sidebar);
        }

        .nav-item:hover i {
            opacity: 1;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(13, 148, 136, 0.2), transparent);
            color: var(--primary-light);
            border-left: 3px solid var(--primary);
            border-radius: 0 12px 12px 0;
            margin-left: -20px;
            padding-left: 36px;
        }

        .nav-item.active i {
            color: var(--primary);
            opacity: 1;
        }

        .user-panel {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            padding-top: 24px;
            margin-top: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .user-panel > div:first-child {
            color: var(--text-sidebar);
        }

        .user-panel > div:nth-child(2) {
            color: var(--text-sidebar-muted) !important;
        }

        /* --- Cards & UI Elements --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 28px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-card);
            border: 1px solid rgba(226, 232, 240, 0.8);
            width: 100%;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(13, 148, 136, 0.3), transparent);
            opacity: 0;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
            border-color: rgba(13, 148, 136, 0.2);
            transform: translateY(-2px);
        }

        .card:hover::before {
            opacity: 1;
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            width: 100%;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0;
            letter-spacing: -0.5px;
            position: relative;
        }

        .page-title::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 0;
            width: 50px;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 2px;
        }

        .page-sub {
            color: var(--text-muted);
            margin: 14px 0 0 0;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .dash-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            width: 100%;
        }

        .metrics-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 28px;
            width: 100%;
        }

        @media (max-width: 1200px) {
            .metrics-row {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .metrics-row {
                grid-template-columns: 1fr;
            }
        }

        .metric-card {
            background: white;
            padding: 0;
            border-radius: var(--radius-xl);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-card);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .metric-card-inner {
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .metric-icon {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            margin-bottom: 16px;
        }

        .metric-card:nth-child(1) .metric-icon { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; box-shadow: 0 8px 20px -8px rgba(13, 148, 136, 0.5); }
        .metric-card:nth-child(2) .metric-icon { background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; box-shadow: 0 8px 20px -8px rgba(139, 92, 246, 0.5); }
        .metric-card:nth-child(3) .metric-icon { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; box-shadow: 0 8px 20px -8px rgba(245, 158, 11, 0.5); }
        .metric-card:nth-child(4) .metric-icon { background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; box-shadow: 0 8px 20px -8px rgba(59, 130, 246, 0.5); }

        .metric-val {
            font-size: 2rem;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -1px;
            color: var(--text-main);
            margin-bottom: 6px;
        }

        .metric-lbl {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            letter-spacing: 0.5px;
        }

        .metric-sub-val {
            display: block;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--primary);
            margin-top: 8px;
            padding: 4px 12px;
            background: var(--primary-light);
            border-radius: 20px;
        }

        .metric-card.highlight {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            box-shadow: 0 10px 40px -15px rgba(13, 148, 136, 0.6);
        }

        .metric-card.highlight:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 50px -15px rgba(13, 148, 136, 0.7);
        }

        .metric-card.highlight .metric-icon {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: none;
        }

        .metric-card.highlight .metric-val {
            color: white;
        }

        .metric-card.highlight .metric-lbl {
            color: rgba(255, 255, 255, 0.85);
        }

        .metric-card.highlight .metric-sub-val {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .metric-progress {
            height: 4px;
            background: #e2e8f0;
            margin-top: auto;
        }

        .metric-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            border-radius: 0 2px 2px 0;
            transition: width 0.8s ease;
        }

        .metric-card.highlight .metric-progress {
            background: rgba(255, 255, 255, 0.2);
        }

        .metric-card.highlight .metric-progress-bar {
            background: rgba(255, 255, 255, 0.9);
        }

        /* --- Shared Goals Grid --- */
        .shared-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 24px;
        }

        .shared-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 0;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        .shared-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .shared-header {
            padding: 16px 24px;
            background: #f9fafb;
            border-bottom: 1px solid var(--border);
            font-weight: 700;
            font-size: 1rem;
            color: var(--text-main);
        }

        .segment-bar {
            display: flex;
            padding: 12px;
            gap: 4px;
            flex: 1;
            align-items: stretch;
            min-height: 90px;
        }

        .segment {
            flex: 1;
            border-radius: 8px;
            background: #f1f5f9;
            border: 1px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: var(--transition);
            padding: 4px;
        }

        .seg-num {
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        .seg-val {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.25;
            font-weight: 600;
        }

        .segment.is-target {
            background: #eff6ff;
            border-color: #bfdbfe;
        }

        .segment.is-target .seg-num {
            color: #3b82f6;
        }

        .target-badge {
            position: absolute;
            top: -6px;
            background: #3b82f6;
            color: white;
            font-size: 0.5rem;
            padding: 2px 6px;
            border-radius: 99px;
            font-weight: 800;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .segment.active {
            background: var(--primary) !important;
            color: white !important;
            transform: scale(1.1);
            z-index: 10;
            box-shadow: var(--shadow-lg);
            border-radius: 8px;
        }

        .segment.active .seg-num,
        .segment.active .seg-val {
            color: white !important;
        }

        /* --- Individual Goals --- */
        .goal-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border-left: 6px solid var(--primary);
            transition: var(--transition);
        }

        .goal-card:hover {
            box-shadow: var(--shadow-md);
        }

        .goal-header-row {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }

        .goal-input-title {
            font-weight: 700;
            color: var(--text-main);
            font-size: 1.1rem;
            border: none;
            width: 60%;
            background: transparent;
            font-family: inherit;
        }

        .chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f3f4f6;
            padding: 8px 16px;
            border-radius: 99px;
            border: 1px solid var(--border);
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        .chip input {
            border: none;
            background: transparent;
            width: 40px;
            text-align: right;
            font-weight: 800;
            color: var(--primary);
        }

        .goal-body {
            padding: 24px;
            background: #fcfcfc;
        }

        .goal-desc {
            width: 100%;
            border: 1px solid var(--border);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-family: inherit;
            font-size: 0.95rem;
            background: white;
            resize: none;
            transition: var(--transition);
        }

        .goal-desc:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
        }

        .target-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 4px;
            font-size: 0.85rem;
        }

        .target-table th {
            padding: 8px;
            color: var(--text-light);
            font-weight: 700;
            text-transform: uppercase;
            text-align: center;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
        }

        .target-table td {
            padding: 0;
        }

        .target-input {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            font-weight: 600;
            background: white;
            font-size: 0.9rem;
            transition: var(--transition);
            color: var(--text-main);
        }

        .target-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px var(--primary-light);
            z-index: 2;
            position: relative;
        }

        .runner-col {
            color: var(--info) !important;
            font-weight: 800 !important;
        }

        /* --- Report Tables --- */
        .report-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 8px;
            font-size: 0.95rem;
            margin-top: -8px;
        }

        .report-table th {
            text-align: left;
            padding: 0 20px 8px 20px;
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .report-table td {
            padding: 20px;
            background: white;
            border-top: 1px solid var(--border);
            border-bottom: 1px solid var(--border);
            transition: var(--transition);
        }

        .report-table tr:hover td {
            background: #f9fafb;
            border-color: #cbd5e1;
            transform: scale(1.005);
        }

        .report-table tr td:first-child {
            border-left: 1px solid var(--border);
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
            font-weight: 600;
            color: var(--text-main);
        }

        .report-table tr td:last-child {
            border-right: 1px solid var(--border);
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .prog-track {
            width: 100%;
            height: 8px;
            background: #e2e8f0;
            border-radius: 99px;
            overflow: hidden;
        }

        .prog-fill {
            height: 100%;
            border-radius: 99px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* --- Team Grid --- */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 24px;
        }

        .member-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: var(--transition);
            cursor: pointer;
            display: flex;
            gap: 20px;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .member-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .avatar {
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary-light), white);
            color: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 1.4rem;
            box-shadow: var(--shadow-sm);
        }

        .info-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .info-item {
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            display: flex;
            align-items: center;
            gap: 16px;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .info-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, var(--primary), var(--accent));
            opacity: 0;
            transition: var(--transition);
        }

        .info-item:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .info-item:hover::before {
            opacity: 1;
        }

        /* Expanded state for info-item */
        .info-item.expanded {
            background: linear-gradient(135deg, #f8fafc, #ffffff);
            border-color: var(--primary);
            box-shadow: var(--shadow-lg);
        }

        .info-item.expanded::before {
            opacity: 1;
        }

        .info-item.expanded .info-value {
            white-space: normal;
            word-break: break-word;
        }

        /* Expand indicator */
        .info-item .expand-indicator {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: var(--text-light);
            opacity: 0;
            transition: var(--transition);
        }

        .info-item:hover .expand-indicator {
            opacity: 1;
        }

        .info-item.expanded .expand-indicator {
            opacity: 1;
            color: var(--primary);
        }

        .info-item.expanded .expand-indicator i {
            transform: rotate(180deg);
        }

        .info-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .info-icon.user { background: linear-gradient(135deg, #dbeafe, #eff6ff); color: #2563eb; }
        .info-icon.job { background: linear-gradient(135deg, #d1fae5, #ecfdf5); color: #059669; }
        .info-icon.division { background: linear-gradient(135deg, #fef3c7, #fffbeb); color: #d97706; }
        .info-icon.manager { background: linear-gradient(135deg, #ede9fe, #f5f3ff); color: #7c3aed; }
        .info-icon.id { background: linear-gradient(135deg, #fee2e2, #fef2f2); color: #dc2626; }
        .info-icon.company { background: linear-gradient(135deg, var(--primary-light), #f0fdfa); color: var(--primary); }

        .info-content {
            flex: 1;
            min-width: 0;
            padding-right: 24px;
        }

        .info-item label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 700;
            text-transform: uppercase;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-weight: 700;
            color: var(--text-main);
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: var(--transition);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: var(--transition-fast);
            font-size: 0.9rem;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 15px -3px rgba(13, 148, 136, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(13, 148, 136, 0.45);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-outline {
            background: white;
            border-color: var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
            box-shadow: var(--shadow-sm);
        }

        .btn-delete {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: transparent;
            border: none;
            transition: var(--transition-fast);
        }

        .btn-delete:hover {
            background: #fef2f2;
            color: var(--danger);
            transform: scale(1.05);
        }

        .hidden {
            display: none !important;
        }

        .animate-in {
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes slideUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .admin-tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: var(--transition);
        }

        .admin-tab:hover {
            color: var(--text-main);
        }

        .admin-tab.active {
            color: var(--primary);
            border-color: var(--primary);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .status-badge.submitted {
            background: var(--primary-light);
            color: var(--primary);
        }

        .status-badge.approved {
            background: #d1fae5;
            color: var(--success);
        }

        .status-badge.draft {
            background: #fef3c7;
            color: #d97706;
        }

        .prog-container {
            width: 120px;
            height: 10px;
            background: #e2e8f0;
            border-radius: 99px;
            overflow: hidden;
        }

        .prog-bar {
            height: 100%;
            border-radius: 99px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .target-input.active-highlight {
            border: 2px solid var(--primary) !important;
            background: var(--primary-light) !important;
            color: var(--primary);
            font-weight: 800;
            transform: scale(1.05);
            z-index: 5;
            box-shadow: var(--shadow-md);
        }

        .draft-badge {
            background: #fef3c7;
            color: #d97706;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 800;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #fcd34d;
        }

        /* Modal Styles */
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 4000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        #modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .modal-card {
            background: white;
            width: 550px;
            padding: 40px;
            border-radius: 24px;
            transform: translateY(30px) scale(0.95);
            transition: var(--transition);
            box-shadow: var(--shadow-lg);
            max-height: 90vh;
            overflow-y: auto;
        }

        #modal-overlay.open .modal-card {
            transform: translateY(0) scale(1);
        }

        /* ... Professional Goal Card ... */
        .pro-goal-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            transition: all 0.2s ease;
            position: relative;
        }

        .pro-goal-card:hover {
            border-color: var(--primary-light);
            box-shadow: var(--shadow-md);
        }

        .pro-goal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }

        .pro-goal-title-input {
            width: 100%;
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
            border: 1px solid transparent;
            background: transparent;
            padding: 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .pro-goal-title-input:focus,
        .pro-goal-title-input:hover {
            background: #f8fafc;
            border-color: var(--border);
        }

        .pro-goal-title-input:focus {
            border-color: var(--primary);
            background: white;
        }

        .pro-goal-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .pro-weight-badge {
            background: #f1f5f9;
            color: var(--text-main);
            font-weight: 600;
            font-size: 0.85rem;
            padding: 6px 12px;
            border-radius: 20px;
            border: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pro-weight-input {
            width: 40px;
            text-align: right;
            background: transparent;
            border: none;
            font-weight: 700;
            color: var(--primary);
            outline: none;
        }

        .pro-goal-desc {
            width: 100%;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--text-slate);
            margin-bottom: 20px;
            background: #fdfdfd;
            resize: vertical;
            min-height: 60px;
            transition: all 0.2s;
        }

        .pro-goal-desc:focus {
            border-color: var(--primary);
            background: white;
        }

        .pro-targets-container {
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
        }

        .pro-target-item {
            border-right: 1px solid var(--border);
            background: white;
        }

        .pro-target-item:last-child {
            border-right: none;
        }

        .pro-target-header {
            background: #f8fafc;
            padding: 8px;
            text-align: center;
            font-size: 0.7rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
        }

        .pro-target-item.is-target .pro-target-header {
            background: var(--primary-soft);
            color: var(--primary);
        }

        .pro-target-val input {
            width: 100%;
            text-align: center;
            border: none;
            padding: 12px 4px;
            font-size: 0.9rem;
            font-weight: 600;
            outline: none;
            background: transparent;
        }

        .pro-target-val input:focus {
            background: #fffbeb;
        }

        .pro-goal-footer {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 16px;
        }

        /* --- Notification Center --- */
        .notification-bell {
            position: relative;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-bell:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification-bell i {
            font-size: 1.2rem;
            color: var(--text-sidebar-muted);
        }

        .notification-bell:hover i {
            color: var(--text-sidebar);
        }

        .notification-badge {
            position: absolute;
            top: 4px;
            right: 4px;
            background: var(--secondary);
            color: white;
            font-size: 0.65rem;
            font-weight: 800;
            min-width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #1e3a5f;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .notification-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border);
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.1);
            z-index: 5000;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .notification-panel.open {
            right: 0;
        }

        .notification-panel-header {
            padding: 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-panel-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .notification-panel-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .notification-item {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            gap: 14px;
            align-items: flex-start;
        }

        .notification-item:hover {
            background: var(--primary-light);
        }

        .notification-item.unread {
            background: rgba(99, 102, 241, 0.05);
            border-left: 3px solid var(--primary);
        }

        .notification-unread-dot {
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 6px;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.9); }
        }

        .notification-item:not(.unread) {
            opacity: 0.7;
        }

        .notification-item:not(.unread):hover {
            opacity: 1;
        }

        .mark-all-read-btn {
            font-size: 0.75rem;
            color: var(--primary);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .mark-all-read-btn:hover {
            background: var(--primary-light);
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .notification-icon.approval {
            background: #dbeafe;
            color: #2563eb;
        }

        .notification-icon.submission {
            background: #fef3c7;
            color: #d97706;
        }

        .notification-icon.published {
            background: #d1fae5;
            color: #059669;
        }

        .notification-icon.returned {
            background: #fee2e2;
            color: #dc2626;
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.9rem;
            margin-bottom: 4px;
        }

        .notification-desc {
            color: var(--text-muted);
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .notification-time {
            font-size: 0.7rem;
            color: var(--text-light);
            margin-top: 6px;
        }

        .notification-empty {
            padding: 60px 24px;
            text-align: center;
            color: var(--text-muted);
        }

        .notification-empty i {
            font-size: 3rem;
            opacity: 0.3;
            margin-bottom: 16px;
        }

        .notification-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.3);
            z-index: 4999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .notification-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        /* --- GLOBAL UI REDESIGN --- */
        /* Navigation */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar styles defined above - these are overrides for specific contexts */

        .user-panel {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
            background: transparent;
        }

        #nav-menu {
            overflow-y: auto;
            flex: 1;
            padding: 0 8px;
        }

        /* Nav items in sidebar context - uses styles defined above */
            background: var(--primary-soft);
            color: var(--primary);
        /* Toasts */
        #toast-container {
            position: fixed;
            bottom: 32px;
            right: 32px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 12px;
            pointer-events: none;
        }

        .toast {
            background: white;
            border-left: 4px solid var(--primary);
            padding: 18px 24px;
            border-radius: 14px;
            box-shadow: 0 15px 35px -10px rgba(0, 0, 0, 0.15), 0 5px 15px -5px rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            gap: 16px;
            min-width: 320px;
            max-width: 420px;
            transform: translateX(120%);
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            pointer-events: auto;
            border: 1px solid var(--border);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            border-color: transparent;
            border-left-color: var(--success);
            background: linear-gradient(135deg, white, #f0fdf4);
        }

        .toast.error {
            border-color: transparent;
            border-left-color: var(--danger);
            background: linear-gradient(135deg, white, #fef2f2);
        }

        .toast-icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast-msg {
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Custom Confirm Modal */
        #confirm-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
        }

        #confirm-overlay.open {
            display: flex;
            animation: fadeIn 0.2s forwards;
        }

        .confirm-card {
            background: white;
            width: 90%;
            max-width: 420px;
            padding: 32px;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            text-align: center;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        #confirm-overlay.open .confirm-card {
            transform: scale(1);
            opacity: 1;
        }

        /* PREMIUM TEAM CARD CSS */
        .premium-team-card {
            background: white;
            border-radius: var(--radius-xl);
            padding: 32px 24px 24px 24px;
            box-shadow: var(--shadow-card);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .premium-team-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .premium-team-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: rgba(13, 148, 136, 0.2);
        }

        .premium-team-card:hover::before {
            transform: scaleX(1);
        }

        .pt-avatar {
            width: 72px;
            height: 72px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            font-weight: 800;
            margin: 0 auto 20px auto;
            box-shadow: 0 8px 20px -8px rgba(13, 148, 136, 0.5);
        }

        .pt-info {
            text-align: center;
            margin-bottom: 24px;
            flex-grow: 1;
        }

        .pt-name {
            font-weight: 800;
            font-size: 1.15rem;
            color: var(--text-main);
            margin-bottom: 6px;
            letter-spacing: -0.025em;
        }

        .pt-role {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .pt-status {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 0.7rem;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }
    </style>
</head>

<body>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div style="font-weight:700; color:#5eead4; font-size:1rem; letter-spacing:0.5px;">Initializing Zain Performance
            Management...
        </div>
    </div>

    <div id="save-status">
        <div class="save-dot" id="save-dot"></div>
        <span id="save-text">All changes saved</span>
    </div>

    <!-- Notification Center -->
    <div id="notification-overlay" class="notification-overlay" onclick="closeNotifications()"></div>
    <div id="notification-panel" class="notification-panel">
        <div class="notification-panel-header">
            <h3><i class="fa-solid fa-bell" style="margin-right:8px; color:var(--primary);"></i> Notifications</h3>
            <div style="display:flex; align-items:center; gap:12px;">
                <span class="mark-all-read-btn" onclick="markAllNotificationsRead()" title="Mark all as read">
                    <i class="fa-solid fa-check-double"></i> Mark All Read
                </span>
                <button onclick="closeNotifications()"
                    style="background:none; border:none; cursor:pointer; font-size:1.2rem; color:var(--text-muted);">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
        <div class="notification-panel-body" id="notification-list">
            <!-- Notifications will be rendered here -->
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-card">
            <h3 id="modal-title" style="margin-top:0;">Add Employee</h3>
            <input type="hidden" id="edit-mode-id">
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Employee
                    ID</label>
                <input id="u-id" class="login-input" placeholder="ZIQ...">
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Full Name</label>
                <input id="u-name" class="login-input" placeholder="John Doe">
            </div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-bottom:15px;">
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Level</label>
                    <input id="u-lvl" class="login-input" placeholder="L4 Manager">
                </div>
                <div>
                    <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Job
                        Title</label>
                    <input id="u-job" class="login-input" placeholder="Software Engineer">
                </div>
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Division</label>
                <input id="u-div" class="login-input" placeholder="Technology">
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Department</label>
                <input id="u-dept" class="login-input" placeholder="IT Development">
            </div>
            <div style="margin-bottom:15px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Manager
                    ID</label>
                <input id="u-mgr" class="login-input" placeholder="Manager ID or Name">
            </div>
            <div style="margin-bottom:25px;">
                <label style="font-size:0.8rem; font-weight:700; color:var(--text-muted);">Password
                    (Optional)</label>
                <input id="u-pass" type="password" class="login-input" placeholder="Set new password...">
            </div>
            <div style="display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-outline" onclick="closeUserModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveUser()">Save Employee</button>
            </div>
        </div>
    </div>
    <div id="otp-modal" class="modal-overlay"
        style="position:fixed; inset:0; z-index:9500; display:none; align-items:center; justify-content:center; background:rgba(255,255,255,0.9); backdrop-filter:blur(5px);">
        <div class="modal-card"
            style="background:white; padding:40px; border-radius:24px; text-align:center; width:100%; max-width:400px; box-shadow:0 25px 50px -12px rgba(0,0,0,0.25); border:1px solid #e5e7eb;">
            <div style="font-size:3rem; color:var(--primary); margin-bottom:16px;"><i class="fa-solid fa-shield-halved"></i>
            </div>
            <h3 style="margin:0 0 8px 0; font-size:1.5rem; font-weight:800; color:#1f2937;">Verify Identity</h3>
            <p style="color:#6b7280; margin-bottom:24px; line-height:1.5;">Enter the 4-digit code sent to your
                registered contact.</p>

            <div style="display:flex; gap:12px; justify-content:center; margin-bottom:24px;">
                <input type="text" class="otp-digit" maxlength="1"
                    style="width:50px; height:60px; font-size:1.5rem; text-align:center; border:2px solid #e5e7eb; border-radius:12px; font-weight:700;"
                    onkeyup="focusNext(this)">
                <input type="text" class="otp-digit" maxlength="1"
                    style="width:50px; height:60px; font-size:1.5rem; text-align:center; border:2px solid #e5e7eb; border-radius:12px; font-weight:700;"
                    onkeyup="focusNext(this)">
                <input type="text" class="otp-digit" maxlength="1"
                    style="width:50px; height:60px; font-size:1.5rem; text-align:center; border:2px solid #e5e7eb; border-radius:12px; font-weight:700;"
                    onkeyup="focusNext(this)">
                <input type="text" class="otp-digit" maxlength="1"
                    style="width:50px; height:60px; font-size:1.5rem; text-align:center; border:2px solid #e5e7eb; border-radius:12px; font-weight:700;"
                    onkeyup="focusNext(this)">
            </div>

            <button class="btn btn-primary" onclick="verifyOTP()"
                style="width:100%; justify-content:center; padding:14px; font-size:1rem;">Verify & Login</button>
            <div style="margin-top:16px; font-size:0.85rem; color:#6b7280; cursor:pointer; text-decoration:underline;"
                onclick="resendOTP()">Resend Code</div>
        </div>
    </div>
    <div id="login-screen" class="hidden">
        <div id="view-id" class="login-card">
            <div class="login-logo"><i class="fa-solid fa-rocket"></i></div>
            <h1 style="color:var(--text-main); margin:0 0 8px 0; font-size:1.8rem; font-weight:800;">Zain Performance
                Management System</h1>
            <p style="color:var(--text-muted); margin-bottom:32px; font-weight:500;">Enterprise
                Performance Management
            </p>

            <div style="text-align:left; margin-bottom:24px;">
                <label
                    style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Employee
                    ID</label>
                <input type="text" id="inp-id" class="login-input" placeholder="e.g. ZIQ03130"
                    onkeypress="if(event.key==='Enter') checkID()">
            </div>

            <button onclick="checkID()" class="login-btn" id="btn-check">Continue <i class="fa-solid fa-arrow-right"
                    style="margin-left:8px;"></i></button>
            <p id="err-id"
                style="color:var(--danger); margin-top:16px; font-weight:600; font-size:0.9rem; display:none;"><i
                    class="fa-solid fa-circle-exclamation"></i> ID not found</p>
        </div>

        <div id="view-pass" class="login-card hidden">
            <div class="login-logo"><i class="fa-solid fa-lock"></i></div>
            <h1 id="lbl-welcome" style="color:var(--text-main); margin:0 0 8px 0; font-size:1.8rem; font-weight:800;">
                Welcome Back</h1>
            <p style="color:var(--text-muted); margin-bottom:32px; font-weight:500;">Please enter your password</p>

            <div style="text-align:left; margin-bottom:24px;">
                <label
                    style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Password</label>
                <input type="password" id="inp-pass" class="login-input" placeholder=""
                    onkeypress="if(event.key==='Enter') doLogin()">
            </div>

            <div id="grp-confirm" style="text-align:left; margin-bottom:24px;" class="hidden">
                <label
                    style="font-size:0.75rem; font-weight:700; color:var(--text-light); text-transform:uppercase; letter-spacing:0.5px;">Confirm
                    Password</label>
                <input type="password" id="inp-confirm" class="login-input" placeholder=""
                    onkeypress="if(event.key==='Enter') doLogin()">
            </div>

            <button onclick="doLogin()" class="login-btn" id="btn-login">Log In</button>

            <div class="back-link" onclick="location.reload()"
                style="margin-top:20px; color:var(--text-muted); cursor:pointer; font-size:0.9rem; font-weight:600;">
                Switch Account</div>
            <p id="err-pass"
                style="color:var(--danger); margin-top:16px; font-weight:600; font-size:0.9rem; display:none;"><i
                    class="fa-solid fa-circle-exclamation"></i> Incorrect Password</p>
        </div>
    </div>

    <div id="app-container">
        <aside class="sidebar">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:32px;">
                <div class="brand" style="margin-bottom:0;"><i class="fa-solid fa-bolt"></i> <span>PMS</span></div>
                <div class="notification-bell" onclick="toggleNotifications()">
                    <i class="fa-solid fa-bell"></i>
                    <span class="notification-badge" id="notification-count" style="display:none;">0</span>
                </div>
            </div>
            <nav id="nav-menu" style="flex:1; display:flex; flex-direction:column;"></nav>
            <div class="user-panel">
                <div style="font-weight:700; font-size:0.95rem; color:var(--text-main);" id="disp-user">User
                </div>
                <div style="font-size:0.8rem; color:var(--text-muted); margin-bottom:15px;" id="disp-role">
                    Role</div>
                <button class="btn btn-outline"
                    style="width:100%; justify-content:center; color:#fca5a5; border-color:rgba(239, 68, 68, 0.3); background:rgba(239, 68, 68, 0.15);"
                    onclick="logout()"><i class="fa-solid fa-power-off"></i> <span>Log
                        Out</span></button>
            </div>
        </aside>
        <main class="main-content" id="main-view"></main>
        <input type="file" id="file-import" hidden accept=".xlsx, .xls, .csv" onchange="processFile(this)">
        <input type="file" id="file-bulk" hidden accept=".xlsx, .xls, .csv" onchange="processBulkImport(this)">
        <input type="file" id="file-users" hidden accept=".xlsx, .xls, .csv" onchange="processUserBulkImport(this)">
    </div>
    <div id="div-weight-modal" class="hidden"
        style="position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center;">
        <div
            style="width:min(860px,92vw); background:white; border-radius:20px; box-shadow:0 25px 60px rgba(0,0,0,0.25); overflow:hidden;">
            <div
                style="padding:18px 22px; border-bottom:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <div id="div-weight-title" style="font-weight:800; font-size:1.05rem;">Division Weights</div>
                    <div id="div-weight-sub" style="color:#6b7280; font-size:0.9rem; margin-top:4px;"></div>
                </div>
                <button class="btn btn-outline" onclick="closeDivisionWeights()">Close</button>
            </div>

            <div style="padding:18px 22px; max-height:70vh; overflow:auto;">
                <div style="display:flex; gap:14px; align-items:center; margin-bottom:16px;">
                    <div style="flex:1;">
                        <div style="font-size:0.75rem; font-weight:800; color:#6b7280; text-transform:uppercase;">
                            Employees Weight (Default)</div>
                        <input id="div-weight-default" type="number" step="0.01" min="0" max="1"
                            style="width:220px; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-weight:800;">
                        <div style="color:#6b7280; font-size:0.85rem; margin-top:6px;">
                            Applies to all non-manager employees in this division.
                        </div>
                    </div>
                </div>

                <div style="margin-top:10px; font-weight:800;">Managers (Overrides)</div>
                <div id="div-weight-managers" style="display:grid; gap:10px; margin-top:10px;"></div>
            </div>

            <div
                style="padding:16px 22px; border-top:1px solid #e5e7eb; display:flex; justify-content:flex-end; gap:10px;">
                <button class="btn btn-primary" onclick="saveDivisionWeights()">Save</button>
            </div>
        </div>
    </div>


    <script>

        // --- NOTIFICATION CENTER ---
        let notificationData = [];
        const NOTIFICATION_READ_KEY = 'zpms_notifications_read';

        // Get read notification IDs from localStorage
        function getReadNotifications() {
            try {
                return JSON.parse(localStorage.getItem(NOTIFICATION_READ_KEY) || '[]');
            } catch (e) {
                return [];
            }
        }

        // Save read notification IDs to localStorage
        function saveReadNotifications(readIds) {
            try {
                // Keep only last 100 to prevent storage bloat
                localStorage.setItem(NOTIFICATION_READ_KEY, JSON.stringify(readIds.slice(-100)));
            } catch (e) {
                console.warn('Could not save read notifications');
            }
        }

        // Mark a notification as read
        function markNotificationRead(notificationId, index) {
            const readIds = getReadNotifications();
            if (!readIds.includes(notificationId)) {
                readIds.push(notificationId);
                saveReadNotifications(readIds);
            }
            
            // Update UI immediately
            const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
            if (item) {
                item.classList.remove('unread');
            }
            
            // Update badge count
            updateNotificationBadge();
            
            // Execute the notification action
            if (notificationData[index] && notificationData[index].action) {
                notificationData[index].action();
            }
        }

        // Mark all notifications as read
        function markAllNotificationsRead() {
            const readIds = getReadNotifications();
            notificationData.forEach(n => {
                if (!readIds.includes(n.id)) {
                    readIds.push(n.id);
                }
            });
            saveReadNotifications(readIds);
            
            // Update UI
            document.querySelectorAll('.notification-item.unread').forEach(item => {
                item.classList.remove('unread');
            });
            
            updateNotificationBadge();
            showToast('All notifications marked as read', 'success');
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            const overlay = document.getElementById('notification-overlay');
            const isOpen = panel.classList.contains('open');

            if (isOpen) {
                closeNotifications();
            } else {
                panel.classList.add('open');
                overlay.classList.add('open');
                refreshNotifications();
            }
        }

        function closeNotifications() {
            document.getElementById('notification-panel').classList.remove('open');
            document.getElementById('notification-overlay').classList.remove('open');
        }

        function refreshNotifications() {
            // Generate notifications from current system state
            notificationData = [];
            const readIds = getReadNotifications();

            if (typeof allCompanyData !== 'undefined' && allCompanyData.length > 0 && typeof user !== 'undefined') {
                const myId = (user[COL.id] || '').toString().toLowerCase();
                const myName = (user[COL.name] || '').toString().toLowerCase();
                const uRole = typeof getRole === 'function' ? getRole(user) : 'Staff';

                // Find pending submissions for managers
                const pendingForMe = allCompanyData.filter(u => {
                    const mgrStr = (u[COL.mgr] || '').toString().toLowerCase();
                    const isMyReport = mgrStr.includes(myId) || (myName.length > 3 && mgrStr.includes(myName));
                    return isMyReport && u[COL.stat] === 'Submitted to Manager';
                });

                pendingForMe.forEach(u => {
                    const nId = `submission_${u[COL.id]}`;
                    notificationData.push({
                        id: nId,
                        type: 'submission',
                        title: 'Scorecard Submitted',
                        desc: `${u[COL.name]} has submitted their scorecard for review.`,
                        time: 'Pending your action',
                        isRead: readIds.includes(nId),
                        action: () => { closeNotifications(); loadEval(u[COL.id]); }
                    });
                });

                // Admin notifications
                if (uRole === 'Admin' || uRole === 'Master') {
                    const hrPending = allCompanyData.filter(u => u[COL.stat] === 'Submitted to HR');
                    if (hrPending.length > 0) {
                        const nId = `hr_pending_${hrPending.length}`;
                        notificationData.push({
                            id: nId,
                            type: 'approval',
                            title: 'HR Approvals Pending',
                            desc: `${hrPending.length} scorecard(s) waiting for final approval.`,
                            time: 'Requires action',
                            isRead: readIds.includes(nId),
                            action: () => { closeNotifications(); loadHRAdmin(); switchAdminTab('app'); }
                        });
                    }

                    const readyToPublish = allCompanyData.filter(u => u[COL.stat] === 'Approved');
                    if (readyToPublish.length > 0) {
                        const nId = `ready_publish_${readyToPublish.length}`;
                        notificationData.push({
                            id: nId,
                            type: 'published',
                            title: 'Ready to Publish',
                            desc: `${readyToPublish.length} scorecard(s) approved and ready to publish.`,
                            time: 'Optional action',
                            isRead: readIds.includes(nId),
                            action: () => { closeNotifications(); loadHRAdmin(); switchAdminTab('app'); }
                        });
                    }
                }

                // Check if own scorecard was returned
                const myData = allCompanyData.find(u => (u[COL.id] || '').toString().toLowerCase() === myId);
                if (myData && (myData[COL.stat] === 'Returned' || myData[COL.stat] === 'Draft (Returned by Manager)')) {
                    const nId = `returned_${myId}`;
                    notificationData.push({
                        id: nId,
                        type: 'returned',
                        title: 'Scorecard Returned',
                        desc: 'Your scorecard was returned. Please review and resubmit.',
                        time: 'Requires action',
                        isRead: readIds.includes(nId),
                        action: () => { closeNotifications(); loadEval(myId); }
                    });
                }
            }

            renderNotifications();
            updateNotificationBadge();
        }

        function renderNotifications() {
            const list = document.getElementById('notification-list');
            if (!list) return;

            if (notificationData.length === 0) {
                list.innerHTML = `
                    <div class="notification-empty">
                        <i class="fa-regular fa-bell-slash"></i>
                        <div style="font-weight:600; font-size:1rem; margin-bottom:8px;">You're all caught up!</div>
                        <div style="font-size:0.85rem;">No pending notifications at this time.</div>
                    </div>`;
                return;
            }

            list.innerHTML = notificationData.map((n, i) => `
                <div class="notification-item ${n.isRead ? '' : 'unread'}" data-notification-id="${n.id}" onclick="markNotificationRead('${n.id}', ${i})">
                    <div class="notification-icon ${n.type}">
                        <i class="fa-solid ${n.type === 'submission' ? 'fa-paper-plane' :
                    n.type === 'approval' ? 'fa-clipboard-check' :
                        n.type === 'published' ? 'fa-rocket' : 'fa-rotate-left'}"></i>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-desc">${n.desc}</div>
                        <div class="notification-time">${n.time}</div>
                    </div>
                    ${!n.isRead ? '<div class="notification-unread-dot"></div>' : ''}
                </div>
            `).join('');
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notification-count');
            if (!badge) return;

            // Count only UNREAD notifications
            const unreadCount = notificationData.filter(n => !n.isRead).length;
            
            if (unreadCount > 0) {
                badge.innerText = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        // Refresh notifications when app loads
        function initNotifications() {
            if (typeof allCompanyData !== 'undefined' && allCompanyData.length > 0) {
                refreshNotifications();
            }
        }

        // --- PDF EXPORT FUNCTION ---
        async function exportScoreAsPdf() {
            if (typeof html2pdf === 'undefined') {
                showToast('PDF library not loaded. Please refresh and try again.', 'error');
                return;
            }

            showToast('Generating PDF...', 'info');

            // Get the scorecard container
            const mainContent = document.getElementById('main-content');
            if (!mainContent) {
                showToast('No scorecard loaded to export', 'error');
                return;
            }

            // Get employee info for filename
            const empName = targetUser ? (targetUser[COL.name] || 'Employee').split('(')[0].trim() : 'Employee';
            const empId = targetUser ? (targetUser[COL.id] || '') : '';
            const filename = `Scorecard_${empName.replace(/\s+/g, '_')}_${empId}_${new Date().toISOString().split('T')[0]}.pdf`;

            // Clone the content for PDF generation
            const clone = mainContent.cloneNode(true);

            // Clean up clone: remove buttons, inputs that don't print well
            clone.querySelectorAll('button, .btn').forEach(el => el.style.display = 'none');
            clone.querySelectorAll('input, select, textarea').forEach(el => {
                const val = el.value || el.innerText || '';
                const span = document.createElement('span');
                span.innerText = val;
                span.style.fontWeight = '600';
                el.parentNode.replaceChild(span, el);
            });

            // Create wrapper with header
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'padding: 20px; background: white; color: #1e293b; font-family: Inter, sans-serif;';

            // Add header with logo/title
            const header = document.createElement('div');
            header.style.cssText = 'text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 2px solid var(--primary);';
            header.innerHTML = `
                <h1 style="margin: 0; font-size: 24px; color: var(--primary);">Zain Performance Scorecard</h1>
                <p style="margin: 10px 0 0; font-size: 12px; color: #64748b;">Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
            `;
            wrapper.appendChild(header);
            wrapper.appendChild(clone);

            // Add footer
            const footer = document.createElement('div');
            footer.style.cssText = 'text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 10px; color: #94a3b8;';
            footer.innerHTML = 'Zain Iraq Performance Management System  ' + new Date().getFullYear();
            wrapper.appendChild(footer);

            // PDF options
            const opt = {
                margin: [10, 10, 10, 10],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait'
                },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            try {
                await html2pdf().set(opt).from(wrapper).save();
                showToast('PDF downloaded successfully!', 'success');
            } catch (e) {
                console.error('PDF export error:', e);
                showToast('Failed to generate PDF.', 'error');
            }
        }

        // --- KEYBOARD SHORTCUTS ---
        let shortcutsModalOpen = false;

        function initKeyboardShortcuts() {
            document.addEventListener('keydown', handleKeyboardShortcut);
        }

        function handleKeyboardShortcut(e) {
            // Ignore if typing in an input
            if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) return;

            // Ignore if modifier keys (except for specific combos)
            const key = e.key.toLowerCase();

            // Escape - close any modal/panel
            if (e.key === 'Escape') {
                closeNotifications();
                closeShortcutsModal();
                try { closeConfirm(); } catch (err) { }
                try { closeGoalModal(); } catch (err) { }
                try { closeUserModal(); } catch (err) { }
                return;
            }

            // ? or Shift+/ - Show shortcuts help
            if (key === '?' || (e.shiftKey && key === '/')) {
                e.preventDefault();
                toggleShortcutsModal();
                return;
            }

            // D - Toggle dark mode
            if (key === 'd' && !e.ctrlKey && !e.metaKey) {
                toggleTheme();
                return;
            }

            // N - Toggle notifications
            if (key === 'n' && !e.ctrlKey && !e.metaKey) {
                toggleNotifications();
                return;
            }

            // S - Save (if on scorecard)
            if (key === 's' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                if (typeof saveDraft === 'function') {
                    saveDraft();
                    showToast('Saved!', 'success');
                }
                return;
            }

            // Navigation shortcuts (1-5 for main sections)
            const navItems = document.querySelectorAll('.nav-item');
            if (key >= '1' && key <= '9') {
                const idx = parseInt(key) - 1;
                if (navItems[idx]) {
                    navItems[idx].click();
                }
                return;
            }
        }

        function toggleShortcutsModal() {
            if (shortcutsModalOpen) {
                closeShortcutsModal();
            } else {
                openShortcutsModal();
            }
        }

        function openShortcutsModal() {
            if (document.getElementById('shortcuts-modal')) return;

            const modal = document.createElement('div');
            modal.id = 'shortcuts-modal';
            modal.style.cssText = `
                position: fixed; inset: 0; background: rgba(0,0,0,0.5);
                display: flex; justify-content: center; align-items: center;
                z-index: 10000; backdrop-filter: blur(4px); animation: fadeIn 0.2s ease;
            `;
            modal.onclick = (e) => { if (e.target === modal) closeShortcutsModal(); };

            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 16px; padding: 32px; max-width: 420px; 
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3); animation: scaleIn 0.25s ease;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <h3 style="margin:0; font-size:1.25rem; color:var(--text-main);">
                            <i class="fa-solid fa-keyboard" style="color:var(--primary); margin-right:10px;"></i>
                            Keyboard Shortcuts
                        </h3>
                        <button onclick="closeShortcutsModal()" style="background:none; border:none; cursor:pointer; 
                                font-size:1.25rem; color:var(--text-muted);">&times;</button>
                    </div>
                    <div style="display:grid; gap:12px;">
                        <div class="shortcut-row"><kbd>?</kbd> <span>Show this help</span></div>
                        <div class="shortcut-row"><kbd>D</kbd> <span>Toggle dark mode</span></div>
                        <div class="shortcut-row"><kbd>N</kbd> <span>Toggle notifications</span></div>
                        <div class="shortcut-row"><kbd>1-5</kbd> <span>Navigate to section</span></div>
                        <div class="shortcut-row"><kbd>Ctrl+S</kbd> <span>Save scorecard</span></div>
                        <div class="shortcut-row"><kbd>Esc</kbd> <span>Close modal/panel</span></div>
                    </div>
                    <div style="margin-top:24px; padding-top:16px; border-top:1px solid var(--border); 
                                text-align:center; color:var(--text-muted); font-size:0.85rem;">
                        Press <kbd>Esc</kbd> to close
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            shortcutsModalOpen = true;
        }

        function closeShortcutsModal() {
            const modal = document.getElementById('shortcuts-modal');
            if (modal) modal.remove();
            shortcutsModalOpen = false;
        }

        // Initialize shortcuts when app loads
        document.addEventListener('DOMContentLoaded', initKeyboardShortcuts);


        // --- 1. SECURE CONFIGURATION ---
        // --- 1. SECURE CONFIGURATION ---
        // REPLACE THIS with your actual Railway PHP URL
        const API_URL = 'https://pms-back-production-b693.up.railway.app';

        // SECURITY: XSS Protection Helper - defined early so it's available everywhere
        function escapeHTML(str) {
            if (!str) return "";
            return str.toString().replace(/[&<>'"]/g,
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag]));
        }

        // REPLACE THIS with the "API_SECRET" you set in Railway Variables
        // Shared Headers Helper (Ensures every request is authorized)
        // REPLACE THIS BLOCK
        const API_HEADERS = {
            'Content-Type': 'application/json',
            get 'Authorization'() {
                return 'Bearer ' + (localStorage.getItem('zpms_token') || sessionStorage.getItem('zpms_token') || '');
            }
        };

        // --- SECURITY: TOKEN ROTATION ---
        const TOKEN_ROTATION_INTERVAL = 15 * 60 * 1000; // 15 minutes
        let lastTokenRotation = Date.now();

        async function rotateToken() {
            const currentToken = localStorage.getItem('zpms_token') || sessionStorage.getItem('zpms_token');
            if (!currentToken) return;

            try {
                const res = await fetch(`${API_URL}?action=rotateToken`, {
                    method: 'POST',
                    headers: API_HEADERS,
                    body: JSON.stringify({ token: currentToken })
                });

                if (res.ok) {
                    const data = await res.json();
                    if (data.token) {
                        localStorage.setItem('zpms_token', data.token);
                        sessionStorage.setItem('zpms_token', data.token);
                        lastTokenRotation = Date.now();
                        logActivity('TOKEN_ROTATED', 'Session token rotated');
                    }
                }
            } catch (e) {
                console.warn('Token rotation failed:', e);
            }
        }

        function checkTokenRotation() {
            if (Date.now() - lastTokenRotation > TOKEN_ROTATION_INTERVAL) {
                rotateToken();
            }
        }

        // Check for token rotation on user activity
        document.addEventListener('click', () => {
            localStorage.setItem('zpms_time', Date.now()); // Update idle timer
            checkTokenRotation();
        });

        // --- SECURITY: ACTIVITY LOGGING ---
        const activityLog = [];
        const MAX_LOG_ENTRIES = 100;

        function logActivity(action, details = '', targetId = null) {
            const entry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                targetId: targetId,
                userId: localStorage.getItem('zpms_uid') || 'unknown',
                sessionId: (localStorage.getItem('zpms_token') || sessionStorage.getItem('zpms_token'))?.slice(-8) || 'none'
            };

            activityLog.unshift(entry);

            // Keep log size manageable
            if (activityLog.length > MAX_LOG_ENTRIES) {
                activityLog.pop();
            }

            // Store in sessionStorage for persistence during session
            try {
                sessionStorage.setItem('zpms_activity_log', JSON.stringify(activityLog.slice(0, 50)));
            } catch (e) { /* Storage full, ignore */ }

            // Send critical events to server
            if (['LOGIN', 'LOGOUT', 'SUBMIT', 'APPROVE', 'REJECT', 'PUBLISH'].includes(action)) {
                sendActivityToServer(entry);
            }
        }

        async function sendActivityToServer(entry) {
            try {
                await fetch(`${API_URL}?action=logActivity`, {
                    method: 'POST',
                    headers: API_HEADERS,
                    body: JSON.stringify(entry)
                });
            } catch (e) {
                console.warn('Failed to log activity:', e);
            }
        }

        function getActivityLog() {
            return activityLog;
        }

        function showActivityLog() {
            const log = getActivityLog();
            console.table(log);
            return log;
        }

        // Load any existing log from session
        try {
            const savedLog = sessionStorage.getItem('zpms_activity_log');
            if (savedLog) {
                activityLog.push(...JSON.parse(savedLog));
            }
        } catch (e) { /* Invalid log, ignore */ }


        // --- 2. THE BRIDGE (Connects Frontend to PHP) ---
        const db = {
            from: (table) => {
                return {
                    select: (cols) => {
                        return {
                            // 1. Exact Match (Login, Profile)
                            eq: (col, val) => {
                                const execute = async () => {
                                    let action = (table === 'company_settings') ? 'getSettings' : 'checkID';
                                    if (action === 'getSettings' && !localStorage.getItem('zpms_token') && !sessionStorage.getItem('zpms_token')) {
                                        return { data: null, error: null };
                                    }

                                    try {
                                        const res = await fetch(`${API_URL}?action=${action}`, {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': API_HEADERS.Authorization // Access the getter
                                            },
                                            body: JSON.stringify({ id: val })
                                        });
                                        
                                        // Handle session expiry gracefully
                                        if (res.status === 401 || res.status === 403) {
                                            handleSessionExpired();
                                            return { data: null, error: { message: "Session expired" } };
                                        }
                                        
                                        if (!res.ok) return { data: null, error: { message: "Server Error: " + res.status } };
                                        return { data: await res.json(), error: null };
                                    } catch (e) { return { data: null, error: e }; }
                                };
                                return {
                                    then: (resolve, reject) => execute().then(resolve, reject),
                                    single: async () => {
                                        const r = await execute();
                                        // Backend checkID/getSettings already returns a single object, but we ensure safety
                                        if (r.data && Array.isArray(r.data)) r.data = r.data.length ? r.data[0] : null;
                                        return r;
                                    },
                                    maybeSingle: async () => {
                                        const r = await execute();
                                        if (r.data && Array.isArray(r.data)) r.data = r.data.length ? r.data[0] : null;
                                        return r;
                                    }
                                };
                            },

                            // 2. Range (Directory) - Note: This just wraps the fetchAll logic if called via db
                            range: async (from, to) => {
                                try {
                                    const res = await fetch(`${API_URL}?action=fetchAll&from=${from}&to=${to}`, {
                                        headers: API_HEADERS
                                    });
                                    if (res.status === 401 || res.status === 403) {
                                        handleSessionExpired();
                                        return { data: [], error: { message: "Session expired" } };
                                    }
                                    return { data: await res.json(), error: null };
                                } catch (e) { return { data: [], error: e }; }
                            },

                            // 3. Limit (Column Mapping)
                            limit: async (n) => {
                                const res = await fetch(`${API_URL}?action=fetchAll&from=0&to=1`, {
                                    headers: API_HEADERS
                                });
                                if (res.status === 401 || res.status === 403) {
                                    handleSessionExpired();
                                    return { data: [], error: { message: "Session expired" } };
                                }
                                return { data: await res.json(), error: null };
                            },

                            // 4. OR Filter (Team Loading - Client Side Filtering)
                            // Since backend fetchAll is secured, we fetch all and filter in memory for complex logic
                            or: async (filterStr) => {
                                try {
                                    // Reuse the robust fetchAllData logic if possible, or do a simplified fetch
                                    // For safety, we fetch the relevant rows. Ideally, fetchAllData() is used instead.
                                    // This implements a basic filter on the full dataset for compatibility.
                                    if (typeof allCompanyData === 'undefined' || allCompanyData.length === 0) {
                                        return { data: [], error: { message: "Data not synced" } };
                                    }

                                    // Parse conditions: "manager_id.ilike.%123%"
                                    const conditions = filterStr.split(',');

                                    const filtered = allCompanyData.filter(row => {
                                        return conditions.some(cond => {
                                            const parts = cond.split('.');
                                            if (parts.length < 3) return false;

                                            const col = parts[0];
                                            const val = parts[2].replace(/%/g, '').toLowerCase();
                                            const rowVal = (row[col] || '').toString().toLowerCase();

                                            return rowVal.includes(val);
                                        });
                                    });

                                    return { data: filtered, error: null };
                                } catch (e) { return { data: [], error: e }; }
                            }
                        };
                    },

                    // Handle Writes (Upsert)
                    upsert: async (payload) => {
                        const action = Array.isArray(payload) ? 'bulkUpsert' : (table === 'company_settings' ? 'saveSettings' : 'saveUser');
                        try {
                            const res = await fetch(`${API_URL}?action=${action}`, {
                                method: 'POST',
                                headers: API_HEADERS,
                                body: JSON.stringify({ payload: payload })
                            });
                            if (res.status === 401 || res.status === 403) {
                                handleSessionExpired();
                                return { error: { message: "Session expired" } };
                            }
                            if (!res.ok) {
                                const errText = await res.text();
                                return { error: { message: errText || "Save failed" } };
                            }
                            return { error: null };
                        } catch (e) { return { error: e }; }
                    },

                    // Handle Updates (Re-uses saveUser logic)
                    update: (payload) => {
                        return {
                            eq: async (col, val) => {
                                // For single update
                                try {
                                    const res = await fetch(`${API_URL}?action=saveUser`, {
                                        method: 'POST',
                                        headers: API_HEADERS,
                                        body: JSON.stringify({ id: val, payload: payload })
                                    });
                                    if (res.status === 401 || res.status === 403) {
                                        handleSessionExpired();
                                        return { error: { message: "Session expired" } };
                                    }
                                    if (!res.ok) {
                                        const txt = await res.text();
                                        return { error: { message: txt || "Update failed" } };
                                    }
                                    return { error: null };
                                } catch (e) { return { error: e }; }
                            },
                            in: async (col, valArray) => {
                                // For bulk status updates (Approve/Publish)
                                for (const id of valArray) {
                                    const res = await fetch(`${API_URL}?action=saveUser`, {
                                        method: 'POST',
                                        headers: API_HEADERS,
                                        body: JSON.stringify({ id: id, payload: payload })
                                    });
                                    if (res.status === 401 || res.status === 403) {
                                        handleSessionExpired();
                                        return { error: { message: "Session expired" } };
                                    }
                                }
                                return { error: null };
                            }
                        };
                    },

                    // Handle Deletes
                    delete: () => {
                        return {
                            eq: async (col, val) => {
                                try {
                                    // Determine action based on the table name
                                    const action = (table === 'company_settings') ? 'deleteSettings' : 'deleteUser';

                                    const res = await fetch(`${API_URL}?action=${action}`, {
                                        method: 'POST',
                                        headers: API_HEADERS,
                                        body: JSON.stringify({ id: val })
                                    });
                                    if (res.status === 401 || res.status === 403) {
                                        handleSessionExpired();
                                        return { error: { message: "Session expired" } };
                                    }
                                    return { error: res.ok ? null : { message: "Delete failed" } };
                                } catch (e) { return { error: e }; }
                            }
                        };
                    }
                };
            },
            // RPC Calls (Publishing Goals)
            rpc: async (name, params) => {
                if (name === 'publish_goals') {
                    try {
                        const res = await fetch(`${API_URL}?action=rpcPublish`, {
                            method: 'POST',
                            headers: API_HEADERS,
                            body: JSON.stringify({ payload: params })
                        });
                        if (res.status === 401 || res.status === 403) {
                            handleSessionExpired();
                            return { error: { message: "Session expired" } };
                        }
                        return { error: res.ok ? null : { message: "RPC failed" } };
                    } catch (e) { return { error: e }; }
                }
            }
        };
        // --- OTP AUTHENTICATION SYSTEM ---

        let generatedOTP = null;

        function focusNext(el) {
            if (el.value.length === 1) {
                const next = el.nextElementSibling;
                if (next) next.focus();
            }
        }

        async function triggerOTP() {
            // 1. Generate a mock code (In production, your backend sends this)
            generatedOTP = Math.floor(1000 + Math.random() * 9000).toString();
            // For testing purposes

            // 2. Simulate sending (Show loading)
            const btn = document.getElementById('btn-login');
            const originalText = btn.innerText;
            btn.innerText = "Sending Code...";
            btn.disabled = true;

            await new Promise(r => setTimeout(r, 1500)); // Fake network delay

            // 3. Show OTP Modal
            document.getElementById('otp-modal').style.display = 'flex';

            // 4. Focus first input
            setTimeout(() => document.querySelector('.otp-digit').focus(), 100);

            // Reset Login Button
            btn.innerText = originalText;
            btn.disabled = false;

            showToast(`Code sent to registered contact.`, 'info');
        }

        function verifyOTP() {
            // 1. Collect inputs
            const inputs = document.querySelectorAll('.otp-digit');
            let enteredCode = '';
            inputs.forEach(i => enteredCode += i.value);

            // 2. Validate
            if (enteredCode.length < 4) {
                showToast("Please enter the full 4-digit code.", "error");
                return;
            }

            if (enteredCode === generatedOTP) { // 0000 is a master backdoor for testing
                showToast("Identity Verified!", "success");
                document.getElementById('otp-modal').style.display = 'none';
                completeLoginProcess(); // Proceed to actual login
            } else {
                showToast("Invalid Code. Please try again.", "error");
                inputs.forEach(i => { i.value = ''; i.style.borderColor = '#ef4444'; });
                inputs[0].focus();
            }
        }

        function resendOTP() {
            triggerOTP();
            document.querySelectorAll('.otp-digit').forEach(i => i.value = '');
        }
        const IDLE_LIMIT = 3600000;
        const MASTER_ADMIN_TITLE = "Head of Employee Growth and Relation Department";
        const SHARED_GOALS_ID = 'shared_goals_v1';

        // --- DATA ---
        const defaultIndivGoals = [
            { title: "Functional Objective 1", weight: 0.40, desc: "", rating: 0, targets: ["", "", "", "", "", ""] },
            { title: "Functional Objective 2", weight: 0.30, desc: "", rating: 0, targets: ["", "", "", "", "", ""] },
            { title: "Development Objective", weight: 0.30, desc: "", rating: 0, targets: ["", "", "", "", "", ""] }
        ];
        const ratingLabels = { 1: "IDLE", 2: "STAGNANT", 3: "WALKER", 4: "RUNNER", 5: "FLYER", 6: "ASTRONAUT" };

        let user, targetUser, isManager, isDirectSupervisor, isRegistering, isAdminSearchMode;
        let masterData = { rating: 0, goals: [] };
        let hasDraft = false;
        let saveTimer;
        let chart1, chartAdmin, chartOrg;
        
        // --- CYCLE MANAGEMENT ---
        let currentCycle = '2025';
        let availableCycles = [];
        let cycleInitialized = false;
        
        const COL = {
            id: 'id',
            name: 'name',
            lvl: 'level',       // This fixes "undefined" in the sidebar
            job: 'job',
            div: 'division',
            dept: 'department',
            mgr: 'manager_id',  // This fixes the "-" Manager Name
            stat: 'status',
            goals: 'goals',
            role: 'access_role',
            email: 'email',
            phone: 'phone_number',
            pass: 'password',
            cycle: 'cycle'
        };
        let adminCache = [];
        let allCompanyData = [];
        let globalReports = [];
        // --- EXISTING VARIABLES ---
        let draftSaveTimer; // <--- ADD THIS NEW VARIABLE for Shared Goals
        
        // --- CYCLE HELPER FUNCTIONS ---
        async function loadCycles() {
            try {
                const res = await fetch(`${API_URL}?action=getCycles`, {
                    method: 'POST',
                    headers: API_HEADERS
                });
                const data = await res.json();
                if (data.cycles) {
                    availableCycles = data.cycles;
                    currentCycle = data.current || '2025';
                    cycleInitialized = true;
                }
            } catch (e) {
                console.log('Cycle support not initialized, using default 2025');
                currentCycle = '2025';
                availableCycles = [{ cycle: '2025', status: 'active' }];
            }
        }

        async function initCycleSupport() {
            try {
                const res = await fetch(`${API_URL}?action=initCycleSupport`, {
                    method: 'POST',
                    headers: API_HEADERS
                });
                const data = await res.json();
                if (data.success) {
                    showToast('Cycle support initialized successfully', 'success');
                    await loadCycles();
                    return true;
                } else {
                    showToast(data.error || 'Failed to initialize cycle support', 'error');
                    return false;
                }
            } catch (e) {
                console.error('Init cycle error:', e);
                showToast('Failed to initialize cycle support', 'error');
                return false;
            }
        }

        async function switchCycle(cycle) {
            if (cycle === currentCycle) return;
            
            showSaving();
            try {
                const res = await fetch(`${API_URL}?action=switchCycle`, {
                    method: 'POST',
                    headers: API_HEADERS,
                    body: JSON.stringify({ cycle })
                });
                const data = await res.json();
                if (data.success) {
                    currentCycle = cycle;
                    // Clear cache and reload data for new cycle
                    clearDataCache();
                    allCompanyData = await fetchAllData(true);
                    
                    // Load shared goals for this cycle
                    const sgId = cycle === '2025' ? SHARED_GOALS_ID : 'shared_goals_' + cycle;
                    const { data: sg } = await db.from('company_settings').select('data').eq('id', sgId).single();
                    if (sg && sg.data) {
                        masterData = Array.isArray(sg.data) ? { rating: 0, goals: sg.data } : sg.data;
                    } else {
                        masterData = { rating: 0, goals: [] };
                    }
                    
                    showToast(`Switched to ${cycle} cycle`, 'success');
                    // Reload current view
                    const role = getRole(user);
                    if (role === 'Admin' || role === 'Master') loadHRAdmin();
                } else {
                    showToast(data.error || 'Failed to switch cycle', 'error');
                }
            } catch (e) {
                console.error('Switch cycle error:', e);
                showToast('Failed to switch cycle', 'error');
            }
            showSaved();
        }

        async function startNewCycle(newCycle) {
            if (!newCycle || !/^\d{4}$/.test(newCycle)) {
                showToast('Invalid cycle year. Use 4-digit year (e.g., 2026)', 'error');
                return false;
            }

            showSaving();
            try {
                const res = await fetch(`${API_URL}?action=startNewCycle`, {
                    method: 'POST',
                    headers: API_HEADERS,
                    body: JSON.stringify({ cycle: newCycle })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(`Cycle ${newCycle} created successfully!`, 'success');
                    await loadCycles();
                    currentCycle = newCycle;
                    clearDataCache();
                    allCompanyData = await fetchAllData(true);
                    masterData = { rating: 0, goals: [] };
                    loadHRAdmin();
                    return true;
                } else {
                    showToast(data.error || 'Failed to create new cycle', 'error');
                    return false;
                }
            } catch (e) {
                console.error('Start new cycle error:', e);
                showToast('Failed to create new cycle', 'error');
                return false;
            } finally {
                showSaved();
            }
        }

        async function getEmployeeHistory(empId) {
            try {
                const res = await fetch(`${API_URL}?action=getEmployeeHistory`, {
                    method: 'POST',
                    headers: API_HEADERS,
                    body: JSON.stringify({ id: empId })
                });
                const data = await res.json();
                return data.history || [];
            } catch (e) {
                console.error('Get employee history error:', e);
                return [];
            }
        }

        // --- 2. INIT ---
        window.onload = async function () {
            // OPTIMIZATION: Load settings, column mapping, and cycles in parallel
            const [_, settingsResult] = await Promise.all([
                mapColumns(),
                db.from('company_settings').select('data').eq('id', SHARED_GOALS_ID).single(),
                loadCycles()
            ]);
            
            const sg = settingsResult.data;
            if (sg && sg.data) {
                if (Array.isArray(sg.data)) masterData = { rating: 0, goals: sg.data }; else masterData = sg.data;
            } else { masterData = { rating: 0, goals: [] }; }

            const uid = localStorage.getItem('zpms_uid');
            if (uid && (Date.now() - localStorage.getItem('zpms_time') < IDLE_LIMIT)) restoreSession(uid);
            else showLogin();
        }

        async function mapColumns() {
            // FUNCTION DISABLED:
            // We are using the hardcoded COL object above because
            // the database schema is now fixed and lowercase.
            console.log("Using hardcoded column mapping.");
            return;
        }

        async function loadHRApprovals() {
            const contentDiv = document.getElementById('admin-content');
            contentDiv.innerHTML = `
        <div style="padding:60px; text-align:center; color:var(--text-muted);">
            <div class="spinner" style="width:30px; height:30px; border-width:3px; margin-bottom:10px;"></div>
            <div>Syncing Approval & History Records...</div>
        </div>`;

            try {
                // --- FIX: Always fetch fresh data for the Admin Queue ---
                // This ensures that if you approved/returned something, the list reflects reality.
                allCompanyData = await fetchAllData();

                // Filter for Approval Queue + History
                adminCache = allCompanyData.filter(u => {
                    const s = (u[COL.stat] || '').trim();
                    return ['Submitted to HR', 'Approved', 'Published'].includes(s);
                });

                const totalCount = adminCache.length;
                const pendingCount = adminCache.filter(u => u[COL.stat] === 'Submitted to HR').length;
                const readyCount = adminCache.filter(u => u[COL.stat] === 'Approved').length;

                // Unique Divisions
                const divs = [...new Set(adminCache.map(i => i[COL.div] || 'Other'))].sort();

                // 2. Render UI with TWO Filters (Status & Division)
                contentDiv.innerHTML = `
        <div class="animate-in">
            <div class="card" style="padding: 32px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 20px;">
                    
                    <div>
                        <h3 style="margin: 0 0 8px 0; font-size: 1.25rem; font-weight: 800; color: var(--text-main);">
                            Approvals & History
                        </h3>
                        <div style="display:flex; gap:12px; align-items:center;">
                            
                            <select id="status-filter" onchange="filterAdminTable()" 
                                style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: #fff; font-weight: 700; color: var(--text-main); cursor: pointer; min-width: 160px; box-shadow:0 1px 2px rgba(0,0,0,0.05);">
                                <option value="ACTION"> Pending Action (${pendingCount})</option>
                                <option value="Approved"> Ready to Publish (${readyCount})</option>
                                <option value="Published"> Published History</option>
                                <option value="ALL">Show All Records</option>
                            </select>

                            <select id="div-filter" onchange="filterAdminTable()" 
                                style="padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border); background: #f9fafb; font-weight: 600; color: var(--text-muted); cursor: pointer; min-width: 150px;">
                                <option value="ALL">All Divisions</option>
                                ${divs.map(d => `<option value="${d}">${d}</option>`).join('')}
                            </select>
                        </div>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="approveBulk()" style="background:var(--primary); padding:10px 20px;">
                            <i class="fa-solid fa-check"></i> &nbsp; Approve Pending
                        </button>
                        <button class="btn btn-primary" onclick="publishBulk()" style="background:#10b981; border-color:#10b981; padding:10px 20px;">
                            <i class="fa-solid fa-rocket"></i> &nbsp; Publish Ready
                        </button>
                    </div>
                </div>

                <div style="overflow-x: auto; border:1px solid var(--border); border-radius:12px;">
                    <table class="report-table" style="margin:0;">
                        <thead style="background:#f8fafc;">
                            <tr>
                                <th style="padding:16px 24px;">EMPLOYEE</th>
                                <th style="padding:16px 24px;">STATUS</th>
                                <th style="padding:16px 24px;">DIVISION</th>
                                <th style="padding:16px 24px;">MANAGER</th>
                                <th style="padding:16px 24px; text-align:right;">CONTROLS</th>
                            </tr>
                        </thead>
                        <tbody id="admin-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>`;

                // 3. Render Rows
                filterAdminTable();

            } catch (e) {
                console.error(e);
                contentDiv.innerHTML = `<div style="color:red; padding:20px;">Error: ${escapeHTML(e.message)}</div>`;
            }
        }
        async function restoreSession(id) {
            const { data } = await db.from('active_list').select('*').eq(COL.id, id).single();
            if (data) { user = data; startIdleTimer(); launchApp(); } else showLogin();
        }

        function showLogin() { document.getElementById('loading-overlay').classList.add('hidden'); document.getElementById('login-screen').classList.remove('hidden'); }
        function startIdleTimer() { ['click', 'keydown'].forEach(e => window.addEventListener(e, () => localStorage.setItem('zpms_time', Date.now()))); }
        function logout() { localStorage.clear(); sessionStorage.clear(); location.reload(); }

        // --- 3. AUTH & ROUTING ---
        // --- NEW SECURE LOGIN LOGIC ---

        async function checkID() {
            const id = document.getElementById('inp-id').value.trim();
            const btn = document.getElementById('btn-check');
            if (!id) {
                showToast("Please enter your Employee ID", "error");
                return;
            }

            btn.innerText = "Checking...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}?action=checkID`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id }) });
                const data = await res.json();

                if (data && data.id) {
                    user = data;
                    if (data.needs_setup) {
                        // Show Create Password UI
                        document.getElementById('lbl-welcome').innerText = "Create Your Password";
                        document.getElementById('grp-confirm').classList.remove('hidden');
                    } else {
                        // Show Standard Login UI
                        document.getElementById('lbl-welcome').innerText = "Welcome Back";
                        document.getElementById('grp-confirm').classList.add('hidden');
                    }

                    user = data;
                    document.getElementById('view-id').classList.add('hidden');
                    document.getElementById('view-pass').classList.remove('hidden');

                    // --- NEW: Detect if user needs to create a password ---
                    if (data.needs_setup) {
                        document.getElementById('lbl-welcome').innerText = "Create Your Password";
                        document.getElementById('grp-confirm').classList.remove('hidden');
                        document.getElementById('btn-login').innerText = "Set Password & Login";
                    } else {
                        document.getElementById('lbl-welcome').innerText = "Welcome Back";
                        document.getElementById('grp-confirm').classList.add('hidden');
                        document.getElementById('btn-login').innerText = "Log In";
                    }
                } else {
                    // ID not found - show error message
                    showToast("Employee ID not found. Please check and try again.", "error");
                    btn.innerText = "Continue";
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                showToast("Connection error. Please try again.", "error");
                btn.innerText = "Continue";
                btn.disabled = false;
            }
        }
        async function doLogin() {
            const p1 = document.getElementById('inp-pass').value;
            const p2 = document.getElementById('inp-confirm').value;
            const btn = document.getElementById('btn-login');

            if (!document.getElementById('grp-confirm').classList.contains('hidden')) {
                if (p1.length < 4) { showToast("Password too short", "error"); return; }
                if (p1 !== p2) { showToast("Passwords do not match", "error"); return; }
            }

            btn.innerText = "Verifying...";
            btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}?action=login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: user.id || document.getElementById('inp-id').value,
                        password: p1
                    })
                });


                const result = await res.json();

                if (result.success) {
                    localStorage.setItem('zpms_token', result.token);
                    sessionStorage.setItem('zpms_token', result.token); // Keep for backward compatibility
                    localStorage.setItem('zpms_uid', result.user.id);
                    localStorage.setItem('zpms_time', Date.now());
                    document.getElementById('loading-overlay').classList.remove('hidden');
                    location.reload();
                } else {
                    document.getElementById('err-pass').style.display = 'block';
                    document.getElementById('err-pass').innerText = result.message || "Incorrect Password";
                    btn.innerText = "Log In";
                    btn.disabled = false;
                }
            } catch (e) {
                console.error(e);
                showToast("Server connection failed", "error");
                btn.innerText = "Log In";
                btn.disabled = false;
            }
        }
        // Separate function for the final step
        function completeLoginProcess() {
            localStorage.setItem('zpms_uid', user[COL.id]);
            localStorage.setItem('zpms_time', Date.now());

            document.getElementById('loading-overlay').classList.remove('hidden');
            location.reload();
        }
        
        // --- DATA CACHE CONFIGURATION ---
        const DATA_CACHE_KEY = 'zpms_data_cache';
        const DATA_CACHE_TIME_KEY = 'zpms_data_cache_time';
        const DATA_CACHE_EXPIRY = 5 * 60 * 1000; // 5 minutes cache
        
        // --- BATCHED FETCH HELPER ---
        async function fetchAllData(forceRefresh = false) {
            // OPTIMIZATION: Check cache first
            if (!forceRefresh) {
                const cachedTime = parseInt(sessionStorage.getItem(DATA_CACHE_TIME_KEY) || '0');
                const cacheAge = Date.now() - cachedTime;
                
                if (cacheAge < DATA_CACHE_EXPIRY) {
                    try {
                        const cachedData = sessionStorage.getItem(DATA_CACHE_KEY);
                        if (cachedData) {
                            const parsed = JSON.parse(cachedData);
                            if (Array.isArray(parsed) && parsed.length > 0) {
                                console.log(`Using cached data (${parsed.length} records, ${Math.round(cacheAge/1000)}s old)`);
                                return parsed;
                            }
                        }
                    } catch (e) {
                        console.warn('Cache read error:', e);
                    }
                }
            }
            
            let allRows = [];
            let from = 0;
            const step = 5000; // Increased chunk size for speed
            const timestamp = Date.now();
            let retries = 0;
            const maxRetries = 3;

            // Grab UI elements to show progress
            const loaderText = document.querySelector('#loading-overlay div:last-child');
            const saveText = document.getElementById('save-text');

            while (true) {
                try {
                    // Update UI with progress
                    const msg = `Syncing Directory... (${allRows.length} loaded)`;
                    if (loaderText) loaderText.innerText = msg;
                    if (saveText) saveText.innerText = msg;

                    // Fetch with Cache Buster AND Headers
                    const res = await fetch(`${API_URL}?action=fetchAll&from=${from}&to=${from + step - 1}&_t=${timestamp}`, {
                        method: 'GET',
                        headers: API_HEADERS
                    });

                    if (!res.ok) {
                        if (res.status === 401 || res.status === 403) {
                            // Session expired or invalid - handle gracefully
                            handleSessionExpired();
                            return [];
                        }
                        throw new Error(`Server status: ${res.status}`);
                    }

                    const chunk = await res.json();

                    // Validation
                    if (!Array.isArray(chunk)) {
                        console.warn("Invalid chunk received:", chunk);
                        break;
                    }

                    if (chunk.length === 0) {
                        break;
                    }

                    // Success: Reset retries and append data
                    retries = 0;
                    allRows = allRows.concat(chunk);

                    // Optimization: If we got less than requested, we are at the end
                    if (chunk.length < step) break;

                    // Prepare next page
                    from += step;

                } catch (e) {
                    console.error(`Fetch error at offset ${from}:`, e);

                    if (e.message.includes("401") || e.message.includes("403")) {
                        handleSessionExpired();
                        return [];
                    }

                    if (retries < maxRetries) {
                        retries++;
                        const delay = retries * 1000;
                        if (loaderText) loaderText.innerText = `Network blip. Retrying batch ${from}... (${retries}/${maxRetries})`;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    } else {
                        alert("Connection unstable. Loaded partial data. Please refresh.");
                        break;
                    }
                }
            }

            // Final UI Cleanup
            if (loaderText) loaderText.innerText = "Initializing Zain Performance Management...";

            // --- SAVE TO SESSION CACHE (Speed Optimization) ---
            if (allRows.length > 0) {
                try {
                    sessionStorage.setItem(DATA_CACHE_KEY, JSON.stringify(allRows));
                    sessionStorage.setItem(DATA_CACHE_TIME_KEY, Date.now().toString());
                    console.log(`Cached ${allRows.length} records`);
                } catch (e) {
                    console.warn("Cache full, could not save data:", e);
                }
            }

            return allRows;
        }
        
        // --- SESSION EXPIRY HANDLER ---
        function handleSessionExpired() {
            // Only show message once
            if (sessionStorage.getItem('zpms_session_expired')) return;
            sessionStorage.setItem('zpms_session_expired', 'true');
            
            // Clear auth data
            localStorage.removeItem('zpms_token');
            localStorage.removeItem('zpms_uid');
            localStorage.removeItem('zpms_time');
            sessionStorage.removeItem('zpms_token');
            
            // Show friendly message
            showToast('Session expired. Please login again.', 'error');
            
            // Redirect to login after a short delay
            setTimeout(() => {
                location.reload();
            }, 1500);
        }
        
        // Helper function to force refresh data cache
        function clearDataCache() {
            sessionStorage.removeItem(DATA_CACHE_KEY);
            sessionStorage.removeItem(DATA_CACHE_TIME_KEY);
            allCompanyData = [];
            console.log('Data cache cleared');
        }

        function getCompany(id, division = "") {
            if (!id) return "Unknown";
            const cleanId = id.toString().toUpperCase().trim();
            const cleanDiv = (division || "").toString().toUpperCase().trim();

            // 1. Check ID Prefixes (Standard Method)
            if (cleanId.startsWith("HISP") || cleanId.startsWith("HCS") || cleanId.startsWith("HSC") || cleanId.startsWith("AWO")) {
                return "Horizon";
            }
            if (cleanId.startsWith("NG") || cleanId.startsWith("NGM") || cleanId.startsWith("NGT")) {
                return "Next Generation";
            }
            if (cleanId.startsWith("ZIQ") || cleanId.startsWith("ZIQT")) {
                // EDGE CASE: If ID is ZIQ but Division says "Next Gen", trust the Division
                if (cleanDiv.includes("NEXT GENERATION") || cleanDiv.includes("NXG")) {
                    return "Next Generation";
                }
                return "Zain Iraq";
            }

            // 2. Fallback: Check Division Name if ID is weird
            if (cleanDiv.includes("HORIZON")) return "Horizon";
            if (cleanDiv.includes("NEXT GENERATION")) return "Next Generation";
            if (cleanDiv.includes("ZAIN IRAQ")) return "Zain Iraq";

            return "Other";
        }
        async function launchApp() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-container').style.display = 'flex';
            try { } catch (e) { }
            document.getElementById('disp-user').innerText = user[COL.name];
            document.getElementById('disp-role').innerText = user[COL.lvl];

            // --- SPEED OPTIMIZATION START ---
            // 1. Try to load from session cache first (Instant Load)
            const cachedData = sessionStorage.getItem(DATA_CACHE_KEY);
            const cachedTime = parseInt(sessionStorage.getItem(DATA_CACHE_TIME_KEY) || '0');
            const cacheAge = Date.now() - cachedTime;
            
            if (cachedData && cacheAge < DATA_CACHE_EXPIRY) {
                try {
                    allCompanyData = JSON.parse(cachedData);
                    console.log(`Loaded from cache: ${allCompanyData.length} records (${Math.round(cacheAge/1000)}s old)`);
                } catch (e) {
                    console.error("Cache corrupted, reloading...");
                    allCompanyData = [];
                }
            }

            // 2. If cache is empty or expired, fetch from server
            if (allCompanyData.length === 0) {
                document.getElementById('save-text').innerText = "Syncing directory...";
                document.getElementById('save-status').classList.add('show');
                allCompanyData = await fetchAllData(true); // Force refresh
                document.getElementById('save-status').classList.remove('show');
            } else {
                // 3. If cache had data, refresh it in the BACKGROUND after 10 seconds
                setTimeout(() => {
                    fetchAllData(true).then(freshData => {
                        if (freshData.length > 0) {
                            allCompanyData = freshData;
                            console.log("Background sync finished");
                        }
                    });
                }, 10000); // Wait 10 seconds before background refresh
            }
            // --- SPEED OPTIMIZATION END ---

            let hasReports = false;
            const myId = user[COL.id].toString().toLowerCase();
            const myName = (user[COL.name] || "").toString().toLowerCase();

            hasReports = allCompanyData.some(u => {
                const m = (u[COL.mgr] || "").toString().toLowerCase();
                return m.includes(myId) || (myName.length > 3 && m.includes(myName));
            });

            const role = getRole(user, hasReports);
            renderNav(role);
            initNotifications(); // Initialize notification center

            // Check if we should auto-open a scorecard from URL parameter
            checkAutoOpenScorecard();

            if (role === 'Admin' || role === 'Master') loadHRAdmin();
            else if (role === 'Chief' || role === 'Director' || role === 'Senior Manager') loadReports();
            else if (role === 'Manager') loadTeam();
            else loadEval(user[COL.id]);
        }

        function triggerImport() { document.getElementById('file-import').click(); }

        function processFile(inp) {
            const file = inp.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                    if (json.length === 0) { alert("Empty Excel file"); return; }

                    function getVal(row, candidates) {
                        const keys = Object.keys(row);
                        const clean = (s) => s.toString().toLowerCase().trim().replace(/[^a-z0-9]/g, '');
                        for (let c of candidates) { const found = keys.find(k => clean(k) === clean(c)); if (found && row[found] !== undefined) return row[found]; }
                        if (candidates.includes("Target")) { const tKey = keys.find(k => { const c = clean(k); return c === 'l4' || c === 'target' || c === 'targets' || c.includes('runnertarget'); }); if (tKey && row[tKey] !== undefined) return row[tKey]; }
                        return "";
                    }

                    const newGoals = json.map(r => {
                        let w = getVal(r, ['Weight', 'Wt', 'W%']); w = parseFloat(w) || 0; if (w > 1) w = w / 100;
                        return {
                            title: getVal(r, ['Objective', 'Title', 'Item', 'Items', 'Goal', 'KPI']) || "Imported Goal",
                            weight: w,
                            desc: getVal(r, ['Description', 'Desc', 'Details']),
                            unit: getVal(r, ['Unit', 'UoM']),
                            rating: 0,
                            targets: [getVal(r, ['L1', '1']), getVal(r, ['L2', '2']), getVal(r, ['L3', '3']), getVal(r, ['Target', 'L4', 'Runner']), getVal(r, ['L5', '5']), getVal(r, ['L6', '6'])]
                        };
                    });

                    if (confirm(`Found ${newGoals.length} goals. This will REPLACE your current Individual Goals. Continue?`)) {
                        targetUser[COL.goals] = newGoals;
                        renderGoals(true);
                        calc();
                        autoSave();
                        alert(" Goals imported successfully!");
                    }
                    inp.value = '';
                } catch (err) { console.error(err); alert("Error reading Excel file. Check format."); }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- 5. MASTER ADMIN PORTAL ---


        async function loadHRAdmin() {
            document.getElementById('main-view').innerHTML = `
    <div class="animate-in">
        <div class="header-bar">
            <div>
                <h2 class="page-title">HR Portal</h2>
                <p class="page-sub">Master Administration & Analytics</p>
            </div>
        </div>
        
        <div class="card" style="padding: 0; margin-bottom: 32px; border-radius: 12px; background: white; overflow: hidden;">
            <div style="display: flex; overflow-x: auto; border-bottom: 1px solid var(--border);">
                <div class="admin-tab active" id="tab-shared" onclick="switchAdminTab('shared')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-bullseye"></i> <span>Shared Goals</span>
                </div>
                <div class="admin-tab" id="tab-directory" onclick="switchAdminTab('directory')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-address-book"></i> <span>Directory</span>
                </div>
                <div class="admin-tab" id="tab-kpi" onclick="switchAdminTab('kpi')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-gauge-high"></i> <span>KPI Dashboard</span>
                </div>
                <div class="admin-tab" id="tab-analytics" onclick="switchAdminTab('analytics')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-chart-pie"></i> <span>Analytics</span>
                </div>
                <div class="admin-tab" id="tab-app" onclick="switchAdminTab('app')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-list-check"></i> <span>Approvals</span>
                </div>
                <div class="admin-tab" id="tab-bulk" onclick="switchAdminTab('bulk')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-file-csv"></i> <span>Bulk Import</span>
                </div>
                <div class="admin-tab" id="tab-perm" onclick="switchAdminTab('perm')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-shield-halved"></i> <span>Admins</span>
                </div>
                <div class="admin-tab" id="tab-cycle" onclick="switchAdminTab('cycle')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-calendar-days"></i> <span>Cycles</span>
                </div>
                <div class="admin-tab" id="tab-search" onclick="switchAdminTab('search')" style="padding: 20px 24px; display: flex; align-items: center; gap: 10px; cursor: pointer;">
                    <i class="fa-solid fa-magnifying-glass"></i> <span>Search</span>
                </div>
            </div>
            
            <!-- Cycle Selector Badge -->
            <div style="margin-left:auto; display:flex; align-items:center; gap:12px;">
                <div style="font-size:0.8rem; color:var(--text-muted);">Current Cycle:</div>
                <select id="cycle-selector" onchange="switchCycle(this.value)" style="padding:8px 16px; border-radius:8px; border:2px solid var(--primary); background:var(--primary-light); font-weight:700; color:var(--primary); cursor:pointer;">
                    ${availableCycles.map(c => `<option value="${c.cycle}" ${c.cycle === currentCycle ? 'selected' : ''}>${c.cycle} ${c.status === 'active' ? '(Active)' : ''}</option>`).join('')}
                </select>
            </div>
        </div>

        <div id="admin-content" class="animate-in"></div>
    </div>
    `;

            // Ensure styles for the active tab match the screenshot (Blue Underline)
            const style = document.createElement('style');
            style.innerHTML = `
        .admin-tab { color: var(--text-muted); font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .admin-tab:hover { background: #f8fafc; color: var(--text-main); }
        .admin-tab.active { color: var(--primary); border-bottom: 3px solid var(--primary); background: var(--primary-light); }
        .admin-tab i { font-size: 1.1rem; }
    `;
            document.head.appendChild(style);

            // Default to Approvals if that is the focus, or Shared
            switchAdminTab('shared');
        }

        function switchAdminTab(t) {
            // 1. Update Visual Active State
            document.querySelectorAll('.admin-tab').forEach(btn => {
                btn.classList.remove('active');
                if (btn.id === 'tab-' + t) btn.classList.add('active');
            });

            // 2. Clear previous content to prevent mixing
            document.getElementById('admin-content').innerHTML = '<div class="spinner"></div>';

            // 3. Load the specific isolated view
            if (t === 'shared') loadAdminSharedGoals();      // Only Shared Goals
            else if (t === 'directory') loadAdminDirectory();
            else if (t === 'kpi') loadKPIDashboard();         // KPI Dashboard
            else if (t === 'analytics') loadAdminAnalytics();
            else if (t === 'app') loadHRApprovals();         // Only Pending Approvals
            else if (t === 'bulk') loadAdminBulk();
            else if (t === 'perm') loadAdminPerms();
            else if (t === 'cycle') loadCycleManagement();   // Cycle Management
            else if (t === 'search') loadAdminSearch();
        }
        
        // --- CYCLE MANAGEMENT TAB ---
        async function loadCycleManagement() {
            // Load cycles if not already loaded
            if (!cycleInitialized) await loadCycles();
            
            const content = `
            <div class="animate-in">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; flex-wrap:wrap; gap:16px;">
                        <div>
                            <h3 style="margin:0; font-size:1.2rem; font-weight:700;"><i class="fa-solid fa-calendar-days" style="color:var(--primary); margin-right:8px;"></i>Performance Cycle Management</h3>
                            <p style="color:var(--text-muted); font-size:0.9rem; margin-top:4px;">Manage performance review cycles and historical records.</p>
                        </div>
                        <button class="btn btn-primary" onclick="showNewCycleModal()">
                            <i class="fa-solid fa-plus"></i> &nbsp; Start New Cycle
                        </button>
                    </div>
                    
                    <!-- Current Cycle Info -->
                    <div style="background:linear-gradient(135deg, var(--primary), var(--primary-dark)); color:white; padding:24px; border-radius:16px; margin-bottom:24px;">
                        <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
                            <div>
                                <div style="font-size:0.8rem; opacity:0.8; text-transform:uppercase; letter-spacing:1px;">Active Cycle</div>
                                <div style="font-size:2.5rem; font-weight:800;">${currentCycle}</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-size:0.8rem; opacity:0.8;">Total Employees</div>
                                <div style="font-size:1.5rem; font-weight:700;">${allCompanyData.length}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Initialize Cycle Support (if needed) -->
                    ${!cycleInitialized ? `
                    <div style="background:#fef3c7; border:1px solid #fbbf24; padding:20px; border-radius:12px; margin-bottom:24px;">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <i class="fa-solid fa-triangle-exclamation" style="color:#d97706; font-size:1.5rem;"></i>
                            <div>
                                <div style="font-weight:700; color:#92400e;">Cycle Support Not Initialized</div>
                                <div style="font-size:0.9rem; color:#a16207;">Click below to enable multi-cycle support for your system.</div>
                            </div>
                            <button class="btn btn-primary" style="margin-left:auto; background:#d97706;" onclick="initCycleSupport().then(() => loadCycleManagement())">
                                <i class="fa-solid fa-bolt"></i> &nbsp; Initialize
                            </button>
                        </div>
                    </div>
                    ` : ''}

                    <!-- Cycles List -->
                    <h4 style="margin:0 0 16px 0; font-size:1rem; font-weight:700;">All Performance Cycles</h4>
                    <div style="overflow-x:auto; border:1px solid var(--border); border-radius:12px;">
                        <table class="report-table" style="margin:0;">
                            <thead style="background:#f8fafc;">
                                <tr>
                                    <th style="padding:16px 24px;">CYCLE YEAR</th>
                                    <th style="padding:16px 24px;">STATUS</th>
                                    <th style="padding:16px 24px;">EMPLOYEES</th>
                                    <th style="padding:16px 24px;">COMPLETION</th>
                                    <th style="padding:16px 24px; text-align:right;">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody id="cycles-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Historical Records Section -->
                <div class="card">
                    <h3 style="margin:0 0 16px 0; font-size:1.1rem; font-weight:700;"><i class="fa-solid fa-clock-rotate-left" style="color:var(--primary); margin-right:8px;"></i>Employee History Lookup</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">View an employee's performance history across all cycles.</p>
                    
                    <div style="display:flex; gap:12px; margin-bottom:20px;">
                        <input id="history-emp-id" class="login-input" style="margin:0; flex:1; max-width:300px;" placeholder="Enter Employee ID (e.g., ZIQ...)">
                        <button class="btn btn-primary" onclick="loadEmployeeHistoryView()">
                            <i class="fa-solid fa-search"></i> &nbsp; View History
                        </button>
                    </div>
                    
                    <div id="employee-history-results"></div>
                </div>
            </div>`;
            
            document.getElementById('admin-content').innerHTML = content;
            
            // Load cycles into table
            renderCyclesTable();
        }

        async function renderCyclesTable() {
            const tbody = document.getElementById('cycles-tbody');
            if (!tbody) return;
            
            if (availableCycles.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:40px; color:var(--text-muted);">No cycles found. Initialize cycle support to begin.</td></tr>`;
                return;
            }

            let rows = '';
            for (const cycle of availableCycles) {
                // Get stats for this cycle
                const cycleData = allCompanyData.filter(u => !u.cycle || u.cycle === cycle.cycle);
                const total = cycleData.length;
                const completed = cycleData.filter(u => ['Approved', 'Published'].includes(u[COL.stat])).length;
                const completionRate = total > 0 ? Math.round((completed / total) * 100) : 0;
                
                const isActive = cycle.status === 'active';
                const isCurrent = cycle.cycle === currentCycle;
                
                rows += `
                <tr>
                    <td style="font-weight:700; font-size:1.1rem;">
                        ${cycle.cycle}
                        ${isActive ? '<span style="background:var(--success); color:white; font-size:0.65rem; padding:2px 8px; border-radius:10px; margin-left:8px;">ACTIVE</span>' : ''}
                        ${isCurrent ? '<span style="background:var(--primary); color:white; font-size:0.65rem; padding:2px 8px; border-radius:10px; margin-left:8px;">VIEWING</span>' : ''}
                    </td>
                    <td>
                        <span style="background:${isActive ? '#d1fae5' : '#f1f5f9'}; color:${isActive ? '#059669' : '#64748b'}; padding:4px 12px; border-radius:20px; font-size:0.8rem; font-weight:600;">
                            ${isActive ? 'Active' : 'Archived'}
                        </span>
                    </td>
                    <td style="font-weight:600;">${total}</td>
                    <td>
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="flex:1; max-width:100px; height:8px; background:#e2e8f0; border-radius:4px; overflow:hidden;">
                                <div style="width:${completionRate}%; height:100%; background:${completionRate >= 80 ? 'var(--success)' : completionRate >= 50 ? 'var(--warning)' : 'var(--danger)'};"></div>
                            </div>
                            <span style="font-weight:600; font-size:0.9rem;">${completionRate}%</span>
                        </div>
                    </td>
                    <td style="text-align:right;">
                        ${!isCurrent ? `<button class="btn btn-outline" style="padding:6px 12px; font-size:0.8rem;" onclick="switchCycle('${cycle.cycle}')"><i class="fa-solid fa-eye"></i> View</button>` : `<span style="color:var(--text-muted); font-size:0.85rem;"><i class="fa-solid fa-check-circle"></i> Current</span>`}
                    </td>
                </tr>`;
            }
            
            tbody.innerHTML = rows;
        }

        function showNewCycleModal() {
            const currentYear = new Date().getFullYear();
            const nextYear = currentYear + 1;
            
            showConfirm(
                'Start New Performance Cycle',
                `This will create a new ${nextYear} cycle. All employee scorecards will be reset to "Draft" status with empty goals. The ${currentCycle} data will be preserved as historical records. Continue?`,
                `Create ${nextYear} Cycle`,
                'primary',
                () => startNewCycle(nextYear.toString())
            );
        }

        async function loadEmployeeHistoryView() {
            const empId = document.getElementById('history-emp-id').value.trim();
            if (!empId) {
                showToast('Please enter an Employee ID', 'error');
                return;
            }

            const resultsDiv = document.getElementById('employee-history-results');
            resultsDiv.innerHTML = '<div class="spinner" style="margin:20px auto;"></div>';

            try {
                const history = await getEmployeeHistory(empId);
                
                if (history.length === 0) {
                    resultsDiv.innerHTML = `
                        <div style="text-align:center; padding:40px; color:var(--text-muted);">
                            <i class="fa-solid fa-user-slash" style="font-size:2rem; opacity:0.3; margin-bottom:12px; display:block;"></i>
                            <div>No history found for Employee ID: <strong>${escapeHTML(empId)}</strong></div>
                        </div>`;
                    return;
                }

                const emp = history[0];
                let html = `
                    <div style="background:#f8fafc; padding:20px; border-radius:12px; margin-bottom:20px;">
                        <div style="font-size:1.2rem; font-weight:700;">${escapeHTML(emp.name || 'Unknown')}</div>
                        <div style="color:var(--text-muted); font-size:0.9rem;">${escapeHTML(emp.job || 'N/A')} | ${escapeHTML(emp.division || 'N/A')}</div>
                    </div>
                    
                    <div style="display:grid; gap:16px;">
                `;

                for (const record of history) {
                    const goals = typeof record.goals === 'string' ? JSON.parse(record.goals || '[]') : (record.goals || []);
                    const status = record.status || 'Draft';
                    const cycle = record.cycle || '2025';
                    
                    // Calculate score if goals exist
                    let score = 0;
                    if (goals.length > 0) {
                        const totalWeight = goals.reduce((sum, g) => sum + (parseFloat(g.weight) || 0), 0);
                        if (totalWeight > 0) {
                            score = goals.reduce((sum, g) => sum + ((parseFloat(g.rating) || 0) * (parseFloat(g.weight) || 0)), 0) / totalWeight;
                        }
                    }
                    
                    let rating = '-';
                    if (score >= 5.5) rating = 'ASTRONAUT';
                    else if (score >= 4.5) rating = 'FLYER';
                    else if (score >= 3.5) rating = 'RUNNER';
                    else if (score >= 2.5) rating = 'WALKER';
                    else if (score >= 1.5) rating = 'STAGNANT';
                    else if (score > 0) rating = 'IDLE';

                    html += `
                        <div style="background:white; border:1px solid var(--border); border-radius:12px; padding:20px; ${cycle === currentCycle ? 'border-left:4px solid var(--primary);' : ''}">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                                <div style="font-size:1.3rem; font-weight:800; color:var(--primary);">${cycle}</div>
                                <span style="background:${status === 'Published' ? '#d1fae5' : status === 'Approved' ? '#dbeafe' : '#f1f5f9'}; color:${status === 'Published' ? '#059669' : status === 'Approved' ? '#2563eb' : '#64748b'}; padding:4px 12px; border-radius:20px; font-size:0.75rem; font-weight:600;">
                                    ${escapeHTML(status)}
                                </span>
                            </div>
                            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px;">
                                <div>
                                    <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase;">Score</div>
                                    <div style="font-size:1.5rem; font-weight:800;">${score > 0 ? score.toFixed(2) : '-'}</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase;">Rating</div>
                                    <div style="font-size:1rem; font-weight:700;">${rating}</div>
                                </div>
                                <div>
                                    <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase;">Goals</div>
                                    <div style="font-size:1rem; font-weight:600;">${goals.length} objectives</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                html += '</div>';
                resultsDiv.innerHTML = html;
            } catch (e) {
                console.error('Error loading history:', e);
                resultsDiv.innerHTML = `<div style="color:var(--danger); padding:20px;">Error loading history: ${escapeHTML(e.message)}</div>`;
            }
        }
        // --- DIRECTORY TAB (ADD/EDIT/DELETE USERS) ---
        async function loadAdminDirectory() {
            if (allCompanyData.length === 0) allCompanyData = await fetchAllData();
            const content = `
            <div class="animate-in">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <div>
                            <h3 style="margin:0; font-size:1.2rem; font-weight:700;">Employee Directory</h3>
                            <p style="color:var(--text-muted); font-size:0.9rem;">Manage system users and access.</p>
                        </div>
                        <div style="display:flex; gap:12px;">
                            <button class="btn btn-outline" onclick="document.getElementById('file-users').click()"><i class="fa-solid fa-file-csv"></i> &nbsp; Bulk Import</button>
                            <button class="btn btn-primary" onclick="openUserModal()"><i class="fa-solid fa-plus"></i> &nbsp; Add Employee</button>
                        </div>
                    </div>
                   
                    <div style="margin-bottom:20px;">
                        <div class="search-box-container" style="position:relative;">
                            <i class="fa-solid fa-magnifying-glass" style="position:absolute; left:16px; top:50%; transform:translateY(-50%); color:var(--text-muted);"></i>
                            <input class="login-input" style="padding-left:42px; margin:0;" placeholder="Search by Name, ID, or Division..." onkeyup="searchDirectory(this.value)">
                        </div>
                    </div>

                    <div style="max-height:600px; overflow-y:auto; border-radius:12px; border:1px solid var(--border);">
                        <table class="report-table" id="dir-table" style="margin:0;">
                            <thead><tr><th>ID</th><th>Name</th><th>Job Title</th><th>Division</th><th>Manager</th><th style="text-align:right">Actions</th></tr></thead>
                            <tbody id="dir-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            document.getElementById('admin-content').innerHTML = content;
            renderDirectoryTable(allCompanyData.slice(0, 50)); // Initial render
        }

        function searchDirectory(q) {
            q = q.toLowerCase();
            const filtered = allCompanyData.filter(u =>
                (u[COL.id] || "").toLowerCase().includes(q) ||
                (u[COL.name] || "").toLowerCase().includes(q) ||
                (u[COL.div] || "").toLowerCase().includes(q)
            ).slice(0, 50);
            
            if (filtered.length === 0 && q.length > 0) {
                document.getElementById('dir-tbody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align:center; padding:40px; color:var(--text-muted);">
                            <i class="fa-solid fa-user-slash" style="font-size:2rem; opacity:0.3; margin-bottom:12px; display:block;"></i>
                            <div style="font-weight:600;">No Employee Found</div>
                            <div style="font-size:0.85rem; margin-top:4px;">No results matching "${escapeHTML(q)}"</div>
                        </td>
                    </tr>`;
                showToast("No employee found matching your search", "error");
                return;
            }
            
            renderDirectoryTable(filtered);
        }

        // Replace hardcoded property names with COL mapping
        function renderDirectoryTable(list) {
            document.getElementById('dir-tbody').innerHTML = list.map(u => `
    <tr>
        <td style="font-weight:700;">${u[COL.id] || '-'}</td>
        <td style="font-weight:600;">${u[COL.name] || 'No Name'}</td>
        <td>${u[COL.job] || '-'}</td>
        <td>${u[COL.div] || '-'}</td>
        <td>${u[COL.mgr] || '-'}</td>
        <td style="text-align:right;">
            <button class="btn btn-outline" onclick="openUserModal('${u[COL.id]}')"><i class="fa-solid fa-pen"></i></button>
            <button class="btn btn-outline" onclick="deleteUser('${u[COL.id]}')"><i class="fa-solid fa-trash"></i></button>
        </td>
    </tr>
    `).join('');
        }
        // Modal Functions
        function openUserModal(empId = null) {
            const modal = document.getElementById('user-modal'); // Ensure this ID matches your modal container
            const idField = document.getElementById('um-id');
            const nameField = document.getElementById('um-name');
            const emailField = document.getElementById('um-email');
            const phoneField = document.getElementById('um-phone');
            const jobField = document.getElementById('um-job');
            const divField = document.getElementById('um-div');
            const mgrField = document.getElementById('um-mgr');
            const roleField = document.getElementById('um-role');
            const origIdField = document.getElementById('um-orig-id');

            // Reset all fields first
            idField.value = '';
            nameField.value = '';
            emailField.value = '';
            phoneField.value = '';
            jobField.value = '';
            divField.value = '';
            mgrField.value = '';
            roleField.value = 'User'; // Default role
            origIdField.value = '';

            if (!empId) {
                // Mode: Add New Employee
                document.getElementById('um-title').innerText = "Add New Employee";
                idField.disabled = false;
            } else {
                // Mode: Edit Existing Employee
                document.getElementById('um-title').innerText = "Edit Employee Details";

                // Find user data in the global cache
                const u = allCompanyData.find(x => x[COL.id].toString() === empId.toString());

                if (u) {
                    origIdField.value = u[COL.id]; // Store the original ID for the update query
                    idField.value = u[COL.id];
                    idField.disabled = true; // Best practice: Don't allow ID changes during edit

                    nameField.value = u[COL.name] || '';
                    emailField.value = u[COL.email] || '';
                    phoneField.value = u[COL.phone] || '';
                    jobField.value = u[COL.job] || '';
                    divField.value = u[COL.div] || '';
                    mgrField.value = u[COL.mgr] || '';
                    roleField.value = u[COL.role] || 'User';
                }
            }

            modal.style.display = 'flex';
        }
        function closeUserModal() {
            document.getElementById('modal-overlay').classList.remove('open');
        }

        async function saveUser() {
            const isEdit = !!document.getElementById('edit-mode-id').value;
            const uId = document.getElementById('u-id').value.trim();
            const uName = document.getElementById('u-name').value.trim();

            if (!uId || !uName) { alert("ID and Name are required."); return; }

            const payload = {
                [COL.id]: uId,
                [COL.name]: uName,
                [COL.lvl]: document.getElementById('u-lvl').value.trim(),
                [COL.job]: document.getElementById('u-job').value.trim(),
                [COL.div]: document.getElementById('u-div').value.trim(),
                [COL.dept]: document.getElementById('u-dept').value.trim(),
                [COL.mgr]: document.getElementById('u-mgr').value.trim()
            };

            const pass = document.getElementById('u-pass').value;
            if (pass) payload['password'] = pass;

            // Using Upsert for both Add and Edit
            const { error } = await db.from('active_list').upsert(payload);

            if (error) {
                alert("Error saving user: " + error.message);
            } else {
                alert("User saved successfully!");
                closeUserModal();
                // Refresh local data
                allCompanyData = await fetchAllData();
                loadAdminDirectory();
            }
        }

        async function deleteUser(id) {
            showConfirm("Delete Employee", "Permanently delete this user? This cannot be undone.", "Delete User", "danger", async () => {
                const { error } = await db.from('active_list').delete().eq(COL.id, id);
                if (error) showToast("Error deleting: " + error.message, 'error');
                else {
                    showToast("User deleted successfully", 'success');
                    allCompanyData = allCompanyData.filter(u => u[COL.id] !== id);
                    searchDirectory(document.getElementById('dir-table').parentElement.previousElementSibling.querySelector('input').value);
                }
            });
        }
        /**
         * PROCESS BULK SCORECARD IMPORT
         * This function reads an Excel file and assigns goals to multiple employees at once.
         */
        /**
         * PROCESS BULK SCORECARD IMPORT (Chunked Version)
         * Now supports optional Rating column
         */
        async function processBulkImport(inp) {
            const file = inp.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    if (json.length === 0) { alert("Excel file is empty."); return; }

                    const grouped = {};
                    const getVal = (row, candidates) => {
                        const keys = Object.keys(row);
                        for (let c of candidates) {
                            const match = keys.find(k => k.toLowerCase().trim().replace(/\s/g, '') === c.toLowerCase().replace(/\s/g, ''));
                            if (match) return row[match];
                        }
                        return "";
                    };

                    // Grouping goals by Employee ID
                    json.forEach(r => {
                        const empIdRaw = getVal(r, ['EmployeeID', 'ID', 'Employee Number', 'EmpID']);
                        if (!empIdRaw) return;

                        const eid = empIdRaw.toString().trim();
                        if (!grouped[eid]) grouped[eid] = [];

                        let w = parseFloat(getVal(r, ['Weight', 'Wt', 'W%'])) || 0;
                        if (w > 1) w = w / 100;

                        // Optional: Parse rating if provided (1-6)
                        let rating = parseInt(getVal(r, ['Rating', 'Score', 'Rate', 'Achievement'])) || 0;
                        if (rating < 0) rating = 0;
                        if (rating > 6) rating = 6;

                        // Optional: Get comment if provided
                        const comment = getVal(r, ['Comment', 'Comments', 'Manager Comment', 'Feedback']) || "";

                        grouped[eid].push({
                            title: getVal(r, ['Objective', 'Title', 'Goal', 'KPI']) || "New Objective",
                            weight: w,
                            desc: getVal(r, ['Description', 'Desc', 'Details']) || "",
                            unit: getVal(r, ['Unit', 'UoM']) || "",
                            rating: rating,
                            comment: comment,
                            targets: [
                                getVal(r, ['L1']), getVal(r, ['L2']), getVal(r, ['L3']),
                                getVal(r, ['Target', 'L4', 'Runner']),
                                getVal(r, ['L5']), getVal(r, ['L6'])
                            ]
                        });
                    });

                    const empIds = Object.keys(grouped);
                    if (empIds.length === 0) {
                        alert("Import Error: No valid 'Employee ID' column found.");
                        return;
                    }

                    if (!confirm(`Importing objectives for ${empIds.length} employees. Proceed?`)) return;

                    showSaving();

                    // --- CHUNKING LOGIC START ---
                    const CHUNK_SIZE = 20; // Process 20 employees at a time
                    let success = 0;
                    let fail = 0;

                    for (let i = 0; i < empIds.length; i += CHUNK_SIZE) {
                        const chunk = empIds.slice(i, i + CHUNK_SIZE);

                        // Update the UI so the user sees progress
                        document.getElementById('save-text').innerText = `Processing ${i} / ${empIds.length}...`;

                        const promises = chunk.map(eid =>
                            db.from('active_list')
                                .update({ goals: grouped[eid] })
                                .eq(COL.id, eid)
                        );

                        const results = await Promise.all(promises);

                        results.forEach(res => {
                            if (!res.error) success++; else fail++;
                        });
                    }
                    // --- CHUNKING LOGIC END ---

                    showSaved();
                    clearDataCache();
                    alert(`Import Finished!\n Updated: ${success}\n Failed: ${fail}`);
                    allCompanyData = await fetchAllData();
                    inp.value = '';

                } catch (err) {
                    console.error("Import Error:", err);
                    alert("Unexpected error during import.");
                }
            };
            reader.readAsArrayBuffer(file);
        }
        function processUserBulkImport(inp) {
            const file = inp.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    if (json.length === 0) { alert("Empty file"); return; }

                    if (!confirm(`Ready to import ${json.length} users? This will update existing IDs and add new ones.`)) return;

                    showSaving();
                    const updates = json.map(r => {
                        return {
                            [COL.id]: r['Employee Number'] || r['ID'],
                            [COL.name]: r['Name'] || r['Full Name'],
                            [COL.lvl]: r['Level'] || "",
                            [COL.job]: r['Job'] || r['Title'],
                            [COL.div]: r['Division'] || "",
                            [COL.dept]: r['Department'] || "",
                            [COL.mgr]: r['Manager'] || r['Manager ID'] || ""
                        };
                    }).filter(x => x[COL.id]); // Ensure ID exists

                    // Batch upsert
                    const { error } = await db.from('active_list').upsert(updates);

                    if (error) alert("Import Error: " + error.message);
                    else {
                        alert("Import Successful!");
                        allCompanyData = await fetchAllData();
                        loadAdminDirectory();
                    }
                    showSaved();
                    inp.value = '';
                } catch (err) { console.error(err); alert("Error processing file."); }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- BULK IMPORT (SCORECARDS) ---
        function loadAdminBulk() {
            document.getElementById('admin-content').innerHTML = `
            <div class="animate-in">
                <div class="card" style="margin-bottom:24px;">
                    <h3 style="margin:0 0 8px 0; font-size:1.2rem; font-weight:700;"><i class="fa-solid fa-file-import" style="color:var(--primary); margin-right:8px;"></i>Bulk Scorecard Import</h3>
                    <p style="color:var(--text-muted); margin-bottom:24px; line-height:1.6;">Upload an Excel file to import objectives for multiple employees at once. You can import objectives only, or include scores and ratings.</p>
                </div>

                <div class="dash-grid" style="grid-template-columns: 1fr 1fr; gap:24px;">
                    <!-- Option 1: Objectives Only -->
                    <div class="card" style="text-align:center; padding:32px; border:2px solid var(--border); transition:all 0.2s;" onmouseover="this.style.borderColor='var(--primary)'" onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-size:3rem; color:var(--primary); margin-bottom:20px;">
                            <i class="fa-solid fa-bullseye"></i>
                        </div>
                        <h4 style="margin:0 0 12px 0; font-size:1.1rem;">Import Objectives Only</h4>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:24px; line-height:1.5;">
                            Import objectives with targets and weights.<br>
                            Ratings will be set to 0 (not rated).
                        </p>
                        <button class="btn btn-outline" onclick="document.getElementById('file-bulk').click()" style="width:100%;">
                            <i class="fa-solid fa-upload"></i> &nbsp; Select Excel File
                        </button>
                        <div style="margin-top:16px; font-size:0.75rem; color:var(--text-muted);">
                            Required columns: Employee ID, Title, Weight
                        </div>
                    </div>

                    <!-- Option 2: Objectives with Scores & Ratings -->
                    <div class="card" style="text-align:center; padding:32px; border:2px solid var(--border); transition:all 0.2s;" onmouseover="this.style.borderColor='var(--success)'" onmouseout="this.style.borderColor='var(--border)'">
                        <div style="font-size:3rem; color:var(--success); margin-bottom:20px;">
                            <i class="fa-solid fa-chart-line"></i>
                        </div>
                        <h4 style="margin:0 0 12px 0; font-size:1.1rem;">Import with Scores & Ratings</h4>
                        <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:24px; line-height:1.5;">
                            Import objectives with pre-filled ratings.<br>
                            Also update employee status if provided.
                        </p>
                        <button class="btn btn-primary" onclick="document.getElementById('file-bulk-scored').click()" style="width:100%; background:var(--success); border-color:var(--success);">
                            <i class="fa-solid fa-upload"></i> &nbsp; Select Excel File
                        </button>
                        <div style="margin-top:16px; font-size:0.75rem; color:var(--text-muted);">
                            + Rating, Score, Status columns supported
                        </div>
                    </div>
                </div>

                <!-- Template Download Section -->
                <div class="card" style="margin-top:24px;">
                    <h4 style="margin:0 0 16px 0; font-size:1rem; font-weight:700;"><i class="fa-solid fa-download" style="color:var(--primary); margin-right:8px;"></i>Download Templates</h4>
                    <div style="display:flex; gap:16px; flex-wrap:wrap;">
                        <button class="btn btn-outline" onclick="downloadBulkTemplate('objectives')">
                            <i class="fa-solid fa-file-excel" style="color:#10b981;"></i> &nbsp; Objectives Template
                        </button>
                        <button class="btn btn-outline" onclick="downloadBulkTemplate('scored')">
                            <i class="fa-solid fa-file-excel" style="color:#10b981;"></i> &nbsp; Scored Template
                        </button>
                    </div>
                </div>

                <!-- Column Reference -->
                <div class="card" style="margin-top:24px;">
                    <h4 style="margin:0 0 16px 0; font-size:1rem; font-weight:700;"><i class="fa-solid fa-table-columns" style="color:var(--primary); margin-right:8px;"></i>Supported Column Names</h4>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap:16px;">
                        <div>
                            <div style="font-weight:700; color:var(--text-main); margin-bottom:8px;">Required</div>
                            <ul style="margin:0; padding-left:20px; color:var(--text-muted); font-size:0.9rem; line-height:1.8;">
                                <li><strong>Employee ID</strong> - ID, Employee Number, EmpID</li>
                                <li><strong>Title</strong> - Objective, Goal, KPI</li>
                                <li><strong>Weight</strong> - Weight, Wt, W% (0-100 or 0-1)</li>
                            </ul>
                        </div>
                        <div>
                            <div style="font-weight:700; color:var(--text-main); margin-bottom:8px;">Optional (Objectives)</div>
                            <ul style="margin:0; padding-left:20px; color:var(--text-muted); font-size:0.9rem; line-height:1.8;">
                                <li><strong>Description</strong> - Desc, Details</li>
                                <li><strong>Unit</strong> - UoM</li>
                                <li><strong>Targets</strong> - L1, L2, L3, L4/Target, L5, L6</li>
                            </ul>
                        </div>
                        <div>
                            <div style="font-weight:700; color:var(--success); margin-bottom:8px;">Scored Import Only</div>
                            <ul style="margin:0; padding-left:20px; color:var(--text-muted); font-size:0.9rem; line-height:1.8;">
                                <li><strong>Rating</strong> - 1-6 (IDLE to ASTRONAUT)</li>
                                <li><strong>Comment</strong> - Manager Comment</li>
                                <li><strong>Status</strong> - Draft, Submitted, Approved, etc.</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <input type="file" id="file-bulk-scored" hidden accept=".xlsx, .xls, .csv" onchange="processBulkScoredImport(this)">
        `;
        }

        // Download bulk import templates
        function downloadBulkTemplate(type) {
            let headers, sampleData;
            
            if (type === 'objectives') {
                headers = ['Employee ID', 'Objective', 'Weight', 'Description', 'Unit', 'L1', 'L2', 'L3', 'L4 (Target)', 'L5', 'L6'];
                sampleData = [
                    ['ZIQ001', 'Increase Revenue', '40', 'Achieve revenue growth targets', '%', '< 80%', '80-90%', '90-95%', '95-100%', '100-110%', '> 110%'],
                    ['ZIQ001', 'Customer Satisfaction', '30', 'Maintain high NPS score', 'Score', '< 50', '50-60', '60-70', '70-80', '80-90', '> 90'],
                    ['ZIQ001', 'Team Development', '30', 'Complete training programs', '#', '0', '1', '2', '3', '4', '5'],
                    ['ZIQ002', 'Sales Target', '50', 'Meet quarterly sales', 'USD', '< 50K', '50-75K', '75-90K', '90-100K', '100-120K', '> 120K'],
                    ['ZIQ002', 'Process Improvement', '50', 'Implement efficiency measures', '%', '< 5%', '5-10%', '10-15%', '15-20%', '20-25%', '> 25%']
                ];
            } else {
                headers = ['Employee ID', 'Objective', 'Weight', 'Description', 'Unit', 'L1', 'L2', 'L3', 'L4 (Target)', 'L5', 'L6', 'Rating', 'Comment', 'Status'];
                sampleData = [
                    ['ZIQ001', 'Increase Revenue', '40', 'Achieve revenue growth targets', '%', '< 80%', '80-90%', '90-95%', '95-100%', '100-110%', '> 110%', '4', 'Good performance on revenue', 'Submitted to HR'],
                    ['ZIQ001', 'Customer Satisfaction', '30', 'Maintain high NPS score', 'Score', '< 50', '50-60', '60-70', '70-80', '80-90', '> 90', '5', 'Excellent customer feedback', 'Submitted to HR'],
                    ['ZIQ001', 'Team Development', '30', 'Complete training programs', '#', '0', '1', '2', '3', '4', '5', '4', 'Met training goals', 'Submitted to HR'],
                    ['ZIQ002', 'Sales Target', '50', 'Meet quarterly sales', 'USD', '< 50K', '50-75K', '75-90K', '90-100K', '100-120K', '> 120K', '3', 'Needs improvement', 'Approved'],
                    ['ZIQ002', 'Process Improvement', '50', 'Implement efficiency measures', '%', '< 5%', '5-10%', '10-15%', '15-20%', '20-25%', '> 25%', '4', 'Good progress', 'Approved']
                ];
            }
            
            const ws = XLSX.utils.aoa_to_sheet([headers, ...sampleData]);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            
            // Set column widths
            ws['!cols'] = headers.map((h, i) => ({ wch: i === 0 ? 15 : (i === 1 || i === 3) ? 30 : 12 }));
            
            XLSX.writeFile(wb, `PMS_Bulk_Import_${type === 'objectives' ? 'Objectives' : 'Scored'}_Template.xlsx`);
            showToast('Template downloaded!', 'success');
        }

        /**
         * PROCESS BULK SCORED IMPORT - Import objectives WITH ratings and scores
         */
        async function processBulkScoredImport(inp) {
            const file = inp.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    if (json.length === 0) { alert("Excel file is empty."); return; }

                    const grouped = {};
                    const statusMap = {}; // Track status per employee
                    
                    const getVal = (row, candidates) => {
                        const keys = Object.keys(row);
                        for (let c of candidates) {
                            const match = keys.find(k => k.toLowerCase().trim().replace(/\s/g, '') === c.toLowerCase().replace(/\s/g, ''));
                            if (match) return row[match];
                        }
                        return "";
                    };

                    // Grouping goals by Employee ID with ratings
                    json.forEach(r => {
                        const empIdRaw = getVal(r, ['EmployeeID', 'ID', 'Employee Number', 'EmpID']);
                        if (!empIdRaw) return;

                        const eid = empIdRaw.toString().trim();
                        if (!grouped[eid]) grouped[eid] = [];

                        let w = parseFloat(getVal(r, ['Weight', 'Wt', 'W%'])) || 0;
                        if (w > 1) w = w / 100;

                        // Parse rating (1-6)
                        let rating = parseInt(getVal(r, ['Rating', 'Score', 'Rate', 'Achievement'])) || 0;
                        if (rating < 0) rating = 0;
                        if (rating > 6) rating = 6;

                        // Get comment
                        const comment = getVal(r, ['Comment', 'Comments', 'Manager Comment', 'Feedback']) || "";

                        grouped[eid].push({
                            title: getVal(r, ['Objective', 'Title', 'Goal', 'KPI']) || "New Objective",
                            weight: w,
                            desc: getVal(r, ['Description', 'Desc', 'Details']) || "",
                            unit: getVal(r, ['Unit', 'UoM']) || "",
                            rating: rating,
                            comment: comment,
                            targets: [
                                getVal(r, ['L1']), getVal(r, ['L2']), getVal(r, ['L3']),
                                getVal(r, ['Target', 'L4', 'Runner']),
                                getVal(r, ['L5']), getVal(r, ['L6'])
                            ]
                        });

                        // Capture status (use the last one found for the employee)
                        const status = getVal(r, ['Status', 'State', 'Workflow Status']);
                        if (status) {
                            statusMap[eid] = status.toString().trim();
                        }
                    });

                    const empIds = Object.keys(grouped);
                    if (empIds.length === 0) {
                        alert("Import Error: No valid 'Employee ID' column found.");
                        return;
                    }

                    // Validate employee IDs exist in system
                    const validEmpIds = [];
                    const invalidEmpIds = [];
                    
                    empIds.forEach(eid => {
                        const exists = allCompanyData.some(u => u[COL.id] === eid);
                        if (exists) {
                            validEmpIds.push(eid);
                        } else {
                            invalidEmpIds.push(eid);
                        }
                    });

                    if (validEmpIds.length === 0) {
                        alert(`Import Error: None of the ${empIds.length} Employee IDs were found in the system.\n\nFirst few IDs tried: ${empIds.slice(0, 5).join(', ')}`);
                        return;
                    }

                    // Count how many have ratings
                    let ratedCount = 0;
                    let totalGoals = 0;
                    validEmpIds.forEach(eid => {
                        grouped[eid].forEach(g => {
                            totalGoals++;
                            if (g.rating > 0) ratedCount++;
                        });
                    });

                    let confirmMsg = `Importing ${totalGoals} objectives for ${validEmpIds.length} employees.\n\n` +
                        ` Ratings found: ${ratedCount} / ${totalGoals}\n` +
                        ` Status updates: ${Object.keys(statusMap).filter(id => validEmpIds.includes(id)).length} employees\n`;
                    
                    if (invalidEmpIds.length > 0) {
                        confirmMsg += `\n ${invalidEmpIds.length} Employee IDs not found (will be skipped):\n${invalidEmpIds.slice(0, 5).join(', ')}${invalidEmpIds.length > 5 ? '...' : ''}\n`;
                    }
                    
                    confirmMsg += `\nProceed with import?`;

                    if (!confirm(confirmMsg)) return;

                    showSaving();

                    // --- CHUNKING LOGIC START ---
                    const CHUNK_SIZE = 20;
                    let success = 0;
                    let fail = 0;
                    const failedIds = [];

                    for (let i = 0; i < validEmpIds.length; i += CHUNK_SIZE) {
                        const chunk = validEmpIds.slice(i, i + CHUNK_SIZE);

                        document.getElementById('save-text').innerText = `Processing ${i} / ${validEmpIds.length}...`;

                        const promises = chunk.map(async eid => {
                            // Build the payload with goals
                            const payload = {
                                id: eid,
                                goals: grouped[eid]
                            };
                            
                            // Add status if available
                            if (statusMap[eid]) {
                                payload.status = statusMap[eid];
                            }

                            try {
                                const res = await fetch(`${API_URL}?action=saveUser`, {
                                    method: 'POST',
                                    headers: API_HEADERS,
                                    body: JSON.stringify({ payload: payload })
                                });
                                
                                if (res.status === 401 || res.status === 403) {
                                    handleSessionExpired();
                                    return { error: { message: "Session expired" }, eid };
                                }
                                
                                if (!res.ok) {
                                    const txt = await res.text();
                                    return { error: { message: txt || "Update failed" }, eid };
                                }
                                return { error: null, eid };
                            } catch (e) {
                                return { error: e, eid };
                            }
                        });

                        const results = await Promise.all(promises);

                        results.forEach(res => {
                            if (!res.error) {
                                success++;
                            } else {
                                fail++;
                                failedIds.push(res.eid);
                                console.error(`Failed to update ${res.eid}:`, res.error);
                            }
                        });
                    }
                    // --- CHUNKING LOGIC END ---

                    showSaved();
                    clearDataCache();
                    
                    let resultMsg = `Import Finished!\n Updated: ${success} employees\n Failed: ${fail}\n\n ${ratedCount} ratings imported`;
                    
                    if (failedIds.length > 0) {
                        resultMsg += `\n\nFailed IDs: ${failedIds.slice(0, 10).join(', ')}${failedIds.length > 10 ? '...' : ''}`;
                    }
                    
                    if (invalidEmpIds.length > 0) {
                        resultMsg += `\n\nSkipped (not found): ${invalidEmpIds.length} IDs`;
                    }
                    
                    alert(resultMsg);
                    allCompanyData = await fetchAllData();
                    inp.value = '';

                } catch (err) {
                    console.error("Import Error:", err);
                    alert("Unexpected error during import: " + err.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processUserBulkImport(inp) {
            const file = inp.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);

                    if (json.length === 0) { alert("The Excel file is empty!"); return; }

                    // Helper to find data regardless of header capitalization or spaces
                    const getVal = (row, candidates) => {
                        const keys = Object.keys(row);
                        for (let c of candidates) {
                            const match = keys.find(k => k.toLowerCase().trim() === c.toLowerCase());
                            if (match) return row[match];
                        }
                        return null;
                    };

                    const updates = json.map(r => {
                        const empId = getVal(r, ['Employee Number', 'ID', 'Employee ID', 'EmpID', 'EmployeeNumber']);
                        if (!empId) return null;

                        return {
                            [COL.id]: empId.toString().trim(),
                            [COL.name]: getVal(r, ['Name', 'Full Name', 'FullName']) || "New Employee",
                            [COL.lvl]: getVal(r, ['Level', 'Lvl']) || "L4",
                            [COL.job]: getVal(r, ['Job', 'Job Title', 'Title']) || "",
                            [COL.div]: getVal(r, ['Division', 'Div']) || "",
                            [COL.dept]: getVal(r, ['Department', 'Dept']) || "",
                            [COL.mgr]: getVal(r, ['Manager', 'Manager ID', 'Reports To']) || ""
                        };
                    }).filter(x => x !== null);

                    if (updates.length === 0) {
                        alert("Import Failed: No valid data found. Ensure your header is named 'Employee Number' or 'ID'.");
                        return;
                    }

                    if (!confirm(`Ready to import ${updates.length} users?`)) return;

                    showSaving();
                    const { error } = await db.from('active_list').upsert(updates);

                    if (error) {
                        alert("Database Error: " + error.message);
                    } else {
                        alert(`Successfully imported ${updates.length} employees!`);
                        allCompanyData = await fetchAllData();
                        loadAdminDirectory();
                    }
                    showSaved();
                    inp.value = '';
                } catch (err) {
                    console.error(err);
                    alert("Error processing file. Please check the Excel format.");
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // --- SHARED GOALS EDITOR (DB DRAFT) ---

        async function loadAdminSharedGoals() {
            document.getElementById('admin-content').innerHTML = '<div style="padding:40px; text-align:center;"><div class="spinner"></div></div>';

            try {
                // 1. Check for Draft First
                const { data: draftRow } = await db.from('company_settings').select('data').eq('id', 'shared_goals_draft').maybeSingle();

                if (draftRow && draftRow.data) {
                    hasDraft = true;
                    masterData = Array.isArray(draftRow.data) ? { rating: 0, goals: draftRow.data } : draftRow.data;
                } else {
                    hasDraft = false;
                    // 2. If no draft, Load LIVE data
                    const { data: sg } = await db.from('company_settings').select('data').eq('id', SHARED_GOALS_ID).single();
                    if (sg && sg.data) {
                        masterData = Array.isArray(sg.data) ? { rating: 0, goals: sg.data } : sg.data;
                    } else {
                        // Initialize empty if nothing exists in DB
                        masterData = { rating: 0, goals: [] };
                    }
                }

                // 3. Construct UI
                const h = `
        <div class="animate-in">
            ${hasDraft ? `
            <div style="background:#fff7ed; color:#b45309; padding:16px 24px; border-radius:12px; border:1px solid #fed7aa; margin-bottom:24px; display:flex; justify-content:space-between; align-items:center;">
                <span style="display:flex; align-items:center; gap:12px; font-weight:600;"><i class="fa-solid fa-triangle-exclamation" style="font-size:1.2rem;"></i> Unsaved Draft &bull; Changes visible only to you</span>
                <button onclick="discardDraft()" class="btn btn-outline" style="border-color:#b45309; color:#b45309; height:auto; padding:6px 16px;">Discard Draft</button>
            </div>` : ''}

            <div class="card" style="background: linear-gradient(to right, #ffffff, #f8fafc); border-left: 6px solid var(--primary);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; border-bottom:1px solid var(--border); padding-bottom:24px;">
                    <div>
                        <h3 style="margin:0 0 4px 0; font-size:1.1rem; font-weight:700;">Calculated Company Performance</h3>
                        <p style="margin:0; color:var(--text-muted); font-size:0.9rem;">Aggregated status based on individual shared goal achievements.</p>
                    </div>
                    <div style="text-align:right; display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
                        <div id="global-calc-label" class="badge-rating lvl-0">PENDING</div>
                        <div id="global-calc-note" style="font-size:0.85rem; font-weight:600; color:var(--text-muted); font-style:italic; max-width:350px; line-height:1.4;">
                            Rate individual goals below to determine the company status.
                        </div>
                    </div>
                </div>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h4 style="margin:0; font-size:1rem; font-weight:700;">Shared Objectives & Cascading Weights</h4>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btn-primary" onclick="saveMasterGoals()"><i class="fa-regular fa-floppy-disk"></i> &nbsp; Publish Changes</button>
                    </div>
                </div>
                
                <div id="master-goals-list" style="display:grid; gap:20px;"></div>
                
                <button class="btn btn-outline" style="margin-top:24px; width:100%; justify-content:center; border-style:dashed;" onclick="addMasterGoal()">
                    <i class="fa-solid fa-plus"></i> &nbsp; Create New Shared Objective
                </button>
            </div>
        </div>`;

                document.getElementById('admin-content').innerHTML = h;

                // 4. Render Items & Initial Calculation
                renderMasterGoals();
                refreshGlobalAdminRating();

            } catch (e) {
                console.error(e);
                document.getElementById('admin-content').innerHTML = `<div style="color:red; padding:20px;">Error loading shared goals: ${escapeHTML(e.message)}</div>`;
            }
        }

        /**
         * UPDATED HELPER: Calculates the status from individual ratings
         * Displays the Rate Badge and Note, hides the raw numerical score
         */
        function refreshGlobalAdminRating() {
            let totalScore = 0;
            let count = 0;

            (masterData.goals || []).forEach(g => {
                if (g.rating > 0) {
                    totalScore += Number(g.rating);
                    count++;
                }
            });

            // Calculate average for backend storage/logic
            const averageRating = count > 0 ? (totalScore / count) : 0;
            masterData.rating = averageRating;

            // Update UI Labels and Notes
            const labelEl = document.getElementById('global-calc-label');
            const noteEl = document.getElementById('global-calc-note');

            if (labelEl && noteEl) {
                let lbl = "PENDING";
                let lvlClass = "lvl-0";
                let note = "Waiting for objective ratings to be processed.";

                if (averageRating >= 5.5) {
                    lbl = "ASTRONAUT"; lvlClass = "lvl-6";
                    note = "Exemplary performance. Company is leading market standards.";
                }
                else if (averageRating >= 4.5) {
                    lbl = "FLYER"; lvlClass = "lvl-5";
                    note = "Strong performance. Most targets exceeded significantly.";
                }
                else if (averageRating >= 3.5) {
                    lbl = "RUNNER"; lvlClass = "lvl-4";
                    note = "Healthy performance. Meeting all strategic organizational goals.";
                }
                else if (averageRating >= 2.5) {
                    lbl = "WALKER"; lvlClass = "lvl-3";
                    note = "Basic performance. Strategic objectives met with room for growth.";
                }
                else if (averageRating >= 1.5) {
                    lbl = "STAGNANT"; lvlClass = "lvl-2";
                    note = "Performance below expectations. Corrective action required.";
                }
                else if (averageRating > 0) {
                    lbl = "IDLE"; lvlClass = "lvl-1";
                    note = "Critical performance gaps identified across shared objectives.";
                }

                labelEl.innerText = lbl;
                labelEl.className = `badge-rating ${lvlClass}`;
                noteEl.innerText = note;
            }
        }

        function saveDraftToDB() {
            // 1. UI Feedback
            const textEl = document.getElementById('save-text');
            const statusEl = document.getElementById('save-status');
            const dotEl = document.getElementById('save-dot');

            if (statusEl) statusEl.classList.add('show');
            if (dotEl) dotEl.className = 'save-dot saving';
            if (textEl) textEl.innerText = "Saving Draft...";

            // 2. Clear previous timer
            clearTimeout(draftSaveTimer);

            // 3. Set new timer
            draftSaveTimer = setTimeout(async () => {
                try {
                    // This now correctly sends 'shared_goals_draft' to the backend
                    const { error } = await db.from('company_settings').upsert({
                        id: 'shared_goals_draft',
                        data: masterData
                    });

                    if (error) {
                        console.error("Error saving draft:", error);
                        if (textEl) textEl.innerText = "Save Failed";
                        if (dotEl) dotEl.style.background = "red";
                    } else {
                        hasDraft = true;
                        showSaved();
                    }
                } catch (e) {
                    console.error("Draft Save Exception:", e);
                }
            }, 1000); // 1 second delay
        }

        async function discardDraft() {
            showConfirm("Discard Draft", "Discard draft and reload live data?", "Discard", "danger", async () => {
                await db.from('company_settings').delete().eq('id', 'shared_goals_draft');
                location.reload();
            });
        }

        function updateMasterRating(v) {
            masterData.rating = parseInt(v);
            saveDraftToDB();
            renderMasterGoals();
        }

        function renderMasterGoals() {
            const container = document.getElementById('master-goals-list');
            const companies = ["Zain Iraq", "Horizon", "Next Generation"];

            if (!masterData.goals || masterData.goals.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#aaa;">No shared goals defined. Click "Create New" below.</div>';
                return;
            }

            container.innerHTML = (masterData.goals || []).map((g, i) => {
                if (!Array.isArray(g.targets)) g.targets = ["", "", "", "", "", ""];
                if (!Array.isArray(g.assignments)) g.assignments = [];

                const context = g.company_context || 'ALL';
                let contextData = allCompanyData;
                if (context !== 'ALL') {
                    contextData = allCompanyData.filter(u => getCompany(u[COL.id]) === context);
                }

                const availDivs = [...new Set(contextData.map(u => (u[COL.div] || "").trim()).filter(Boolean))].sort();

                const availChiefs = contextData
                    .filter(u => {
                        const l = (u[COL.lvl] || "").toString().trim().toUpperCase();
                        const j = (u[COL.job] || "").toString().trim().toUpperCase();
                        return l === 'L1' || j === 'CEO' || (j.startsWith('CHIEF ') && j.endsWith(' OFFICER'));
                    })
                    .sort((a, b) => (a[COL.name] || "").localeCompare(b[COL.name] || ""));

                const allOptionText = context === 'ALL' ? "Assign to ALL Global Employees" : `Assign to ALL ${context} Employees`;
                const allOptionVal = context === 'ALL' ? "GLOBAL_ALL" : `COMP_${context}`;

                // --- ASSIGNMENTS LOGIC ---
                const assignmentsHtml = (g.assignments || []).map((assign, ai) => {
                    const target = (assign && assign.target) ? String(assign.target) : '';
                    if (!target) return '';

                    let dispName = target;
                    let chipStyle = "background:#f1f5f9; border-color:#e2e8f0; color:#0f172a;";

                    if (target === 'GLOBAL_ALL') {
                        dispName = " GLOBAL (All Employees)";
                        chipStyle = "background:#ecfdf5; border-color:#6ee7b7; color:#064e3b;";
                    } else if (target.startsWith('COMP_')) {
                        dispName = ` ${target.replace('COMP_', '')} (Entire Company)`;
                        chipStyle = "background:#eff6ff; border-color:#93c5fd; color:#1e3a8a;";
                    } else if (target.startsWith('DIV_')) {
                        dispName = ` ${target.replace('DIV_', '')}`;
                        chipStyle = "background:#fff7ed; border-color:#fdba74; color:#7c2d12;";
                    } else if (target.startsWith('ID_')) {
                        const id = target.replace('ID_', '');
                        const u = contextData.find(x => String(x[COL.id]) === String(id));
                        dispName = u ? ` ${u[COL.name]} (${id})` : ` ${id}`;
                        chipStyle = "background:#fdf4ff; border-color:#f0abfc; color:#701a75;";
                    }

                    const shownWeight = (assign && typeof assign.weight !== 'undefined' && assign.weight !== null)
                        ? assign.weight
                        : (typeof g.weight !== 'undefined' && g.weight !== null ? g.weight : 0);

                    // --- LOGIC CALCULATED BEFORE HTML GENERATION ---
                    const isDiv = target.startsWith('DIV_');
                    const divName = isDiv ? target.replace('DIV_', '') : '';

                    const divBtn = isDiv ? `
                <button class="btn btn-outline div-weights-btn"
                        style="padding:6px 10px; font-size:0.8rem;"
                        data-goal="${i}"
                        data-div="${escapeHTML(divName)}"
                        title="View managers and edit weights">
                  <i class="fa-solid fa-users"></i>
                </button>` : '';

                    // --- RETURN PURE HTML STRING ---
                    return `
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px; border:2px solid; border-radius:10px; margin-bottom:8px; ${chipStyle}">
              <div style="font-weight:800; font-size:0.85rem; line-height:1.2;">${escapeHTML(dispName)}</div>
              <div style="display:flex; align-items:center; gap:8px;">
                <input type="number" min="0" max="100" step="1"
                  value="${Number(shownWeight) || 0}"
                  style="width:82px; padding:6px 8px; border-radius:8px; border:2px solid #e5e7eb; font-weight:800; text-align:center;"
                  onchange="masterData.goals[${i}].assignments[${ai}].weight = Number(this.value) || 0; saveDraftToDB();"
                  title="Organizational Weight (per assignment)">
                
                ${divBtn}

                <button class="btn-delete"
                  onclick="removeAssignment(${i}, ${ai})"
                  style="color:var(--danger); width:28px; height:28px; display:flex; align-items:center; justify-content:center;">
                  <i class="fa-solid fa-xmark"></i>
                </button>
              </div>
            </div>`;
                }).join('');

                const targetsHtml = (g.targets || []).map((t, ti) => {
                    const label = (ti === 3) ? 'RUNNER' : (ti === 5) ? 'ASTRO' : ('L' + (ti + 1));
                    const highlight = (ti === 3) ? 'active-highlight' : '';
                    return `
            <div style="position:relative;">
              <div style="font-size:0.6rem; font-weight:800; color:var(--text-light); margin-bottom:2px; text-align:center;">${label}</div>
              <input class="target-input ${highlight}"
                value="${escapeHTML(String(t ?? ''))}"
                placeholder="Target..."
                onchange="masterData.goals[${i}].targets[${ti}] = this.value; saveDraftToDB();">
            </div>`;
                }).join('');

                return `
          <div class="card" style="border-left: 5px solid var(--primary); background: #fff; overflow:visible; margin-bottom:20px;">
            <div style="display:grid; grid-template-columns: 2fr 1fr 1fr; gap:15px; margin-bottom:15px;">
              <input class="login-input" value="${escapeHTML(g.title || '')}" onchange="masterData.goals[${i}].title = this.value; saveDraftToDB();" placeholder="Goal Title" style="margin:0;">
              
              <select class="login-input" style="margin:0; font-weight:700; color:var(--text-main);" onchange="masterData.goals[${i}].company_context = this.value; saveDraftToDB(); renderMasterGoals();">
                <option value="ALL" ${context === 'ALL' ? 'selected' : ''}> All Companies</option>
                ${companies.map(comp => `<option value="${escapeHTML(comp)}" ${context === comp ? 'selected' : ''}> ${escapeHTML(comp)}</option>`).join('')}
              </select>

              <select class="login-input" onchange="updateGoalAssignment(${i}, this.value); this.value='';" style="margin:0; border-color:var(--primary-light);">
                <option value="" selected disabled>+ Assign Goal To...</option>
                <option value="${escapeHTML(allOptionVal)}" style="font-weight:800; color:var(--primary);">${escapeHTML(allOptionText)}</option>
                <optgroup label="Divisions (${escapeHTML(context)})">
                  ${availDivs.map(d => `<option value="DIV_${escapeHTML(d)}">${escapeHTML(d)}</option>`).join('')}
                </optgroup>
                <optgroup label="Chiefs / Hierarchy (${escapeHTML(context)})">
                  ${availChiefs.map(u => `<option value="ID_${escapeHTML(String(u[COL.id]))}">${escapeHTML(String(u[COL.name] || ''))}</option>`).join('')}
                </optgroup>
              </select>
            </div>

            <div style="background:#f8fafc; padding:12px; border-radius:10px; margin-bottom:15px;">
              <div style="font-size:0.7rem; font-weight:800; color:var(--text-muted); margin-bottom:8px;">ACTIVE ASSIGNMENTS & WEIGHTS</div>
              ${assignmentsHtml}
              ${(!g.assignments || g.assignments.length === 0) ? '<div style="font-size:0.8rem; color:var(--text-light); font-style:italic; padding:4px;">No assignments yet. Goal is inactive.</div>' : ''}
            </div>

            <div style="display:grid; grid-template-columns:repeat(6, 1fr); gap:8px; margin-bottom:15px;">${targetsHtml}</div>

            <div style="display:flex; justify-content:space-between; align-items:center; padding-top:12px; border-top:1px solid #f1f5f9;">
              <div style="display:flex; align-items:center; gap:15px;">
                <span style="font-size:0.75rem; font-weight:700; color:var(--text-muted);">ACHIEVEMENT:</span>
                <select onchange="masterData.goals[${i}].rating = parseInt(this.value); refreshGlobalAdminRating(); saveDraftToDB(); renderMasterGoals();"
                  style="padding:6px 12px; border-radius:8px; border:2px solid var(--primary); font-weight:700; background:white; cursor:pointer;">
                  <option value="0">Not Rated</option>
                  <option value="1" ${g.rating == 1 ? 'selected' : ''}>1 - IDLE</option>
                  <option value="2" ${g.rating == 2 ? 'selected' : ''}>2 - STAGNANT</option>
                  <option value="3" ${g.rating == 3 ? 'selected' : ''}>3 - WALKER</option>
                  <option value="4" ${g.rating == 4 ? 'selected' : ''}>4 - RUNNER</option>
                  <option value="5" ${g.rating == 5 ? 'selected' : ''}>5 - FLYER</option>
                  <option value="6" ${g.rating == 6 ? 'selected' : ''}>6 - ASTRONAUT</option>
                </select>
              </div>
              <button class="btn btn-outline" style="color:var(--danger); padding:6px 12px; font-size:0.8rem; border-color:#fee2e2;" onclick="masterData.goals.splice(${i}, 1); saveDraftToDB(); renderMasterGoals();">
                <i class="fa-solid fa-trash"></i> Delete Goal
              </button>
            </div>
          </div>`;
            }).join('');
        }
        function closeDivisionWeights() {
            const m = document.getElementById('div-weight-modal');
            if (m) m.classList.add('hidden');
            activeDivWeightGoalIndex = null;
        }

        function getDivisionMembers(contextData, divisionName) {
            return contextData.filter(u => ((u[COL.div] || "").trim() === divisionName));
        }

        // Manager = anyone whose ID appears in other people's manager_id inside the division
        function getDivisionManagers(divisionMembers) {
            const mgrIdSet = new Set();
            divisionMembers.forEach(u => {
                const raw = (u[COL.mgr] || "").toString().trim();
                // manager_id can be ID or name; try to extract ID by matching against known IDs:
                const match = divisionMembers.find(x => raw.includes(x[COL.id]));
                if (match) mgrIdSet.add(match[COL.id]);
                // also if it's exactly an ID:
                const direct = divisionMembers.find(x => x[COL.id] === raw);
                if (direct) mgrIdSet.add(direct[COL.id]);
            });

            // return manager objects
            const mgrs = divisionMembers
                .filter(u => mgrIdSet.has(u[COL.id]))
                .map(u => ({ id: u[COL.id], name: u[COL.name], job: u[COL.job] || '', lvl: u[COL.lvl] || '' }));

            // de-dupe by id
            const seen = new Set();
            return mgrs.filter(m => (seen.has(m.id) ? false : (seen.add(m.id), true)));
        }

        function openDivisionWeights(goalIndex, divisionName) {
            activeDivWeightGoalIndex = goalIndex;
            const g = masterData.goals[goalIndex];
            if (!g) return;

            // --- FIX: Re-calculate contextData internally ---
            const context = g.company_context || 'ALL';
            let contextData = allCompanyData;

            if (context !== 'ALL') {
                contextData = allCompanyData.filter(u => getCompany(u[COL.id]) === context);
            }

            if (!g.division_weights) g.division_weights = {};
            if (!g.division_weights[divisionName]) {
                g.division_weights[divisionName] = { default_weight: Number(g.weight) || 0, managers: {} };
            }

            const cfg = g.division_weights[divisionName];
            const members = getDivisionMembers(contextData, divisionName);
            const managers = getDivisionManagers(members);

            document.getElementById('div-weight-title').innerText = `Division Weights  ${divisionName}`;
            document.getElementById('div-weight-sub').innerText = `Goal: ${g.title || 'Shared Objective'}  ${members.length} employees`;
            document.getElementById('div-weight-default').value = Number(cfg.default_weight ?? (Number(g.weight) || 0)).toFixed(2);

            const box = document.getElementById('div-weight-managers');
            box.innerHTML = managers.length
                ? managers.map(m => {
                    const current = (cfg.managers && cfg.managers[m.id] != null) ? Number(cfg.managers[m.id]) : Number(cfg.default_weight);
                    return `
          <div style="display:flex; gap:12px; align-items:center; padding:12px; border:1px solid #e5e7eb; border-radius:12px;">
            <div style="flex:1; min-width:0;">
              <div style="font-weight:800; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${m.name} (${m.id})</div>
              <div style="color:#6b7280; font-size:0.85rem; margin-top:4px;">${m.lvl}  ${m.job}</div>
            </div>
            <div style="width:160px;">
              <div style="font-size:0.72rem; font-weight:800; color:#6b7280; text-transform:uppercase;">Override</div>
              <input data-mgr="${m.id}" type="number" step="0.01" min="0" max="1"
                     value="${Number(current).toFixed(2)}"
                     style="width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; font-weight:800;">
            </div>
          </div>
        `;
                }).join('')
                : `<div style="color:#6b7280; padding:12px;">No managers detected in this division.</div>`;

            document.getElementById('div-weight-modal').classList.remove('hidden');
        }
        function saveDivisionWeights() {
            if (activeDivWeightGoalIndex == null) return;
            const g = masterData.goals[activeDivWeightGoalIndex];
            if (!g) return;

            // We stored divisionName in the title; safest: keep a hidden field if you prefer.
            const title = document.getElementById('div-weight-title').innerText;
            const divisionName = title.split('').slice(1).join('').trim();

            if (!divisionName) return;

            if (!g.division_weights) g.division_weights = {};
            if (!g.division_weights[divisionName]) g.division_weights[divisionName] = { default_weight: Number(g.weight) || 0, managers: {} };

            const cfg = g.division_weights[divisionName];

            const def = Number(document.getElementById('div-weight-default').value || 0);
            cfg.default_weight = def;

            // Save manager overrides
            cfg.managers = cfg.managers || {};
            document.querySelectorAll('#div-weight-managers input[data-mgr]').forEach(inp => {
                const id = inp.getAttribute('data-mgr');
                const val = Number(inp.value || def);

                // If override equals default, remove it (keeps data clean)
                if (Math.abs(val - def) < 0.0001) delete cfg.managers[id];
                else cfg.managers[id] = val;
            });

            cfg.updated_at = new Date().toISOString();

            // persist and rerender
            saveDraftToDB();
            renderMasterGoals();
            closeDivisionWeights();
            showToast("Division weights saved.", "success");
        }


        // Helper to add a Division or Chief ID to a specific Shared Goal
        // Helper to add a Division or Chief ID to a specific Shared Goal
        // Helper to add a Division, Chief, Company, or Global assignment to a specific Shared Goal
        function updateGoalAssignment(goalIndex, value) {
            if (!value) return;

            // Initialize array if missing
            if (!masterData.goals[goalIndex].assignments) {
                masterData.goals[goalIndex].assignments = [];
            }

            // Check if target already exists to prevent duplicates
            const exists = masterData.goals[goalIndex].assignments.find(a => a.target === value);

            if (!exists) {
                // 1. Update Local Memory
                masterData.goals[goalIndex].assignments.push({
                    target: value,
                    weight: 0
                });

                // 2. Update UI immediately (Instant feedback)
                renderMasterGoals();

                // 3. Save to DB in background
                saveDraftToDB();
            }
        }

        // Helper to remove an assignment when the 'X' is clicked
        function removeAssignment(goalIndex, assignIndex) {
            masterData.goals[goalIndex].assignments.splice(assignIndex, 1);
            saveDraftToDB();
            renderMasterGoals();
        }

        function addMasterGoal() {
            if (!masterData.goals) masterData.goals = [];
            masterData.goals.push({
                title: "New Shared Goal",
                weight: 0, // Added
                targets: ["", "", "", "", "", ""],
                assignments: [] // Added: list of Divisions or specific IDs
            });
            saveDraftToDB();
            renderMasterGoals();
        }
        function refreshGlobalAdminRating() {
            let totalScore = 0;
            let count = 0;

            (masterData.goals || []).forEach(g => {
                if (g.rating > 0) {
                    totalScore += Number(g.rating);
                    count++;
                }
            });

            const averageRating = count > 0 ? (totalScore / count) : 0;
            masterData.rating = averageRating;

            // Numerical element removed as per your request
            const labelEl = document.getElementById('global-calc-label');
            const noteEl = document.getElementById('global-calc-note');

            if (labelEl && noteEl) {
                let lbl = "PENDING";
                let lvlClass = "lvl-0";
                let note = "Ratings not yet fully processed.";

                if (averageRating >= 5.5) {
                    lbl = "ASTRONAUT"; lvlClass = "lvl-6";
                    note = "Exemplary performance. Company is leading market standards.";
                }
                else if (averageRating >= 4.5) {
                    lbl = "FLYER"; lvlClass = "lvl-5";
                    note = "Strong performance. Most targets exceeded significantly.";
                }
                else if (averageRating >= 3.5) {
                    lbl = "RUNNER"; lvlClass = "lvl-4";
                    note = "Healthy performance. Meeting all strategic organizational goals.";
                }
                else if (averageRating >= 2.5) {
                    lbl = "WALKER"; lvlClass = "lvl-3";
                    note = "Basic performance. Strategic objectives met with room for growth.";
                }
                else if (averageRating >= 1.5) {
                    lbl = "STAGNANT"; lvlClass = "lvl-2";
                    note = "Performance below expectations. Corrective action required.";
                }
                else if (averageRating > 0) {
                    lbl = "IDLE"; lvlClass = "lvl-1";
                    note = "Critical performance gaps identified across shared objectives.";
                }

                labelEl.innerText = lbl;
                labelEl.className = `badge-rating ${lvlClass}`;
                noteEl.innerText = note;
            }
        }
        async function saveMasterGoals() {
            showConfirm("Publish Shared Goals", "This will update goals for ALL employees. Proceed?", "Publish", "primary", async () => {
                showSaving();

                let myId = user[COL.id] || user['id'] || user['Employee Number'];
                if (myId) myId = myId.toString().trim();

                // 1. Prepare Data clean copy
                const payloadData = JSON.parse(JSON.stringify(masterData));

                // 2. SAVE LIVE VERSION FIRST (Critical Fix)
                const { error: settingsError } = await db.from('company_settings')
                    .upsert({ id: SHARED_GOALS_ID, data: payloadData });

                if (settingsError) {
                    console.error("Settings Save Error:", settingsError);
                    showToast("Error saving settings: " + settingsError.message, 'error');
                    document.getElementById('save-status').classList.remove('show');
                    return;
                }

                // 3. Optional RPC Call
                try {
                    await db.rpc('publish_goals', {
                        operator_id: myId,
                        new_goals: payloadData
                    });
                } catch (err) {
                    console.warn("RPC execution skipped or failed.");
                }

                // 4. WAIT & DELETE DRAFT
                await new Promise(r => setTimeout(r, 500));

                // Only delete draft if live save was successful
                const { error: deleteError } = await db.from('company_settings').delete().eq('id', 'shared_goals_draft');

                if (!deleteError) {
                    hasDraft = false;
                }

                // 5. RELOAD FROM DB (Source of Truth)
                // This stops the UI from showing empty data if the browser cache is stale
                const { data: verifyData } = await db.from('company_settings').select('data').eq('id', SHARED_GOALS_ID).single();

                if (verifyData && verifyData.data) {
                    masterData = Array.isArray(verifyData.data) ? { rating: 0, goals: verifyData.data } : verifyData.data;
                    loadAdminSharedGoals();
                }

                showSaved();
                showToast("Saved & Published Permanently!", 'success');
            });
        }
        // --- ADMIN PERMISSIONS ---
        async function loadAdminPerms() {
            const { data: admins, error } = await db.from('active_list').select('*').eq(COL.role, 'admin');
            const adminList = admins || [];
            const myRole = getRole(user);

            let h = `
        <div class="animate-in">
            <div class="card">
                <h3 style="margin:0 0 8px 0;">Grant Admin Access</h3>
                <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:24px;">Enter an Employee ID to give them "Admin" rights.</p>
               
                <div style="display:flex; gap:12px; margin-bottom:32px;">
                    <input id="perm-id" class="login-input" style="margin:0;" placeholder="Employee ID (e.g. ZIQ...)">
                    <button class="btn btn-primary" onclick="grantAdmin()">Grant Access</button>
                </div>
               
                <h3 style="margin-bottom:16px;">Current Admins</h3>
                <div style="overflow-x:auto;">
                    <table class="report-table">
                        <thead><tr><th>Name</th><th>Job Title</th><th style="text-align:right">Action</th></tr></thead>
                        <tbody>
                            ${adminList.length > 0 ? adminList.map(a => {
                const isMaster = (a[COL.job] || "").trim() === MASTER_ADMIN_TITLE;
                return `<tr>
                                    <td style="font-weight:600;">${a[COL.name]} ${isMaster ? '<span style="color:var(--primary); font-size:0.7rem; font-weight:800; background:var(--primary-soft); padding:2px 6px; border-radius:4px; margin-left:8px;">MASTER</span>' : ''}</td>
                                    <td>${a[COL.job]}</td>
                                    <td style="text-align:right;">
                                        ${isMaster ? '<span style="color:var(--text-muted); font-size:0.8rem; font-style:italic;"><i class="fa-solid fa-lock"></i> Protected</span>' :
                        `<button class="btn btn-outline" style="color:var(--danger); border-color:#fee2e2; background:#fff1f2; padding:6px 12px; font-size:0.8rem;" onclick="revokeAdmin('${a[COL.id]}')"><i class="fa-solid fa-user-xmark"></i> Revoke</button>`}
                                    </td>
                                </tr>`;
            }).join('') : '<tr><td colspan="3" style="text-align:center; color:var(--text-muted); padding:40px;">No admins found. Grant access to employees above.</td></tr>'}
                        </tbody>
                    </table>
                </div>
                <div id="perm-msg" style="margin-top:16px; font-weight:600;"></div>
            </div>
        </div>`;
            document.getElementById('admin-content').innerHTML = h;
        }
        async function grantAdmin() {
            const id = document.getElementById('perm-id').value.trim();
            if (!id) return;
            // Check if exists
            const { data, error } = await db.from('active_list').select('*').eq(COL.id, id).single();
            if (!data) { showToast("User ID not found.", 'error'); return; }

            showConfirm("Grant Admin Access", `Make ${data[COL.name]} an Admin?`, "Grant Access", "primary", async () => {
                const { error: err2 } = await db.from('active_list').update({ [COL.role]: 'admin' }).eq(COL.id, id);
                if (err2) showToast(err2.message, 'error');
                else { showToast("Admin access granted", 'success'); loadAdminPerms(); }
            });
        }

        async function revokeAdmin(id) {
            showConfirm("Revoke Admin Access", "Remove Admin rights from this user?", "Revoke", "danger", async () => {
                const { error } = await db.from('active_list').update({ [COL.role]: null }).eq(COL.id, id);
                if (error) showToast(error.message, 'error');
                else { showToast("Admin access revoked", 'success'); loadAdminPerms(); }
            });
        }

        // --- KPI DASHBOARD ---
        let kpiChart1 = null, kpiChart2 = null, kpiChart3 = null;
        
        async function loadKPIDashboard() {
            if (allCompanyData.length === 0) { allCompanyData = await fetchAllData(); }
            
            const divs = [...new Set(allCompanyData.map(i => i[COL.div] || 'Unknown'))].sort().filter(d => d !== 'Unknown');
            
            let h = `
    <div class="animate-in">
        <!-- Filter Bar -->
        <div class="card" style="margin-bottom:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
                <div style="display:flex; align-items:center; gap:16px;">
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; display:block;">Company</label>
                        <select id="kpi-comp" onchange="updateKPIDivisions(); calculateKPIs()" style="padding:8px 32px 8px 12px; border-radius:8px; border:1px solid var(--border); font-family:inherit; font-weight:600;">
                            <option value="ALL">All Companies</option>
                            <option value="Zain Iraq">Zain Iraq</option>
                            <option value="Horizon">Horizon</option>
                            <option value="Next Generation">Next Generation</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; display:block;">Division</label>
                        <select id="kpi-div" onchange="calculateKPIs()" style="padding:8px 32px 8px 12px; border-radius:8px; border:1px solid var(--border); font-family:inherit; font-weight:600; min-width:150px;">
                            <option value="ALL">All Divisions</option>
                            ${divs.map(d => `<option value="${d}">${d}</option>`).join('')}
                        </select>
                    </div>
                </div>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-outline" onclick="exportKPIReport()"><i class="fa-solid fa-file-excel" style="color:#10b981;"></i> &nbsp; Export Excel</button>
                    <button class="btn btn-primary" onclick="exportKPIPdf()"><i class="fa-solid fa-file-pdf"></i> &nbsp; Export PDF Report</button>
                </div>
            </div>
        </div>

        <!-- KPI Summary Cards -->
        <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:24px;">
            <div class="card" style="text-align:center; padding:24px; border-left:4px solid var(--primary);">
                <div style="font-size:2.5rem; font-weight:800; color:var(--primary);" id="kpi-total-employees">--</div>
                <div style="font-size:0.85rem; color:var(--text-muted); font-weight:600; margin-top:8px;">Total Employees</div>
            </div>
            <div class="card" style="text-align:center; padding:24px; border-left:4px solid #10b981;">
                <div style="font-size:2.5rem; font-weight:800; color:#10b981;" id="kpi-completion-rate">--</div>
                <div style="font-size:0.85rem; color:var(--text-muted); font-weight:600; margin-top:8px;">Completion Rate</div>
            </div>
            <div class="card" style="text-align:center; padding:24px; border-left:4px solid #f59e0b;">
                <div style="font-size:2.5rem; font-weight:800; color:#f59e0b;" id="kpi-avg-score">--</div>
                <div style="font-size:0.85rem; color:var(--text-muted); font-weight:600; margin-top:8px;">Avg. Score</div>
            </div>
            <div class="card" style="text-align:center; padding:24px; border-left:4px solid var(--primary-dark);">
                <div style="font-size:2.5rem; font-weight:800; color:var(--primary-dark);" id="kpi-top-performers">--</div>
                <div style="font-size:0.85rem; color:var(--text-muted); font-weight:600; margin-top:8px;">Top Performers</div>
            </div>
            <div class="card" style="text-align:center; padding:24px; border-left:4px solid #ef4444;">
                <div style="font-size:2.5rem; font-weight:800; color:#ef4444;" id="kpi-needs-attention">--</div>
                <div style="font-size:0.85rem; color:var(--text-muted); font-weight:600; margin-top:8px;">Needs Attention</div>
            </div>
        </div>

        <!-- Charts Row -->
        <div class="dash-grid" style="margin-bottom:24px;">
            <div class="card">
                <h3 style="margin:0 0 20px 0; font-size:1rem; font-weight:700;"><i class="fa-solid fa-chart-pie" style="color:var(--primary); margin-right:8px;"></i>Rating Distribution</h3>
                <div style="height:300px;"><canvas id="kpi-chart-distribution"></canvas></div>
            </div>
            <div class="card">
                <h3 style="margin:0 0 20px 0; font-size:1rem; font-weight:700;"><i class="fa-solid fa-building" style="color:#10b981; margin-right:8px;"></i>Performance by Division</h3>
                <div style="height:300px;"><canvas id="kpi-chart-division"></canvas></div>
            </div>
        </div>

        <!-- Status & Trend Row -->
        <div class="dash-grid" style="margin-bottom:24px;">
            <div class="card">
                <h3 style="margin:0 0 20px 0; font-size:1rem; font-weight:700;"><i class="fa-solid fa-tasks" style="color:#f59e0b; margin-right:8px;"></i>Submission Status</h3>
                <div style="height:300px;"><canvas id="kpi-chart-status"></canvas></div>
            </div>
            <div class="card">
                <h3 style="margin:0 0 20px 0; font-size:1rem; font-weight:700;"><i class="fa-solid fa-trophy" style="color:var(--primary-dark); margin-right:8px;"></i>Top 10 Performers</h3>
                <div style="max-height:300px; overflow-y:auto;">
                    <table class="report-table" style="margin:0;">
                        <thead><tr><th>Rank</th><th>Employee</th><th>Division</th><th>Score</th><th>Rating</th></tr></thead>
                        <tbody id="kpi-top-list"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Division Breakdown Table -->
        <div class="card">
            <h3 style="margin:0 0 20px 0; font-size:1rem; font-weight:700;"><i class="fa-solid fa-table" style="color:#3b82f6; margin-right:8px;"></i>Division Performance Summary</h3>
            <div style="overflow-x:auto;">
                <table class="report-table" style="margin:0;">
                    <thead>
                        <tr>
                            <th>Division</th>
                            <th>Employees</th>
                            <th>Completed</th>
                            <th>Avg Score</th>
                            <th>Top Rating</th>
                            <th>Completion %</th>
                        </tr>
                    </thead>
                    <tbody id="kpi-division-table"></tbody>
                </table>
            </div>
        </div>
    </div>`;
            
            document.getElementById('admin-content').innerHTML = h;
            calculateKPIs();
        }

        function updateKPIDivisions() {
            const selectedComp = document.getElementById('kpi-comp').value;
            let subset = allCompanyData;
            
            if (selectedComp !== 'ALL') {
                subset = allCompanyData.filter(u => getCompany(u[COL.id]) === selectedComp);
            }
            
            const divs = [...new Set(subset.map(i => i[COL.div] || 'Unknown'))].sort().filter(d => d !== 'Unknown');
            const divSelect = document.getElementById('kpi-div');
            divSelect.innerHTML = `<option value="ALL">All Divisions</option>` + divs.map(d => `<option value="${d}">${d}</option>`).join('');
        }

        function calculateKPIs() {
            const compFilter = document.getElementById('kpi-comp').value;
            const divFilter = document.getElementById('kpi-div').value;
            
            let subset = allCompanyData;
            
            if (compFilter !== 'ALL') {
                subset = subset.filter(u => getCompany(u[COL.id]) === compFilter);
            }
            if (divFilter !== 'ALL') {
                subset = subset.filter(u => (u[COL.div] || 'Unknown') === divFilter);
            }

            const globalRating = masterData.rating || 0;
            
            // Calculate scores for all employees
            const scoredEmployees = subset.map(u => {
                let userGoals = u[COL.goals];
                if (typeof userGoals === 'string') { 
                    try { userGoals = JSON.parse(userGoals); if (typeof userGoals === 'string') userGoals = JSON.parse(userGoals); } 
                    catch (e) { userGoals = [] } 
                }
                if (!Array.isArray(userGoals)) userGoals = [];
                
                let w = getW(u[COL.lvl], u[COL.job]);
                let sScore = globalRating * (w.s / 100);
                let iScore = 0;
                
                // FIXED: Scale goal weights to employee's individual allocation
                let totalWeight = 0;
                userGoals.forEach(g => totalWeight += (g.weight || 0));
                const scaleFactor = totalWeight > 0 ? (w.i / 100) / totalWeight : 0;
                
                userGoals.forEach(g => {
                    const scaledWeight = (g.weight || 0) * scaleFactor;
                    iScore += (g.rating || 0) * scaledWeight;
                });
                
                let total = sScore + iScore;
                
                let rating = "N/A";
                if (total >= 5.5) rating = "ASTRONAUT";
                else if (total >= 4.5) rating = "FLYER";
                else if (total >= 3.5) rating = "RUNNER";
                else if (total >= 2.5) rating = "WALKER";
                else if (total >= 1.5) rating = "STAGNANT";
                else if (total > 0) rating = "IDLE";
                
                return {
                    ...u,
                    calculatedScore: total,
                    calculatedRating: rating,
                    isCompleted: ['Submitted to HR', 'Approved', 'Published'].includes(u[COL.stat])
                };
            });

            // KPI Calculations
            const totalEmployees = scoredEmployees.length;
            const completedCount = scoredEmployees.filter(e => e.isCompleted).length;
            const completionRate = totalEmployees > 0 ? Math.round((completedCount / totalEmployees) * 100) : 0;
            const avgScore = totalEmployees > 0 ? (scoredEmployees.reduce((sum, e) => sum + e.calculatedScore, 0) / totalEmployees).toFixed(2) : 0;
            const topPerformers = scoredEmployees.filter(e => ['ASTRONAUT', 'FLYER'].includes(e.calculatedRating)).length;
            const needsAttention = scoredEmployees.filter(e => ['IDLE', 'STAGNANT'].includes(e.calculatedRating)).length;

            // Update KPI Cards
            document.getElementById('kpi-total-employees').textContent = totalEmployees;
            document.getElementById('kpi-completion-rate').textContent = completionRate + '%';
            document.getElementById('kpi-avg-score').textContent = avgScore;
            document.getElementById('kpi-top-performers').textContent = topPerformers;
            document.getElementById('kpi-needs-attention').textContent = needsAttention;

            // Rating Distribution Chart
            const dist = { IDLE: 0, STAGNANT: 0, WALKER: 0, RUNNER: 0, FLYER: 0, ASTRONAUT: 0 };
            scoredEmployees.forEach(e => { if (dist.hasOwnProperty(e.calculatedRating)) dist[e.calculatedRating]++; });
            
            if (kpiChart1) kpiChart1.destroy();
            kpiChart1 = new Chart(document.getElementById('kpi-chart-distribution'), {
                type: 'doughnut',
                data: {
                    labels: ['IDLE', 'STAGNANT', 'WALKER', 'RUNNER', 'FLYER', 'ASTRONAUT'],
                    datasets: [{
                        data: [dist.IDLE, dist.STAGNANT, dist.WALKER, dist.RUNNER, dist.FLYER, dist.ASTRONAUT],
                        backgroundColor: ['#94a3b8', '#ef4444', '#f59e0b', '#3b82f6', '#10b981', '#0f766e'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 15, usePointStyle: true } }
                    }
                }
            });

            // Division Performance Chart
            const divisionStats = {};
            scoredEmployees.forEach(e => {
                const div = e[COL.div] || 'Unknown';
                if (!divisionStats[div]) divisionStats[div] = { total: 0, scoreSum: 0, completed: 0 };
                divisionStats[div].total++;
                divisionStats[div].scoreSum += e.calculatedScore;
                if (e.isCompleted) divisionStats[div].completed++;
            });
            
            const divLabels = Object.keys(divisionStats).slice(0, 10);
            const divAvgScores = divLabels.map(d => (divisionStats[d].scoreSum / divisionStats[d].total).toFixed(2));
            
            if (kpiChart2) kpiChart2.destroy();
            kpiChart2 = new Chart(document.getElementById('kpi-chart-division'), {
                type: 'bar',
                data: {
                    labels: divLabels,
                    datasets: [{
                        label: 'Avg Score',
                        data: divAvgScores,
                        backgroundColor: '#0d9488',
                        borderRadius: 6
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { beginAtZero: true, max: 6, grid: { display: false } },
                        y: { grid: { display: false } }
                    }
                }
            });

            // Status Chart
            const statusCounts = { Draft: 0, 'Submitted to Manager': 0, 'Submitted to HR': 0, Approved: 0, Published: 0, Returned: 0 };
            scoredEmployees.forEach(e => {
                const st = e[COL.stat] || 'Draft';
                if (statusCounts.hasOwnProperty(st)) statusCounts[st]++;
                else statusCounts['Draft']++;
            });
            
            if (kpiChart3) kpiChart3.destroy();
            kpiChart3 = new Chart(document.getElementById('kpi-chart-status'), {
                type: 'pie',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#94a3b8', '#f59e0b', '#3b82f6', '#10b981', '#0f766e', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { padding: 15, usePointStyle: true } }
                    }
                }
            });

            // Top 10 Performers Table
            const top10 = [...scoredEmployees].sort((a, b) => b.calculatedScore - a.calculatedScore).slice(0, 10);
            document.getElementById('kpi-top-list').innerHTML = top10.map((e, i) => {
                const ratingClass = e.calculatedRating === 'ASTRONAUT' ? 'lvl-6' : e.calculatedRating === 'FLYER' ? 'lvl-5' : 
                                   e.calculatedRating === 'RUNNER' ? 'lvl-4' : e.calculatedRating === 'WALKER' ? 'lvl-3' : 
                                   e.calculatedRating === 'STAGNANT' ? 'lvl-2' : 'lvl-1';
                return `<tr>
                    <td style="font-weight:800; color:var(--primary);">#${i + 1}</td>
                    <td style="font-weight:600;">
                        <a href="#" onclick="event.preventDefault(); loadEval('${e[COL.id]}', true);" 
                           oncontextmenu="event.preventDefault(); openScorecardInNewTab('${e[COL.id]}');"
                           style="color:var(--primary); text-decoration:none; cursor:pointer; transition: all 0.2s;"
                           onmouseover="this.style.textDecoration='underline'"
                           onmouseout="this.style.textDecoration='none'"
                           title="Left-click to view | Right-click to open in new tab">
                            ${e[COL.name] || '-'}
                        </a>
                    </td>
                    <td style="color:var(--text-muted);">${e[COL.div] || '-'}</td>
                    <td style="font-weight:700;">${e.calculatedScore.toFixed(2)}</td>
                    <td><span class="badge-rating ${ratingClass}">${e.calculatedRating}</span></td>
                </tr>`;
            }).join('') || '<tr><td colspan="5" style="text-align:center; color:var(--text-muted);">No data available</td></tr>';

            // Division Summary Table
            const divTableData = Object.entries(divisionStats).sort((a, b) => b[1].total - a[1].total);
            document.getElementById('kpi-division-table').innerHTML = divTableData.map(([div, stats]) => {
                const avg = (stats.scoreSum / stats.total).toFixed(2);
                const compPct = Math.round((stats.completed / stats.total) * 100);
                let topRating = 'N/A';
                if (parseFloat(avg) >= 5.5) topRating = 'ASTRONAUT';
                else if (parseFloat(avg) >= 4.5) topRating = 'FLYER';
                else if (parseFloat(avg) >= 3.5) topRating = 'RUNNER';
                else if (parseFloat(avg) >= 2.5) topRating = 'WALKER';
                else if (parseFloat(avg) >= 1.5) topRating = 'STAGNANT';
                else if (parseFloat(avg) > 0) topRating = 'IDLE';
                
                const ratingClass = topRating === 'ASTRONAUT' ? 'lvl-6' : topRating === 'FLYER' ? 'lvl-5' : 
                                   topRating === 'RUNNER' ? 'lvl-4' : topRating === 'WALKER' ? 'lvl-3' : 
                                   topRating === 'STAGNANT' ? 'lvl-2' : 'lvl-1';
                
                let progColor = compPct >= 80 ? '#10b981' : compPct >= 50 ? '#f59e0b' : '#ef4444';
                
                return `<tr>
                    <td style="font-weight:600;">${div}</td>
                    <td>${stats.total}</td>
                    <td>${stats.completed}</td>
                    <td style="font-weight:700;">${avg}</td>
                    <td><span class="badge-rating ${ratingClass}">${topRating}</span></td>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div class="prog-container" style="flex:1;">
                                <div class="prog-bar" style="width:${compPct}%; background:${progColor};"></div>
                            </div>
                            <span style="font-weight:600; min-width:40px;">${compPct}%</span>
                        </div>
                    </td>
                </tr>`;
            }).join('') || '<tr><td colspan="6" style="text-align:center; color:var(--text-muted);">No data available</td></tr>';
        }

        function exportKPIReport() {
            const compFilter = document.getElementById('kpi-comp').value;
            const divFilter = document.getElementById('kpi-div').value;
            
            let subset = allCompanyData;
            if (compFilter !== 'ALL') subset = subset.filter(u => getCompany(u[COL.id]) === compFilter);
            if (divFilter !== 'ALL') subset = subset.filter(u => (u[COL.div] || 'Unknown') === divFilter);
            
            if (subset.length === 0) { showToast("No data to export.", 'error'); return; }
            
            const globalRating = masterData.rating || 0;
            
            const rows = subset.map(u => {
                let userGoals = u[COL.goals];
                if (typeof userGoals === 'string') { try { userGoals = JSON.parse(userGoals); if (typeof userGoals === 'string') userGoals = JSON.parse(userGoals); } catch (e) { userGoals = [] } }
                if (!Array.isArray(userGoals)) userGoals = [];
                
                let w = getW(u[COL.lvl], u[COL.job]);
                let sScore = globalRating * (w.s / 100);
                let iScore = 0;
                
                // FIXED: Scale goal weights to employee's individual allocation
                let totalWeight = 0;
                userGoals.forEach(g => totalWeight += (g.weight || 0));
                const scaleFactor = totalWeight > 0 ? (w.i / 100) / totalWeight : 0;
                
                userGoals.forEach(g => {
                    const scaledWeight = (g.weight || 0) * scaleFactor;
                    iScore += (g.rating || 0) * scaledWeight;
                });
                
                let total = sScore + iScore;
                
                let rating = "N/A";
                if (total >= 5.5) rating = "ASTRONAUT";
                else if (total >= 4.5) rating = "FLYER";
                else if (total >= 3.5) rating = "RUNNER";
                else if (total >= 2.5) rating = "WALKER";
                else if (total >= 1.5) rating = "STAGNANT";
                else if (total > 0) rating = "IDLE";
                
                return {
                    "Employee ID": u[COL.id],
                    "Name": u[COL.name],
                    "Company": getCompany(u[COL.id]),
                    "Division": u[COL.div] || "-",
                    "Department": u[COL.dept] || "-",
                    "Job Title": u[COL.job] || "-",
                    "Supervisor": u[COL.mgr] || "-",
                    "Status": u[COL.stat] || "Draft",
                    "Shared Weight": w.s + "%",
                    "Individual Weight": w.i + "%",
                    "Total Score": total.toFixed(2),
                    "Rating": rating
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "KPI Report");
            XLSX.writeFile(wb, `KPI_Dashboard_Report_${new Date().toISOString().slice(0, 10)}.xlsx`);
            showToast('Excel report downloaded!', 'success');
        }

        async function exportKPIPdf() {
            if (typeof html2pdf === 'undefined') {
                showToast('PDF library not loaded. Please refresh and try again.', 'error');
                return;
            }
            
            showToast('Generating PDF report...', 'info');
            
            const compFilter = document.getElementById('kpi-comp').value;
            const divFilter = document.getElementById('kpi-div').value;
            
            // Get current KPI values
            const totalEmp = document.getElementById('kpi-total-employees').textContent;
            const completionRate = document.getElementById('kpi-completion-rate').textContent;
            const avgScore = document.getElementById('kpi-avg-score').textContent;
            const topPerf = document.getElementById('kpi-top-performers').textContent;
            const needsAtt = document.getElementById('kpi-needs-attention').textContent;
            
            // Create PDF content
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'padding: 30px; background: white; color: #1e293b; font-family: Inter, sans-serif; max-width: 800px;';
            
            wrapper.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 3px solid var(--primary);">
                    <h1 style="margin: 0; font-size: 28px; color: var(--primary); font-weight: 800;">KPI Dashboard Report</h1>
                    <p style="margin: 10px 0 0; font-size: 14px; color: #64748b;">Generated on ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    <p style="margin: 5px 0 0; font-size: 12px; color: #94a3b8;">Company: ${compFilter} | Division: ${divFilter}</p>
                </div>
                
                <h2 style="font-size: 18px; color: #1e293b; margin: 0 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">Executive Summary</h2>
                
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-bottom: 30px;">
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--primary);">
                        <div style="font-size: 28px; font-weight: 800; color: var(--primary);">${totalEmp}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 5px;">Total Employees</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px; border-left: 4px solid #10b981;">
                        <div style="font-size: 28px; font-weight: 800; color: #10b981;">${completionRate}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 5px;">Completion Rate</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px; border-left: 4px solid #f59e0b;">
                        <div style="font-size: 28px; font-weight: 800; color: #f59e0b;">${avgScore}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 5px;">Avg. Score</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px; border-left: 4px solid var(--primary-dark);">
                        <div style="font-size: 28px; font-weight: 800; color: var(--primary-dark);">${topPerf}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 5px;">Top Performers</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 12px; border-left: 4px solid #ef4444;">
                        <div style="font-size: 28px; font-weight: 800; color: #ef4444;">${needsAtt}</div>
                        <div style="font-size: 11px; color: #64748b; margin-top: 5px;">Needs Attention</div>
                    </div>
                </div>
                
                <h2 style="font-size: 18px; color: #1e293b; margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">Top 10 Performers</h2>
                ${document.getElementById('kpi-top-list').parentElement.outerHTML}
                
                <h2 style="font-size: 18px; color: #1e293b; margin: 30px 0 20px 0; padding-bottom: 10px; border-bottom: 2px solid #e5e7eb;">Division Performance Summary</h2>
                ${document.getElementById('kpi-division-table').parentElement.outerHTML}
                
                <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0; font-size: 10px; color: #94a3b8;">
                    Zain Iraq Performance Management System  ${new Date().getFullYear()} | Confidential
                </div>
            `;
            
            const opt = {
                margin: [15, 15, 15, 15],
                filename: `KPI_Dashboard_Report_${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true, logging: false, backgroundColor: '#ffffff' },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            try {
                await html2pdf().set(opt).from(wrapper).save();
                showToast('PDF report downloaded!', 'success');
            } catch (e) {
                console.error('PDF export error:', e);
                showToast('Failed to generate PDF.', 'error');
            }
        }

        // --- ANALYTICS ---
        async function loadAdminAnalytics() {
            if (allCompanyData.length === 0) { allCompanyData = await fetchAllData(); }
            const divs = [...new Set(allCompanyData.map(i => i[COL.div] || 'Unknown'))].sort().filter(d => d !== 'Unknown');
            
            // Get all Chiefs (L1 level ONLY)
            const chiefs = allCompanyData
                .filter(u => {
                    const l = (u[COL.lvl] || "").toString().trim().toUpperCase();
                    return l === 'L1';
                })
                .sort((a, b) => (a[COL.name] || "").localeCompare(b[COL.name] || ""));
            
            let h = `
    <div class="animate-in">
        <div class="card" style="margin-bottom:24px;">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
                <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; display:block;">Company</label>
                        <select id="anl-comp" onchange="updateDivisionsAndChiefs(); calcAdminStats()" style="padding:8px 32px 8px 12px; border-radius:8px; border:1px solid var(--border); font-family:inherit; font-weight:600;">
                            <option value="ALL">All Companies</option>
                            <option value="Zain Iraq">Zain Iraq</option>
                            <option value="Horizon">Horizon</option>
                            <option value="Next Generation">Next Generation</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; display:block;">Division</label>
                        <select id="anl-filter" onchange="calcAdminStats()" style="padding:8px 32px 8px 12px; border-radius:8px; border:1px solid var(--border); font-family:inherit; font-weight:600; min-width:150px;">
                            <option value="ALL">All Divisions</option>
                            ${divs.map(d => `<option value="${d}">${d}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; margin-bottom:4px; display:block;">Chief (L1)</label>
                        <select id="anl-chief" onchange="calcAdminStats()" style="padding:8px 32px 8px 12px; border-radius:8px; border:1px solid var(--border); font-family:inherit; font-weight:600; min-width:180px;">
                            <option value="ALL">All Chiefs</option>
                            ${chiefs.map(c => `<option value="${c[COL.id]}">${c[COL.name]}</option>`).join('')}
                        </select>
                    </div>
                </div>

                <div style="height:40px; width:1px; background:var(--border);"></div>

                <button class="btn btn-outline" onclick="downloadAdminReport()"><i class="fa-solid fa-file-excel" style="color:#10b981;"></i> &nbsp; Export Report</button>
            </div>
        </div>

        <div class="dash-grid">
            <div class="card">
                <h3 style="text-align:center; margin:0 0 24px 0; font-size:1rem; font-weight:700;">Rating Distribution (Live)</h3>
                <div style="height:350px;"><canvas id="chartAdmin"></canvas></div>
            </div>
            <div class="card">
                <h3 style="margin:0 0 24px 0; font-size:1rem; font-weight:700;">Manager Completion Tracker</h3>
                <div style="max-height:350px; overflow-y:auto;">
                    <table class="report-table">
                        <thead><tr><th>Manager</th><th>Completed</th><th>Progress</th></tr></thead>
                        <tbody id="mgr-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>`;
            document.getElementById('admin-content').innerHTML = h;
            calcAdminStats();
        }
        function updateDivisionsAndChiefs() {
            const selectedComp = document.getElementById('anl-comp').value;
            let subset = allCompanyData;

            if (selectedComp !== 'ALL') {
                subset = allCompanyData.filter(u => getCompany(u[COL.id]) === selectedComp);
            }

            // Update Divisions dropdown
            const divs = [...new Set(subset.map(i => i[COL.div] || 'Unknown'))].sort().filter(d => d !== 'Unknown');
            const divSelect = document.getElementById('anl-filter');
            divSelect.innerHTML = `<option value="ALL">All Divisions</option>` + divs.map(d => `<option value="${d}">${d}</option>`).join('');
            
            // Update Chiefs dropdown - L1 ONLY, filtered by company
            const chiefs = subset
                .filter(u => {
                    const l = (u[COL.lvl] || "").toString().trim().toUpperCase();
                    return l === 'L1';
                })
                .sort((a, b) => (a[COL.name] || "").localeCompare(b[COL.name] || ""));
            
            const chiefSelect = document.getElementById('anl-chief');
            if (chiefSelect) {
                chiefSelect.innerHTML = `<option value="ALL">All Chiefs</option>` + chiefs.map(c => `<option value="${c[COL.id]}">${c[COL.name]}</option>`).join('');
            }
        }
        
        // Keep old function name for backward compatibility
        function updateDivisions() {
            updateDivisionsAndChiefs();
        }

        function downloadAdminReport() {
            const compFilter = document.getElementById('anl-comp').value;
            const divFilter = document.getElementById('anl-filter').value;
            const chiefFilter = document.getElementById('anl-chief') ? document.getElementById('anl-chief').value : 'ALL';

            let subset = allCompanyData;

            if (compFilter !== 'ALL') {
                subset = subset.filter(u => getCompany(u[COL.id]) === compFilter);
            }
            if (divFilter !== 'ALL') {
                subset = subset.filter(u => (u[COL.div] || 'Unknown') === divFilter);
            }
            
            // Filter by Chief - get all downstream employees under selected Chief
            if (chiefFilter !== 'ALL') {
                const chiefDownstream = getDownstream(chiefFilter, allCompanyData);
                const downstreamIds = new Set(chiefDownstream.map(u => u[COL.id]));
                subset = subset.filter(u => downstreamIds.has(u[COL.id]) || u[COL.id] === chiefFilter);
            }

            if (subset.length === 0) { alert("No data to export."); return; }

            const globalRating = masterData.rating || 0;

            const rows = subset.map(u => {
                let userGoals = u[COL.goals];
                if (typeof userGoals === 'string') { try { userGoals = JSON.parse(userGoals); if (typeof userGoals === 'string') userGoals = JSON.parse(userGoals); } catch (e) { userGoals = [] } }
                if (!Array.isArray(userGoals)) userGoals = [];

                let w = getW(u[COL.lvl], u[COL.job]);
                let sScore = globalRating * (w.s / 100);
                let iScore = 0;
                
                // FIXED: Scale goal weights to employee's individual allocation
                let totalWeight = 0;
                userGoals.forEach(g => totalWeight += (g.weight || 0));
                const scaleFactor = totalWeight > 0 ? (w.i / 100) / totalWeight : 0;
                
                userGoals.forEach(g => {
                    const scaledWeight = (g.weight || 0) * scaleFactor;
                    iScore += (g.rating || 0) * scaledWeight;
                });

                let total = sScore + iScore;

                let lbl = "-";
                if (total >= 5.5) lbl = "ASTRONAUT";
                else if (total >= 4.5) lbl = "FLYER";
                else if (total >= 3.5) lbl = "RUNNER";
                else if (total >= 2.5) lbl = "WALKER";
                else if (total >= 1.5) lbl = "STAGNANT";
                else if (total > 0) lbl = "IDLE";

                return {
                    "Employee ID": u[COL.id],
                    "Name": u[COL.name],
                    "Company": getCompany(u[COL.id]),
                    "Division": u[COL.div] || "-",
                    "Department": u[COL.dept] || "-",
                    "Supervisor": u[COL.mgr] || "-",
                    "Status": u[COL.stat] || "Draft",
                    "Total Score": total.toFixed(2),
                    "Rating": lbl
                };
            });

            const ws = XLSX.utils.json_to_sheet(rows);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Evaluation Report");
            XLSX.writeFile(wb, `Zain_PMS_Report_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function calcAdminStats() {
            const compFilter = document.getElementById('anl-comp').value;
            const divFilter = document.getElementById('anl-filter').value;
            const chiefFilter = document.getElementById('anl-chief') ? document.getElementById('anl-chief').value : 'ALL';

            let subset = allCompanyData;

            if (compFilter !== 'ALL') {
                subset = subset.filter(u => getCompany(u[COL.id]) === compFilter);
            }

            if (divFilter !== 'ALL') {
                subset = subset.filter(u => (u[COL.div] || 'Unknown') === divFilter);
            }
            
            // Filter by Chief - get all downstream employees under selected Chief
            if (chiefFilter !== 'ALL') {
                const chiefDownstream = getDownstream(chiefFilter, allCompanyData);
                const downstreamIds = new Set(chiefDownstream.map(u => u[COL.id]));
                subset = subset.filter(u => downstreamIds.has(u[COL.id]) || u[COL.id] === chiefFilter);
            }

            let dist = [0, 0, 0, 0, 0, 0];
            const globalRating = masterData.rating || 0;

            subset.forEach(u => {
                let userGoals = u[COL.goals];
                if (typeof userGoals === 'string') { try { userGoals = JSON.parse(userGoals); if (typeof userGoals === 'string') userGoals = JSON.parse(userGoals); } catch (e) { userGoals = [] } }
                if (!Array.isArray(userGoals)) userGoals = [];
                let w = getW(u[COL.lvl], u[COL.job]);
                let sScore = globalRating * (w.s / 100);
                let iScore = 0;
                
                // FIXED: Scale goal weights to employee's individual allocation
                let totalWeight = 0;
                userGoals.forEach(g => totalWeight += (g.weight || 0));
                const scaleFactor = totalWeight > 0 ? (w.i / 100) / totalWeight : 0;
                
                userGoals.forEach(g => {
                    const scaledWeight = (g.weight || 0) * scaleFactor;
                    iScore += (g.rating || 0) * scaledWeight;
                });
                
                let total = sScore + iScore;
                let b = 0; if (total >= 5.5) b = 5; else if (total >= 4.5) b = 4; else if (total >= 3.5) b = 3; else if (total >= 2.5) b = 2; else if (total >= 1.5) b = 1;
                dist[b]++;
            });

            if (chartAdmin) chartAdmin.destroy();
            chartAdmin = new Chart(document.getElementById('chartAdmin'), { type: 'bar', data: { labels: ["IDLE", "STAGNANT", "WALKER", "RUNNER", "FLYER", "ASTRONAUT"], datasets: [{ label: 'Employees', data: dist, backgroundColor: '#0f766e', borderRadius: 4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });

            let mgrs = {};
            subset.forEach(u => {
                const mId = u[COL.mgr];
                if (mId) {
                    if (!mgrs[mId]) { const mObj = allCompanyData.find(x => x[COL.id] == mId); mgrs[mId] = { name: mObj ? mObj[COL.name] : mId, total: 0, done: 0 }; }
                    mgrs[mId].total++;
                    if (u[COL.stat] === 'Submitted to HR' || u[COL.stat] === 'Approved') mgrs[mId].done++;
                }
            });
            let mgrArr = Object.values(mgrs).sort((a, b) => (a.done / a.total) - (b.done / b.total));
            document.getElementById('mgr-tbody').innerHTML = mgrArr.map(m => {
                const pct = Math.round((m.done / m.total) * 100);
                let color = '#ef4444'; if (pct > 50) color = '#f59e0b'; if (pct === 100) color = '#10b981';
                return `<tr><td style="font-weight:600; font-size:0.85rem;">${m.name}</td><td style="font-size:0.85rem;">${m.done} / ${m.total}</td><td style="vertical-align:middle;"><div class="prog-container"><div class="prog-bar" style="width:${pct}%; background:${color};"></div></div></td></tr>`;
            }).join('') || '<tr><td colspan="3" style="text-align:center;">No data</td></tr>';
        }

        async function loadAdminApprovals() {
            // Fetch all records waiting for HR (Admin) approval
            const { data, error } = await db.from('active_list')
                .select('*')
                .eq(COL.stat, 'Submitted to HR');

            if (error) {
                showToast("Error fetching approvals: " + error.message, 'error');
                return;
            }

            adminCache = data || [];
            const divs = [...new Set(adminCache.map(i => i[COL.div] || 'Other'))].sort();

            let h = `
    <div class="animate-in">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <div style="display:flex; gap:16px; align-items:center;">
                    <h3 style="margin:0; font-size:1.2rem; font-weight:700;">
                        Pending Approvals <span class="badge-count">${adminCache.length}</span>
                    </h3>
                    <select id="div-filter" onchange="filterAdminTable()" class="login-input" style="margin:0; width:200px;">
                        <option value="ALL">All Divisions</option>
                        ${divs.map(d => `<option value="${d}">${d}</option>`).join('')}
                    </select>
                </div>
                <button class="btn btn-primary" onclick="approveBulk()">
                    <i class="fa-solid fa-check-double"></i> &nbsp; Approve All Visible
                </button>
            </div>
            <div style="overflow-x:auto;">
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Division</th>
                            <th>Job Title</th>
                            <th>Manager</th>
                            <th style="text-align:right">Action</th>
                        </tr>
                    </thead>
                    <tbody id="admin-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>`;

            document.getElementById('admin-content').innerHTML = h;
            filterAdminTable();
        }
        function filterAdminTable() {
            const sFilter = document.getElementById('status-filter').value;
            const dFilter = document.getElementById('div-filter').value;
            const tbody = document.getElementById('admin-tbody');

            if (!tbody) return;

            // --- FILTER LOGIC ---
            const visible = adminCache.filter(r => {
                const stat = r[COL.stat] || '';

                // 1. Division Match
                const divMatch = (dFilter === 'ALL' || (r[COL.div] || 'Other') === dFilter);
                if (!divMatch) return false;

                // 2. Status Match
                if (sFilter === 'ALL') return true;
                if (sFilter === 'ACTION') return stat === 'Submitted to HR'; // Only things needing attention
                return stat === sFilter;
            });

            if (visible.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:60px; color:var(--text-muted); font-style:italic;">No records found for this filter.</td></tr>`;
                return;
            }

            tbody.innerHTML = visible.map(r => {
                const status = r[COL.stat];
                let buttons = '';
                let rowClass = '';

                // --- DYNAMIC BUTTONS BASED ON STATUS ---

                if (status === 'Submitted to HR') {
                    // Stage 1: Needs Approval
                    buttons = `
                <button onclick="rejectToManager('${r[COL.id]}')" class="btn btn-outline" style="padding:6px 12px; font-size:0.75rem; color:#ef4444; border-color:#fee2e2;">Reject</button>
                <button onclick="approveSingle('${r[COL.id]}')" class="btn btn-primary" style="padding:6px 12px; font-size:0.75rem;">Approve</button>
            `;
                }
                else if (status === 'Approved') {
                    // Stage 2: Ready to Publish
                    rowClass = 'background:#f0fdf4;'; // Light green tint
                    buttons = `
                <button onclick="rejectToManager('${r[COL.id]}')" class="btn btn-outline" style="padding:6px 12px; font-size:0.75rem; color:#ef4444; border-color:#fee2e2;">Reject</button>
                <button onclick="publishSingle('${r[COL.id]}')" class="btn btn-primary" style="padding:6px 12px; font-size:0.75rem; background:#10b981; border-color:#10b981;">Publish</button>
            `;
                }
                else if (status === 'Published') {
                    // Stage 3: History (Can be reverted)
                    rowClass = 'opacity: 0.8;';
                    buttons = `
                <button onclick="unpublishSingle('${r[COL.id]}')" class="btn btn-outline" style="padding:6px 12px; font-size:0.75rem; color:#f59e0b; border-color:#fef3c7;">
                    <i class="fa-solid fa-rotate-left"></i> Unpublish
                </button>
                <button onclick="loadEval('${r[COL.id]}', true)" class="btn btn-outline" style="padding:6px 12px; font-size:0.75rem;">View</button>
            `;
                }

                return `
        <tr style="border-bottom:1px solid var(--border); transition:all 0.2s; ${rowClass}">
            <td style="padding:16px 24px;">
                <div style="font-weight:700; color:var(--text-main);">${r[COL.name]}</div>
                <div style="font-size:0.8rem; color:var(--text-muted); font-family:monospace;">${r[COL.id]}</div>
            </td>
            <td style="padding:16px 24px;">
                <span class="status-badge ${status === 'Published' ? 'approved' : (status === 'Approved' ? 'submitted' : 'draft')}" 
                      style="${status === 'Approved' ? 'background:#d1fae5; color:#065f46;' : ''}">
                    ${status === 'Approved' ? 'Ready to Publish' : status}
                </span>
            </td>
            <td style="padding:16px 24px;">${r[COL.div] || '-'}</td>
            <td style="padding:16px 24px;">${(r[COL.mgr] || '-').split('(')[0]}</td>
            <td style="padding:16px 24px; text-align:right;">
                <div style="display:flex; justify-content:flex-end; gap:8px;">
                    ${buttons}
                </div>
            </td>
        </tr>`;
            }).join('');
        }
        async function loadAdminSearch() {
            if (allCompanyData.length === 0) allCompanyData = await fetchAllData();
            document.getElementById('admin-content').innerHTML = `
    <div class="animate-in">
        <div class="card" style="max-width:600px; margin:0 auto; padding:32px;">
            <div style="text-align:center; margin-bottom:24px;">
                <h3 style="font-size:1.5rem; margin-bottom:8px;">Global Employee Search</h3>
                <p style="color:var(--text-muted);">Access any employee's scorecard in read-only mode.</p>
            </div>
           
            <div style="display:flex; gap:12px; margin-bottom:32px;">
                <input id="search-q" class="login-input" style="margin:0;" placeholder="Enter Name or Employee ID..." onkeypress="if(event.key==='Enter') doGlobalSearch()">
                <button class="btn btn-primary" onclick="doGlobalSearch()"><i class="fa-solid fa-magnifying-glass"></i> &nbsp; Search</button>
            </div>
           
            <div id="search-results"></div>
        </div>
    </div>`;
        }

        async function doGlobalSearch() {
            const q = document.getElementById('search-q').value.trim().toLowerCase();
            if (!q) {
                showToast("Please enter an Employee ID or Name to search", "error");
                return;
            }
            
            const results = allCompanyData.filter(r =>
                (r[COL.id] && r[COL.id].toLowerCase().includes(q)) ||
                (r[COL.name] && r[COL.name].toLowerCase().includes(q))
            ).slice(0, 10);

            if (results.length === 0) {
                document.getElementById('search-results').innerHTML = `
                    <div style="padding:40px; text-align:center; color:var(--text-muted);">
                        <i class="fa-solid fa-user-slash" style="font-size:2.5rem; opacity:0.3; margin-bottom:16px; display:block;"></i>
                        <div style="font-weight:600; margin-bottom:8px;">No Employee Found</div>
                        <div style="font-size:0.85rem;">No results matching "<strong>${escapeHTML(q)}</strong>". Please check the ID or name and try again.</div>
                    </div>`;
                showToast("Employee ID or Name not found", "error");
                return;
            }

            document.getElementById('search-results').innerHTML = results.map(r => {
                const status = r[COL.stat] || 'Draft';
                const statusClass = status === 'Published' ? 'approved' : (status === 'Draft' ? 'draft' : 'submitted');
                return `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border-bottom:1px solid var(--border);">
                    <div>
                        <div style="font-weight:700;">${escapeHTML(r[COL.name])}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">${escapeHTML(r[COL.id])} | ${escapeHTML(r[COL.job] || 'Staff')}</div>
                        <div style="margin-top:4px;"><span class="status-badge ${statusClass}" style="font-size:0.7rem;">${escapeHTML(status)}</span></div>
                    </div>
                    <button class="btn btn-outline" style="font-size:0.8rem; padding:6px 12px;" onclick="loadEval('${escapeHTML(r[COL.id])}', true)">View Scorecard</button>
                </div>`;
            }).join('');
        }

        async function approveSingle(id) {
            if (!id) return;
            showSaving();

            try {
                // Prepare secure payload including ID
                const payload = {
                    [COL.id]: id,
                    [COL.stat]: 'Approved'
                };

                // Use UPSERT to ensure the ID is sent in the body for the PHP backend
                const { error } = await db.from('active_list').upsert(payload);

                if (error) throw new Error(error.message || "Unauthorized");

                showToast("Approved (Ready to Publish)", 'success');

                // Update the local cache so the UI updates without a full reload
                const item = adminCache.find(x => x[COL.id].toString() === id.toString());
                if (item) item[COL.stat] = 'Approved';

                // Refresh the table view
                filterAdminTable();

            } catch (err) {
                console.error("Approval Error:", err);
                showToast("Approval Failed: " + err.message, 'error');
            } finally {
                showSaved();
            }
        }
        async function approveBulk() {
            const ids = adminCache
                .filter(u => u[COL.stat] === 'Submitted to HR')
                .map(u => u[COL.id]);

            if (ids.length === 0) {
                showToast("No pending requests to approve.", "info");
                return;
            }

            if (!confirm(`Approve ${ids.length} requests?`)) return;

            showSaving();

            try {
                // We must process these in a loop or a specialized batch upsert 
                // to ensure each record includes its own ID for the PHP backend.
                const promises = ids.map(id => {
                    return db.from('active_list').upsert({
                        [COL.id]: id,
                        [COL.stat]: 'Approved'
                    });
                });

                const results = await Promise.all(promises);
                const errors = results.filter(r => r.error);

                if (errors.length > 0) {
                    throw new Error(`${errors.length} items failed to update.`);
                }

                showToast("Bulk Approved successfully", 'success');

                // Update local cache manually
                adminCache.forEach(u => {
                    if (ids.includes(u[COL.id])) u[COL.stat] = 'Approved';
                });

                filterAdminTable();

            } catch (err) {
                console.error("Bulk Approval Error:", err);
                showToast("Bulk Update Failed: " + err.message, 'error');
            } finally {
                showSaved();
            }
        }
        async function publishSingle(id) {
            if (!id) return;
            showConfirm("Publish Scorecard", "This will make the score visible to the employee. Proceed?", "Publish", "success", async () => {
                showSaving();

                try {
                    // --- FIX: ALWAYS INCLUDE THE ID ---
                    const payload = {
                        [COL.id]: id,
                        [COL.stat]: 'Published'
                    };

                    const { error } = await db.from('active_list').upsert(payload);

                    if (error) throw new Error(error.message || "Unauthorized");

                    showToast("Scorecard Published!", 'success');

                    // Remove from local queue so UI updates immediately
                    if (typeof adminCache !== 'undefined') {
                        adminCache = adminCache.filter(u => u[COL.id].toString() !== id.toString());
                        if (typeof filterAdminTable === 'function') filterAdminTable();
                    }

                    // Sync database state by reloading
                    setTimeout(() => location.reload(), 1000);

                } catch (err) {
                    console.error("Publish Error:", err);
                    showToast("Publish Failed: " + err.message, 'error');
                } finally {
                    showSaved();
                }
            });
        }
        async function publishBulk() {
            const ids = adminCache.filter(u => u[COL.stat] === 'Approved').map(u => u[COL.id]);
            if (ids.length === 0) { showToast("No approved items ready to publish.", "info"); return; }

            if (!confirm(`Publish ${ids.length} scorecards?`)) return;

            showSaving();

            try {
                // Loop through IDs to ensure each payload contains the ID for backend permission check
                const promises = ids.map(id => {
                    return db.from('active_list').upsert({
                        [COL.id]: id,
                        [COL.stat]: 'Published'
                    });
                });

                const results = await Promise.all(promises);
                const errors = results.filter(r => r.error);

                if (errors.length > 0) throw new Error(`${errors.length} items failed.`);

                showToast("Bulk Published successfully", 'success');

                // Refresh local cache and UI
                adminCache = adminCache.filter(u => !ids.includes(u[COL.id]));
                if (typeof filterAdminTable === 'function') filterAdminTable();

                setTimeout(() => location.reload(), 1000);

            } catch (err) {
                console.error("Bulk Publish Error:", err);
                showToast("Bulk Publish Failed: " + err.message, 'error');
            } finally {
                showSaved();
            }
        }
        function refreshLocalData(id, newStatus) {
            const item = adminCache.find(x => x[COL.id] == id);
            if (item) {
                item[COL.stat] = newStatus;
                filterAdminTable();
            }
        }
        async function unpublishSingle(id) {
            if (!id) return;
            showConfirm("Unpublish Scorecard?", "This will hide the score from the employee. Proceed?", "Unpublish", "warning", async () => {
                showSaving();

                try {
                    const payload = {
                        [COL.id]: id,
                        [COL.stat]: 'Approved'
                    };

                    const { error } = await db.from('active_list').upsert(payload);

                    if (error) throw new Error(error.message || "Unauthorized");

                    showToast("Scorecard Unpublished.", 'success');

                    // Update local state
                    const item = adminCache.find(x => x[COL.id].toString() === id.toString());
                    if (item) item[COL.stat] = 'Approved';

                    if (typeof filterAdminTable === 'function') filterAdminTable();

                    setTimeout(() => location.reload(), 1000);

                } catch (err) {
                    console.error("Unpublish Error:", err);
                    showToast("Unpublish Failed: " + err.message, 'error');
                } finally {
                    showSaved();
                }
            });
        }
        // --- 7. REPORTS ---
        // --- 7. REPORTS (UPDATED FOR REAL-TIME AUTO-CALCULATION) ---
        async function loadReports() {
            // 1. Loading State
            document.getElementById('main-view').innerHTML = `
        <div style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; color:var(--text-muted);">
            <div class="spinner" style="border-width:3px; width:30px; height:30px;"></div>
            <div style="margin-top:10px; font-weight:600; font-size:0.9rem;">Syncing latest data...</div>
        </div>`;

            // 2. Fetch Fresh Data
            try {
                allCompanyData = await fetchAllData();
            } catch (e) {
                console.error(e);
            }

            // SAFE ACCESS: Check if user and the specific ID column exist before calling .toString()
            const myRawId = user && user[COL.id] ? user[COL.id] : "";
            const myId = myRawId.toString().toLowerCase();

            const myRawName = user && user[COL.name] ? user[COL.name] : "";
            const myName = myRawName.toString().toLowerCase();

            let directReports = allCompanyData.filter(u => {
                // Safe check for manager data
                const mRaw = u[COL.mgr] || "";
                const m = mRaw.toString().toLowerCase();
                return m.includes(myId) || (myName.length > 3 && m.includes(myName));
            });
            if (!directReports || directReports.length === 0) {
                document.getElementById('main-view').innerHTML = `<div class="card" style="padding:40px; text-align:center;">No direct reports found.</div>`;
                return;
            }

            // 4. Calculate Org Data
            globalReports = getDownstream(user[COL.id], allCompanyData);

            // CCO Logic (Optional: Keep if needed)
            const myJob = (user[COL.job] || "").toUpperCase();
            if (myJob.includes('COMMERCIAL') || myJob.includes('CCO')) {
                globalReports = globalReports.filter(u => !((u[COL.div] || "").toUpperCase().includes('SECURITY')));
            }

            let showOrgChart = (globalReports.length > directReports.length);
            const globalRating = masterData.rating || 0;

            // --- CHART CALCULATION HELPER ---
            const calcDist = (list) => {
                let d = [0, 0, 0, 0, 0, 0];
                list.forEach(u => {
                    let userGoals = u[COL.goals] || [];
                    if (typeof userGoals === 'string') { try { userGoals = JSON.parse(userGoals); } catch (e) { userGoals = [] } }
                    let w = getW(u[COL.lvl], u[COL.job]);
                    let sScore = globalRating * (w.s / 100);
                    let iScore = 0;
                    
                    // FIXED: Scale goal weights to employee's individual allocation
                    if (Array.isArray(userGoals)) {
                        let totalWeight = 0;
                        userGoals.forEach(g => totalWeight += (Number(g.weight) || 0));
                        const scaleFactor = totalWeight > 0 ? (w.i / 100) / totalWeight : 0;
                        
                        userGoals.forEach(g => {
                            const scaledWeight = (Number(g.weight) || 0) * scaleFactor;
                            iScore += (Number(g.rating) || 0) * scaledWeight;
                        });
                    }
                    
                    let total = sScore + iScore;
                    let b = 0;
                    if (total >= 5.5) b = 5; else if (total >= 4.5) b = 4; else if (total >= 3.5) b = 3; else if (total >= 2.5) b = 2; else if (total >= 1.5) b = 1;
                    d[b]++;
                });
                return d;
            };

            const distDirect = calcDist(directReports);
            let distOrg = showOrgChart ? calcDist(globalReports) : null;

            // --- NEW FILTER LOGIC START ---
            let filterHtml = "";
            if (showOrgChart) {
                // Initial Populations (All)
                const allDivs = [...new Set(globalReports.map(u => (u[COL.div] || "").trim()).filter(Boolean))].sort();

                // Initial Manager Map
                const mgrMap = new Map();
                globalReports.forEach(u => {
                    let rawM = (u[COL.mgr] || "").toString();
                    let match = allCompanyData.find(x => rawM.includes(x[COL.id]));
                    if (match) { if (!mgrMap.has(match[COL.id])) mgrMap.set(match[COL.id], match[COL.name]); }
                });
                const allMgrs = Array.from(mgrMap.entries()).map(([id, name]) => ({ id, name })).sort((a, b) => a.name.localeCompare(b.name));

                filterHtml = `
 <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:10px; flex-wrap:wrap;">
    <select id="org-filter-comp" onchange="cascadeFilters()" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:0.8rem; background:#f9fafb; cursor:pointer; font-weight:700;">
        <option value="ALL">All Companies</option>
        <option value="Zain Iraq">Zain Iraq</option>
        <option value="Horizon">Horizon</option>
        <option value="Next Generation">Next Generation</option>
    </select>

    <select id="org-filter-div" onchange="cascadeFilters()" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:0.8rem; background:#f9fafb; cursor:pointer;">
        <option value="ALL">All Divisions</option>
        ${allDivs.map(d => `<option value="${d}">${d}</option>`).join('')}
    </select>

    <select id="org-filter-mgr" onchange="updateOrgChart()" style="padding:8px 12px; border-radius:8px; border:1px solid var(--border); font-size:0.8rem; max-width:200px; background:#f9fafb; cursor:pointer;">
        <option value="ALL">All Managers</option>
        ${allMgrs.map(m => `<option value="${m.id}">${m.name}</option>`).join('')}
    </select>
 </div>`;
            }
            // --- NEW FILTER LOGIC END ---

            // Build Table Rows
            // Build Table Rows with Color Highlights
            const scoredReports = directReports.map(u => {
                let userGoals = u[COL.goals] || [];
                if (typeof userGoals === 'string') { try { userGoals = JSON.parse(userGoals); } catch (e) { userGoals = [] } }

                let w = getW(u[COL.lvl], u[COL.job]);
                let sScore = (masterData.rating || 0) * (w.s / 100);
                let iScore = 0;
                
                // FIXED: Scale goal weights to employee's individual allocation
                if (Array.isArray(userGoals)) {
                    let totalWeight = 0;
                    userGoals.forEach(g => totalWeight += (Number(g.weight) || 0));
                    const scaleFactor = totalWeight > 0 ? (w.i / 100) / totalWeight : 0;
                    
                    userGoals.forEach(g => {
                        const scaledWeight = (Number(g.weight) || 0) * scaleFactor;
                        iScore += (Number(g.rating) || 0) * scaledWeight;
                    });
                }

                let total = sScore + iScore;

                // Determine Level for Color
                let lvl = 0;
                let lbl = "IDLE";
                if (total >= 5.5) { lvl = 6; lbl = "ASTRONAUT"; }
                else if (total >= 4.5) { lvl = 5; lbl = "FLYER"; }
                else if (total >= 3.5) { lvl = 4; lbl = "RUNNER"; }
                else if (total >= 2.5) { lvl = 3; lbl = "WALKER"; }
                else if (total >= 1.5) { lvl = 2; lbl = "STAGNANT"; }
                else if (total > 0) { lvl = 1; lbl = "IDLE"; }

                return {
                    id: u[COL.id],
                    name: u[COL.name],
                    score: total.toFixed(2),
                    lvl: lvl,
                    label: lbl,
                    status: u[COL.stat] || 'Draft'
                };
            });

            scoredReports.sort((a, b) => b.score - a.score);

            // New HTML Rendering with dynamic classes
            let tableRows = scoredReports.map(r => `
    <tr>
        <td style="font-weight:600; color:var(--text-main);">
            <a href="#" onclick="event.preventDefault(); loadEval('${r.id}', true);" 
               oncontextmenu="event.preventDefault(); openScorecardInNewTab('${r.id}');"
               style="color:var(--primary); text-decoration:none; cursor:pointer; transition: all 0.2s;"
               onmouseover="this.style.textDecoration='underline'"
               onmouseout="this.style.textDecoration='none'"
               title="Left-click to view | Right-click to open in new tab">
                ${r.name}
            </a>
        </td>
        <td style="text-align:center;">
            <span class="badge-score lvl-${r.lvl}">${r.score}</span>
        </td>
        <td>
            <span class="badge-rating lvl-${r.lvl}">${r.label}</span>
        </td>
        <td style="text-align:right;">
            <span class="status-badge ${r.status === 'Approved' ? 'approved' : 'submitted'}">${r.status}</span>
        </td>
    </tr>
`).join('');

            let h = `
    <div class="animate-in">
        <div class="header-bar">
            <div><h2 class="page-title">Leadership Reports</h2></div>
            <button class="btn btn-primary" onclick="loadReports()"><i class="fa-solid fa-rotate"></i> Refresh</button>
        </div>
        <div class="dash-grid" style="grid-template-columns: ${showOrgChart ? '1fr 1fr' : '1fr'};">
            <div class="card">
                <h3 style="text-align:center; font-weight:700; margin-bottom:20px;">Direct Reports (${directReports.length})</h3>
                <div style="height:350px;"><canvas id="chartDirect"></canvas></div>
            </div>
            ${showOrgChart ? `
            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                     <h3 style="font-weight:700;">Total Organization</h3>
                     <div id="org-count-lbl" style="font-size:0.8rem;">(${globalReports.length})</div>
                </div>
                ${filterHtml}
                <div style="height:350px;"><canvas id="chartOrg"></canvas></div>
            </div>` : ''}
        </div>
        <div class="card">
            <h3>Team Performance</h3>
            <div style="max-height:500px; overflow-y:auto;">
                <table class="report-table"><thead><tr><th>Name</th><th>Score</th><th>Rating</th><th>Status</th></tr></thead><tbody>${tableRows}</tbody></table>
            </div>
        </div>
    </div>`;

            render(h);

            if (chart1) chart1.destroy();
            chart1 = new Chart(document.getElementById('chartDirect'), { type: 'bar', data: { labels: ["IDLE", "STAGNANT", "WALKER", "RUNNER", "FLYER", "ASTRONAUT"], datasets: [{ label: 'Direct Reports', data: distDirect, backgroundColor: '#0f766e', borderRadius: 4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });

            if (showOrgChart) {
                if (chartOrg) chartOrg.destroy();
                chartOrg = new Chart(document.getElementById('chartOrg'), { type: 'bar', data: { labels: ["IDLE", "STAGNANT", "WALKER", "RUNNER", "FLYER", "ASTRONAUT"], datasets: [{ label: 'Total Org', data: distOrg, backgroundColor: '#10b981', borderRadius: 4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } } } });
            }
        }

        // --- NEW FUNCTION: Cascade Filters (Comp -> Div/Mgr) ---
        function cascadeFilters() {
            const compVal = document.getElementById('org-filter-comp').value;
            const divVal = document.getElementById('org-filter-div').value;
            const divSelect = document.getElementById('org-filter-div');
            const mgrSelect = document.getElementById('org-filter-mgr');

            // Identify which dropdown was actually clicked to prevent circular loops
            const triggerId = event ? event.target.id : null;

            // --- STEP 1: FILTER BY COMPANY ---
            let companySubset = globalReports;
            if (compVal !== 'ALL') {
                // PASS BOTH ID AND DIVISION
                companySubset = globalReports.filter(u => getCompany(u[COL.id], u[COL.div]) === compVal);
            }

            // --- STEP 2: UPDATE DIVISION LIST (Only if Company was changed) ---
            if (triggerId === 'org-filter-comp') {
                const availDivs = [...new Set(companySubset.map(u => (u[COL.div] || "").trim()).filter(Boolean))].sort();

                divSelect.innerHTML = `<option value="ALL">All Divisions</option>` +
                    availDivs.map(d => `<option value="${d}">${d}</option>`).join('');

                // Reset division selection to ALL when company changes
                divSelect.value = "ALL";
            }

            // --- STEP 3: UPDATE MANAGER LIST (Filtered by current Company AND current Division) ---
            const currentDiv = divSelect.value;
            let managerSubset = companySubset;

            if (currentDiv !== 'ALL') {
                // Strict filtering: Only people in this specific Division
                managerSubset = companySubset.filter(u => (u[COL.div] || "").trim() === currentDiv);
            }

            // Extract unique Managers from the filtered results
            const mgrMap = new Map();
            managerSubset.forEach(u => {
                let rawM = (u[COL.mgr] || "").toString();
                // Look up the manager's Name in the main directory using the ID found in mgrStr
                let match = allCompanyData.find(x => rawM.includes(x[COL.id]));
                if (match) {
                    if (!mgrMap.has(match[COL.id])) mgrMap.set(match[COL.id], match[COL.name]);
                }
            });

            const availMgrs = Array.from(mgrMap.entries())
                .map(([id, name]) => ({ id, name }))
                .sort((a, b) => a.name.localeCompare(b.name));

            // Update the Manager Dropdown HTML
            mgrSelect.innerHTML = `<option value="ALL">All Managers</option>` +
                availMgrs.map(m => `<option value="${m.id}">${m.name} (${m.id})</option>`).join('');

            // --- STEP 4: REFRESH CHART ---
            updateOrgChart();
        }
        // --- UPDATED Function: Update Chart based on selections ---
        function updateOrgChart() {
            const compVal = document.getElementById('org-filter-comp').value;
            const divVal = document.getElementById('org-filter-div').value;
            const mgrVal = document.getElementById('org-filter-mgr').value;

            let filteredData = globalReports;

            // Filter 1: Company
            if (compVal !== 'ALL') {
                filteredData = filteredData.filter(u => getCompany(u[COL.id], u[COL.div]) === compVal);
            }

            // Filter 2: Manager (Recursive Downstream)
            if (mgrVal !== "ALL") {
                const subTree = getDownstream(mgrVal, allCompanyData);
                const validIds = new Set(filteredData.map(x => x[COL.id]));
                filteredData = subTree.filter(x => validIds.has(x[COL.id]));
            }

            // Filter 3: Division
            if (divVal !== "ALL") {
                filteredData = filteredData.filter(u => (u[COL.div] || "").trim() === divVal);
            }

            // Update Count Label
            document.getElementById('org-count-lbl').innerText = `(${filteredData.length})`;

            // Recalculate Distribution
            const globalRating = masterData.rating || 0;
            let dist = [0, 0, 0, 0, 0, 0];

            filteredData.forEach(u => {
                let userGoals = u[COL.goals] || [];
                if (typeof userGoals === 'string') { try { userGoals = JSON.parse(userGoals); } catch (e) { userGoals = [] } }
                let w = getW(u[COL.lvl], u[COL.job]);
                let sScore = globalRating * (w.s / 100);
                let iScore = 0;
                
                // FIXED: Scale goal weights to employee's individual allocation
                if (Array.isArray(userGoals)) {
                    let totalWeight = 0;
                    userGoals.forEach(g => totalWeight += (Number(g.weight) || 0));
                    const scaleFactor = totalWeight > 0 ? (w.i / 100) / totalWeight : 0;
                    
                    userGoals.forEach(g => {
                        const scaledWeight = (Number(g.weight) || 0) * scaleFactor;
                        iScore += (Number(g.rating) || 0) * scaledWeight;
                    });
                }
                
                let total = sScore + iScore;
                let b = 0;
                if (total >= 5.5) b = 5; else if (total >= 4.5) b = 4; else if (total >= 3.5) b = 3; else if (total >= 2.5) b = 2; else if (total >= 1.5) b = 1;
                dist[b]++;
            });

            // Update Chart Data
            chartOrg.data.datasets[0].data = dist;
            chartOrg.update();
        }
        async function loadTeam() {
            const myId = user[COL.id];
            const myName = user[COL.name];

            // Fetch my direct reports
            let filter = `${COL.mgr}.ilike.%${myId}%`;
            if (myName) filter += `,${COL.mgr}.ilike.%${myName}%`;

            const { data } = await db.from('active_list').select('*').or(filter);

            let h = `
    <div class="animate-in">
        <div class="header-bar">
            <div>
                <h2 class="page-title">My Team</h2>
                <p class="page-sub">Direct Reports & Scorecards</p>
            </div>
            <div>
                <select id="team-comp-filter" onchange="filterTeamGrid()" style="padding:10px 16px; border-radius:10px; border:1px solid var(--border); font-weight:600; cursor:pointer;">
                    <option value="ALL">All Companies</option>
                    <option value="Zain Iraq">Zain Iraq</option>
                    <option value="Horizon">Horizon</option>
                    <option value="Next Generation">Next Generation</option>
                </select>
            </div>
        </div>
        
        <div class="team-grid" id="team-grid-container">`;

            if (data && data.length > 0) {
                data.forEach(e => {
                    let isSub = e[COL.stat] === 'Submitted to Manager';
                    let isApp = e[COL.stat] === 'Approved';
                    let statClass = 'draft';
                    if (isSub) statClass = 'submitted';
                    if (isApp) statClass = 'approved';

                    // Calculate Company for filtering
                    const comp = getCompany(e[COL.id]);

                    // Add 'data-comp' attribute to the card for filtering
                    h += `
            <div class="premium-team-card team-card-item" data-comp="${comp}" 
                 onclick="loadEval('${e[COL.id]}')"
                 oncontextmenu="event.preventDefault(); openScorecardInNewTab('${e[COL.id]}');"
                 title="Left-click to view | Right-click to open in new tab"
                 style="cursor:pointer;">
                <div class="pt-status status-badge ${statClass}">${e[COL.stat] || 'Draft'}</div>
                <div class="pt-avatar">${e[COL.name].charAt(0)}</div>
                <div class="pt-info">
                    <div class="pt-name">${e[COL.name].split('(')[0]}</div>
                    <div class="pt-role">${e[COL.job] || 'Staff'}</div>
                    <div style="font-size:0.75rem; color:var(--primary); font-weight:700; margin-top:4px;">${comp}</div>
                    <div style="font-size:0.8rem; color:var(--text-muted); margin-top:2px;">${e[COL.id]}</div>
                </div>
                <div style="border-top:1px solid var(--border); padding-top:16px; display:flex; justify-content:center;">
                    <button class="btn btn-outline" style="width:100%; justify-content:center; font-size:0.9rem;">View Scorecard</button>
                </div>
            </div>`;
                });
            } else {
                h += `<div class="empty-state-message">No direct reports found.</div>`;
            }
            h += `</div></div>`;
            render(h);
        }

        // Helper function to filter the grid immediately
        function filterTeamGrid() {
            const filter = document.getElementById('team-comp-filter').value;
            const cards = document.querySelectorAll('.team-card-item');

            cards.forEach(card => {
                const comp = card.getAttribute('data-comp');
                if (filter === 'ALL' || comp === filter) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // --- OPEN SCORECARD IN NEW TAB ---
        function openScorecardInNewTab(employeeId) {
            // Get current URL and add employee ID as parameter
            const currentUrl = window.location.href.split('?')[0].split('#')[0];
            const newUrl = `${currentUrl}?openScorecard=${encodeURIComponent(employeeId)}`;
            window.open(newUrl, '_blank');
        }

        // Check if we should auto-open a scorecard (from URL parameter)
        function checkAutoOpenScorecard() {
            const urlParams = new URLSearchParams(window.location.search);
            const scorecardId = urlParams.get('openScorecard');
            if (scorecardId) {
                // Clear the URL parameter
                window.history.replaceState({}, document.title, window.location.pathname);
                // Load the scorecard after a short delay to ensure app is ready
                setTimeout(() => {
                    loadEval(scorecardId, true);
                }, 1000);
            }
        }

        // --- 9. SCORECARD ---
        async function loadEval(tid, isSearchMode = false) {
            try {
                // 1. Fetch Data
                const { data, error } = await db.from('active_list').select('*').eq(COL.id, tid).single();

                if (error || !data) {
                    console.error("Load Error:", error);
                    alert("Could not load employee data. Please refresh and try again.");
                    return;
                }

                // 2. Setup Context Variables
                targetUser = data;
                const uRole = getRole(user);
                const myId = (user[COL.id] || '').toString();
                const targetId = (targetUser[COL.id] || '').toString();
                const viewingSelf = (myId === targetId);

                // Manager Detection Logic
                const mgrStr = (data[COL.mgr] || "").toString().toLowerCase();
                const myName = (user[COL.name] || "").toString().toLowerCase();
                isDirectSupervisor = (mgrStr.includes(myId.toLowerCase()) || (myName.length > 3 && mgrStr.includes(myName)));

                // Admin acts as Manager only if not viewing themselves
                isManager = !viewingSelf && (isDirectSupervisor || (uRole === 'Admin' || uRole === 'Master'));

                // Weighting & Goals Setup
                const w = getW(data[COL.lvl], data[COL.job]);
                let userGoals = targetUser[COL.goals];
                if (typeof userGoals === 'string') { try { userGoals = JSON.parse(userGoals); } catch (e) { userGoals = []; } }
                if (!userGoals || !Array.isArray(userGoals) || userGoals.length === 0) {
                    userGoals = JSON.parse(JSON.stringify(defaultIndivGoals));
                }
                targetUser[COL.goals] = userGoals;

                const stat = data[COL.stat] || 'Draft';

                // 3. Permissions Logic
                let canEdit = false;
                const currentStat = data[COL.stat] || 'Draft';

                if (viewingSelf) {
                    // ALLOW EDITING IF: Status is Draft, basic Returned, or the specific Manager Rejection status
                    canEdit = (currentStat === 'Draft' || currentStat === 'Returned' || currentStat === 'Draft (Returned by Manager)');
                } else if (isDirectSupervisor) {
                    canEdit = (currentStat === 'Submitted to Manager');
                }

                if (isSearchMode) canEdit = false;
                
                // --- VISIBILITY RULE: Show scores if Published, if user is Reviewer, OR if Admin is searching ---
                const currentStatClean = (data[COL.stat] || '').trim().toLowerCase();
                isAdminSearchMode = isSearchMode && ['Admin', 'Master'].includes(uRole);
                const canSeeScore = (currentStatClean === 'published') || 
                                   (!viewingSelf && (isManager || ['Admin', 'Master'].includes(uRole))) ||
                                   isAdminSearchMode;

                // 4. UI Preparation (Manager Name, Company)
                let mName = data[COL.mgr] || '-';
                let managerOnlyID = '';
                if (data[COL.mgr]) {
                    const match = data[COL.mgr].match(/\(([^)]+)\)/);
                    if (match) managerOnlyID = match[1];
                    else if (['ZIQ', 'AWO', 'NG'].some(x => data[COL.mgr].includes(x))) managerOnlyID = data[COL.mgr];
                }
                if (mName.includes('(')) mName = mName.split('(')[0].trim();
                let comp = getCompany(data[COL.id]);

                // 5. Construct HTML
                let h = `
        <div class="animate-in">
            ${isAdminSearchMode ? `
            <div style="background:linear-gradient(90deg, #dbeafe, #ede9fe); border:1px solid #93c5fd; padding:12px 20px; border-radius:12px; margin-bottom:20px; display:flex; align-items:center; gap:12px;">
                <i class="fa-solid fa-eye" style="color:#3b82f6; font-size:1.1rem;"></i>
                <div>
                    <div style="font-weight:700; color:#1e40af; font-size:0.9rem;">Admin View Mode</div>
                    <div style="font-size:0.8rem; color:#3b82f6;">Viewing scorecard as read-only. All scores are visible regardless of status.</div>
                </div>
            </div>` : ''}
            <div class="header-bar">
                <div>
                    <h2 class="page-title">${isAdminSearchMode ? 'Scorecard View (Admin)' : (isManager ? 'Evaluation Portal' : 'My Scorecard')}</h2>
                    <p class="page-sub">
                        <span style="font-weight:700; color:var(--text-main);">${data[COL.name].split('(')[0]}</span>
                        <span style="margin:0 8px; color:var(--text-light);"></span>
                        <span class="status-badge ${stat === 'Approved' || stat === 'Published' ? 'approved' : (stat === 'Draft' || stat.includes('Returned') ? 'draft' : 'submitted')}">${stat}</span>
                    </p>
                </div>
                <div style="display:flex; gap:10px;">
                    ${(['Admin', 'Master'].includes(uRole)) ? `<button onclick="exportScoreAsPdf()" class="btn btn-outline" title="Export as PDF">
                        <i class="fa-solid fa-file-pdf"></i> &nbsp; Export PDF
                    </button>` : ''}
                    <button onclick="showHistory('${data[COL.id]}')" class="btn btn-outline">
                        <i class="fa-solid fa-clock-rotate-left"></i> &nbsp; View History
                    </button>
                    ${isAdminSearchMode ? `<button onclick="loadHRAdmin(); switchAdminTab('search');" class="btn btn-outline"><i class="fa-solid fa-arrow-left"></i> &nbsp; Back to Search</button>` : 
                      (isManager ? `<button onclick="${isDirectSupervisor ? 'loadTeam()' : "loadHRAdmin(); switchAdminTab('app');"}" class="btn btn-outline"><i class="fa-solid fa-arrow-left"></i> &nbsp; Back</button>` : '')}
                </div>
            </div>
            
            <div class="metrics-row">
                <div class="metric-card highlight">
                    <div class="metric-card-inner">
                        <div class="metric-icon"><i class="fa-solid fa-trophy"></i></div>
                        <div class="metric-val" id="score">--</div>
                        <div class="metric-lbl">Final Score</div>
                    </div>
                    <div class="metric-progress"><div class="metric-progress-bar" id="score-progress" style="width: 0%"></div></div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-inner">
                        <div class="metric-icon"><i class="fa-solid fa-medal"></i></div>
                        <div class="metric-val" id="rating">--</div>
                        <div class="metric-lbl">Rating</div>
                    </div>
                    <div class="metric-progress"><div class="metric-progress-bar" id="rating-progress" style="width: 0%"></div></div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-inner">
                        <div class="metric-icon"><i class="fa-solid fa-users"></i></div>
                        <div class="metric-val">${w.s}%</div>
                        <div class="metric-lbl">Shared Goals</div>
                        <span class="metric-sub-val" id="shared-contrib-val">0.00</span>
                    </div>
                    <div class="metric-progress"><div class="metric-progress-bar" style="width: ${w.s}%"></div></div>
                </div>
                <div class="metric-card">
                    <div class="metric-card-inner">
                        <div class="metric-icon"><i class="fa-solid fa-bullseye"></i></div>
                        <div class="metric-val">${w.i}%</div>
                        <div class="metric-lbl">Individual Goals</div>
                        <span class="metric-sub-val" id="indiv-contrib-val">0.00</span>
                    </div>
                    <div class="metric-progress"><div class="metric-progress-bar" style="width: ${w.i}%"></div></div>
                </div>
            </div>

            <div class="info-panel">
                <div class="info-item" onclick="this.classList.toggle('expanded')">
                    <div class="info-icon user"><i class="fa-solid fa-user"></i></div>
                    <div class="info-content">
                        <label>Employee Name</label>
                        <div class="info-value">${escapeHTML(data[COL.name])}</div>
                    </div>
                    <div class="expand-indicator"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
                <div class="info-item" onclick="this.classList.toggle('expanded')">
                    <div class="info-icon job"><i class="fa-solid fa-briefcase"></i></div>
                    <div class="info-content">
                        <label>Job Title</label>
                        <div class="info-value">${escapeHTML(data[COL.job] || '-')}</div>
                    </div>
                    <div class="expand-indicator"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
                <div class="info-item" onclick="this.classList.toggle('expanded')">
                    <div class="info-icon division"><i class="fa-solid fa-building"></i></div>
                    <div class="info-content">
                        <label>Division</label>
                        <div class="info-value">${escapeHTML(data[COL.div] || '-')}</div>
                    </div>
                    <div class="expand-indicator"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
                <div class="info-item" onclick="this.classList.toggle('expanded')">
                    <div class="info-icon manager"><i class="fa-solid fa-user-tie"></i></div>
                    <div class="info-content">
                        <label>Direct Manager</label>
                        <div class="info-value">${escapeHTML(mName)}</div>
                    </div>
                    <div class="expand-indicator"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
                <div class="info-item" onclick="this.classList.toggle('expanded')">
                    <div class="info-icon id"><i class="fa-solid fa-id-badge"></i></div>
                    <div class="info-content">
                        <label>Manager ID</label>
                        <div class="info-value" style="font-family: 'SF Mono', Monaco, monospace; background:#f1f5f9; padding:4px 10px; border-radius:6px; font-size:0.9rem;">
                            ${escapeHTML(managerOnlyID || '-')}
                        </div>
                    </div>
                    <div class="expand-indicator"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
                <div class="info-item" onclick="this.classList.toggle('expanded')">
                    <div class="info-icon company"><i class="fa-solid fa-landmark"></i></div>
                    <div class="info-content">
                        <label>Company</label>
                        <div class="info-value" style="color:var(--primary);">${escapeHTML(comp)}</div>
                    </div>
                    <div class="expand-indicator"><i class="fa-solid fa-chevron-down"></i></div>
                </div>
            </div>`;

                const managerBlocked = (isDirectSupervisor && (stat === 'Draft' || stat === 'Returned'));

                if (managerBlocked && !['Admin', 'Master'].includes(uRole)) {
                    h += `
                <div class="card" style="text-align:center; padding:80px 40px;">
                    <div style="font-size:4rem; color:var(--primary-light); margin-bottom:24px; animation:pulse 2s infinite;"><i class="fa-solid fa-hourglass-half"></i></div>
                    <h3 style="color:var(--text-main); font-size:1.5rem; margin-bottom:12px;">Waiting for Submission</h3>
                    <p style="color:var(--text-muted); font-size:1.1rem; max-width:500px; margin:0 auto;">The employee has not submitted their scorecard yet.</p>
                </div>`;
                } else {
                    // SHARED GOALS SECTION
                    // SHARED GOALS SECTION
                    // SHARED GOALS SECTION
                    // SHARED GOALS SECTION
                    if (w.s > 0) {
                        const userDiv = (data[COL.div] || "").trim();
                        const userId = (data[COL.id] || "").trim();
                        const userComp = getCompany(userId);

                        // --- REPLACEMENT BLOCK FOR loadEval relevantShared Logic ---
                        const relevantShared = (masterData.goals || []).map(g => {
                            let totalWeight = 0;
                            let isAssigned = false;

                            (g.assignments || []).forEach(a => {
                                let weight = Number(a.weight) || 0;
                                const t = a.target;

                                // 1. CHECK FOR DIVISION OVERRIDES
                                if (t.startsWith('DIV_') || t === userDiv) {
                                    const divName = t.replace('DIV_', '');
                                    if (g.division_weights && g.division_weights[divName]) {
                                        const cfg = g.division_weights[divName];
                                        if (cfg.managers && cfg.managers[userId] != null) {
                                            weight = Number(cfg.managers[userId]);
                                        } else {
                                            weight = Number(cfg.default_weight);
                                        }
                                    }
                                }

                                // 2. CHECK ASSIGNMENT MATCH
                                if (t === 'GLOBAL_ALL' ||
                                    t === `COMP_${userComp}` ||
                                    t === `DIV_${userDiv}` || t === userDiv ||
                                    t === `ID_${userId}` || t === userId) {
                                    totalWeight += weight;
                                    isAssigned = true;
                                }
                            });

                            // 3. MATH FIX
                            if (totalWeight > 1) totalWeight = totalWeight / 100;

                            return isAssigned ? { ...g, myWeight: totalWeight } : null;
                        }).filter(Boolean);

                        // ... The rest of your code continues with h += ...

                        h += `
                <div style="margin-bottom:40px;">
                    <h3 style="margin-bottom:20px; font-weight:800; display:flex; align-items:center; gap:12px;">
                        <span style="background:var(--primary-light); color:var(--primary); padding:6px 12px; border-radius:8px; font-size:1rem;">${w.s}%</span> Shared Goals
                    </h3>
                    <div class="shared-grid">
                        ${relevantShared.map(g => `
                            <div class="shared-card">
                                <div class="shared-header" style="display:flex; justify-content:space-between; align-items:center;">
                                    <span>${g.title}</span>
                                    <span class="pro-unit-badge" style="background:var(--primary-light); font-size:0.65rem;">Weight: ${(g.myWeight * 100).toFixed(1)}%</span>
                                </div>
                                <div class="segment-bar">
                                    ${[1, 2, 3, 4, 5, 6].map(n => {
                            const isAchieved = (n === g.rating);
                            return `<div class="segment ${n === 4 ? 'is-target' : ''} ${isAchieved ? 'active' : ''}">
                                                    ${n === 4 ? '<div class="target-badge">TARGET</div>' : ''}
                                                    <div class="seg-num">${n}</div>
                                                    <div class="seg-val">${g.targets[n - 1] || '-'}</div>
                                                </div>`;
                        }).join('')}
                                </div>
                            </div>`).join('')}
                        ${relevantShared.length === 0 ? '<div style="color:var(--text-muted); font-style:italic; padding:20px;">No shared goals assigned to this division or company.</div>' : ''}
                    </div>
                </div>`;
                    }

                    // INDIVIDUAL GOALS SECTION
                    if (w.i > 0) {
                        h += `
                <div class="animate-in" style="animation-delay: 0.2s;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                        <h3 style="margin:0; color:var(--text-main); font-weight:800; font-size:1.4rem; display:flex; align-items:center; gap:12px;">
                            <span style="background:var(--secondary); color:white; padding:6px 12px; border-radius:8px; font-size:1rem;">${w.i}%</span> Individual Goals
                        </h3>
                        ${canEdit ? `<div>
                            <button class="btn btn-outline" style="margin-right:12px;" onclick="triggerImport()"><i class="fa-solid fa-file-excel"></i> &nbsp; Import Excel</button>
                            <button class="btn btn-primary" onclick="openGoalModal()"><i class="fa-solid fa-plus"></i> &nbsp; Add Goal</button>
                        </div>` : ''}
                    </div>
                    <div id="goal-list"></div>
                </div>`;
                    }
                }

                // 6. Footer & Actions Logic
                h += `<div style="margin-top:48px; padding-top:32px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:16px;">`;

                // Standard Edit Actions
                if (canEdit) {
                    h += `<button class="btn btn-outline" onclick="saveDraft()"><i class="fa-regular fa-floppy-disk"></i> &nbsp; Save Draft</button>`;

                    let btnText = viewingSelf ? "Submit to Manager" : "Approve & Submit to HR";

                    // If Admin is editing, they move it to 'Approved' (Intermediate), NOT 'Published'
                    if (uRole === 'Admin' || uRole === 'Master') {
                        btnText = "Approve (Hold for Publish)";
                    }

                    h += `<button id="btn-submit-final" class="btn btn-primary" style="padding:12px 32px; font-size:1rem;" onclick="submitFinal()"><i class="fa-solid fa-paper-plane"></i> &nbsp; ${btnText}</button>`;
                }

                // "Return to Manager" - Available to Manager (if submitted) AND Admin (at any stage)
                const adminCanReturn = ['Admin', 'Master'].includes(uRole) && (stat === 'Submitted to HR' || stat === 'Approved');
                if ((isDirectSupervisor && stat === 'Submitted to Manager') || adminCanReturn) {
                    h += `<button class="btn btn-outline" style="color:var(--danger); border-color:#fee2e2; background:#fff1f2;" onclick="rejectToManager('${targetId}')"><i class="fa-solid fa-ban"></i> &nbsp; Reject</button>`;
                }

                // "Publish Score" - Only for Admin, Only when Approved
                if (['Admin', 'Master'].includes(uRole) && stat === 'Approved') {
                    h += `<button class="btn btn-primary" style="background:#10b981; border-color:#10b981;" onclick="publishSingle('${targetId}')"><i class="fa-solid fa-check-double"></i> &nbsp; Publish Score</button>`;
                }

                h += `</div></div>`;

                render(h);

                // 7. Render Goals & Score Masking
                if (w.i > 0 && !managerBlocked) renderGoals(canEdit);
                calc();

                // Enforce Visibility Masking
                const scoreEl = document.getElementById('score');
                const ratingEl = document.getElementById('rating');
                if (canSeeScore) {
                    // Show the actual numbers
                    calc();
                } else {
                    // Keep it locked
                    if (scoreEl) scoreEl.innerHTML = '<i class="fa-solid fa-lock" style="font-size:1.5rem; opacity:0.3;"></i>';
                    if (ratingEl) ratingEl.innerText = "Pending Publish";
                }

            } catch (err) {
                console.error(err);
                alert("Unexpected error: " + err.message);
            }
        }
        async function rejectToManager(id) {
            if (!id) {
                showToast("Error: No Employee ID provided.", "error");
                return;
            }

            showConfirm(
                "Return to Employee",
                "This will move the scorecard back to 'Draft' status for the employee. Continue?",
                "Return to Draft",
                "danger",
                async () => {
                    showSaving();

                    try {
                        // Prepare secure payload with ID for the PHP backend
                        const payload = {
                            [COL.id]: id,
                            [COL.stat]: 'Draft (Returned by Manager)'
                        };

                        // Use UPSERT to satisfy backend security requirements
                        const { error } = await db.from('active_list').upsert(payload);

                        if (error) {
                            throw new Error(error.message || "Unauthorized or Connection Failed");
                        }

                        showToast("Returned to Employee", 'success');

                        // --- UI SAFETY REFRESH ---

                        // Update global data if synced
                        if (typeof allCompanyData !== 'undefined') {
                            const globalItem = allCompanyData.find(u => u[COL.id].toString() === id.toString());
                            if (globalItem) globalItem[COL.stat] = 'Draft (Returned by Manager)';
                        }

                        // Force a reload after a short delay to re-sync the manager's team view
                        setTimeout(() => {
                            location.reload();
                        }, 1000);

                    } catch (err) {
                        console.error("Rejection Error:", err);
                        // The catch handles the 'reading value' error by preventing the red toast 
                        // if the data was actually saved successfully.
                        showToast("Saved, but UI refresh failed. Please reload page.", 'info');
                    } finally {
                        const statusEl = document.getElementById('save-status');
                        if (statusEl) statusEl.classList.remove('show');
                    }
                }
            );
        }
        let editingGoalIndex = null;

        function renderGoals(edit) {
            const stat = targetUser[COL.stat] || 'Draft';
            const myId = (user[COL.id] || '').toString();
            const targetId = (targetUser[COL.id] || '').toString();
            const viewingSelf = (myId === targetId);
            const uRole = getRole(user);
            const tHeaders = ['IDLE', 'STAGNANT', 'WALKER', 'RUNNER (Target)', 'FLYER', 'ASTRONAUT'];

            document.getElementById('goal-list').innerHTML = targetUser[COL.goals].map((g, i) => {
                let ratingDisplay = `<span class="rating-badge pending"><i class="fa-solid fa-lock"></i> &nbsp; Pending HR</span>`;
                let commentHtml = '';

                // Validation: Highlight 0% weight goals
                const isInvalid = (!g.weight || parseFloat(g.weight) === 0);

                // Case A: Manager/Admin is currently reviewing/editing
                if (isDirectSupervisor && edit) {
                    ratingDisplay = `
                <select class="rating-select" onchange="updG(${i},'rating',this.value)" style="padding:8px; border-radius:8px; border:1px solid var(--primary); font-weight:700;">
                    <option value="0">Rate Goal...</option>
                    ${[1, 2, 3, 4, 5, 6].map(n => `<option value="${n}" ${g.rating == n ? 'selected' : ''}>${n} - ${ratingLabels[n]}</option>`).join('')}
                </select>`;

                    commentHtml = `
                <div style="margin-top:15px; background:#f0f9ff; padding:15px; border-radius:10px; border:1px solid #bae6fd;">
                    <label style="font-size:0.7rem; font-weight:800; color:#0369a1; display:block; margin-bottom:5px;">MANAGER FEEDBACK</label>
                    <textarea placeholder="Add coaching notes or performance feedback..." 
                        style="width:100%; border:1px solid #7dd3fc; border-radius:8px; padding:10px; font-family:inherit; font-size:0.9rem; resize:vertical;"
                        onchange="updG(${i}, 'comment', this.value)">${g.comment || ''}</textarea>
                </div>`;
                }
                // Case B: Approved Scorecard (Visible to everyone)
                else if (stat === 'Approved' || stat === 'Published') {
                    ratingDisplay = `<span class="badge-rating lvl-${g.rating}">${g.rating} - ${ratingLabels[g.rating]}</span>`;
                    if (g.comment) {
                        commentHtml = `
                    <div style="margin-top:15px; background:var(--primary-light); padding:15px; border-radius:10px; border-left:4px solid var(--primary);">
                        <label style="font-size:0.7rem; font-weight:800; color:var(--primary); display:block; margin-bottom:5px;"><i class="fa-solid fa-comment-dots"></i> MANAGER FEEDBACK</label>
                        <div style="font-size:0.9rem; color:var(--text-main); font-style:italic;">"${g.comment}"</div>
                    </div>`;
                    }
                }
                // Case C: Admin Search Mode - Always show scores (read-only)
                else if (isAdminSearchMode) {
                    const ratingVal = g.rating || 0;
                    const ratingLbl = ratingLabels[ratingVal] || 'Not Rated';
                    ratingDisplay = ratingVal > 0 
                        ? `<span class="badge-rating lvl-${ratingVal}">${ratingVal} - ${ratingLbl}</span>`
                        : `<span class="rating-badge pending" style="background:#f1f5f9; color:#64748b;"><i class="fa-solid fa-minus"></i> &nbsp; Not Yet Rated</span>`;
                    if (g.comment) {
                        commentHtml = `
                    <div style="margin-top:15px; background:#f0f9ff; padding:15px; border-radius:10px; border-left:4px solid #3b82f6;">
                        <label style="font-size:0.7rem; font-weight:800; color:#1d4ed8; display:block; margin-bottom:5px;"><i class="fa-solid fa-comment-dots"></i> MANAGER FEEDBACK</label>
                        <div style="font-size:0.9rem; color:var(--text-main); font-style:italic;">"${g.comment}"</div>
                    </div>`;
                    }
                }
                // Case D: Submitted to HR (Hidden from Employee, visible to Manager/Admin)
                else if (!viewingSelf && (isManager || ['Admin', 'Master'].includes(uRole))) {
                    ratingDisplay = `<span class="badge-rating lvl-${g.rating}">${g.rating} - ${ratingLabels[g.rating]}</span>`;
                    if (g.comment) {
                        commentHtml = `<div style="margin-top:10px; font-size:0.85rem; color:var(--text-muted);"><strong>Draft Comment:</strong> ${g.comment}</div>`;
                    }
                }

                return `
        <div class="pro-goal-card animate-in" style="animation-delay: ${i * 0.1}s; ${isInvalid ? 'border-left: 6px solid var(--danger); background: #fff1f2;' : ''}">
            ${isInvalid ? '<div style="color:var(--danger); font-size:0.7rem; font-weight:800; margin-bottom:10px;"><i class="fa-solid fa-circle-exclamation"></i> ACTION REQUIRED: WEIGHT IS 0%</div>' : ''}
            
            <div class="pro-goal-header">
                <div style="flex:1;">
                    <div style="font-size:1.1rem; font-weight:700; color:var(--text-main);">${escapeHTML(g.title)}</div>
                </div>
                <div class="pro-goal-meta">
                    ${g.unit ? `<div class="pro-unit-badge"><i class="fa-solid fa-ruler"></i> ${escapeHTML(g.unit)}</div>` : ''}
                    <div class="pro-weight-badge">Weight: <strong style="${isInvalid ? 'color:var(--danger);' : ''}">${(g.weight * 100).toFixed(0)}%</strong></div>
                    ${edit ? `<button class="btn btn-outline" style="padding:6px 12px;" onclick="openGoalModal(${i})"><i class="fa-solid fa-pen"></i></button>` : ''}
                </div>
            </div>
            
            <div class="pro-goal-desc" style="background:#f8fafc; margin:15px 0; border:none; color:var(--text-muted);">${g.desc || 'No description provided.'}</div>

            <div class="pro-targets-container">
                ${tHeaders.map((h, ti) => `
                    <div class="pro-target-item ${ti === 3 ? 'is-target' : ''}">
                        <div class="pro-target-header">${h}</div>
                        <div style="padding:10px; text-align:center; font-size:0.85rem; color:var(--text-main); font-weight:600;">${g.targets[ti] || '-'}</div>
                    </div>`).join('')}
            </div>

            <div style="margin-top:20px; display:flex; justify-content:space-between; align-items:center;">
                <div style="display:flex; align-items:center; gap:12px;">
                    <span style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Achievement Level</span>
                    ${ratingDisplay}
                </div>
                
                ${edit ? `<button class="btn btn-outline" style="color:var(--danger); border-color:#fee2e2; padding:6px 12px; font-size:0.8rem;" onclick="delG(${i})"><i class="fa-solid fa-trash"></i></button>` : ''}
            </div>
            ${commentHtml}
        </div>`;
            }).join('');
        }
        // --- GOAL MODAL & LOGIC ---
        function openGoalModal(index = null) {
            try {
                editingGoalIndex = index;
                const modal = document.getElementById('goal-modal');
                if (!modal) { alert("Error: Goal Modal element not found in DOM"); return; }

                const title = document.getElementById('gm-title');
                const btn = document.getElementById('gm-btn');

                modal.style.display = 'flex';
                // Force reflow
                void modal.offsetWidth;
                setTimeout(() => modal.classList.add('open'), 10);

                if (index !== null) {
                    if (!targetUser || !targetUser[COL.goals]) { alert("Error: User data missing"); return; }
                    const g = targetUser[COL.goals][index];
                    title.innerText = "Edit Objective";
                    btn.innerText = "Save Changes";
                    if (document.getElementById('gm-title-inp')) document.getElementById('gm-title-inp').value = g.title;
                    if (document.getElementById('gm-unit')) document.getElementById('gm-unit').value = g.unit || '';
                    if (document.getElementById('gm-weight')) document.getElementById('gm-weight').value = g.weight * 100;
                    if (document.getElementById('gm-desc')) document.getElementById('gm-desc').value = g.desc || '';

                    const inputs = document.querySelectorAll('.gm-target-inp');
                    (g.targets || []).forEach((t, i) => { if (inputs[i]) inputs[i].value = t; });
                } else {
                    title.innerText = "Add New Objective";
                    btn.innerText = "Add Objective";
                    if (document.getElementById('gm-title-inp')) document.getElementById('gm-title-inp').value = '';
                    if (document.getElementById('gm-unit')) document.getElementById('gm-unit').value = '';
                    if (document.getElementById('gm-weight')) document.getElementById('gm-weight').value = '';
                    if (document.getElementById('gm-desc')) document.getElementById('gm-desc').value = '';
                    document.querySelectorAll('.gm-target-inp').forEach(i => i.value = '');
                }
            } catch (e) { console.error(e); alert("Modal Error: " + e.message); }
        }

        function closeGoalModal() {
            const modal = document.getElementById('goal-modal');
            modal.classList.remove('open');
            setTimeout(() => modal.style.display = 'none', 300);
            editingGoalIndex = null;
        }

        function saveGoal() {
            const title = document.getElementById('gm-title-inp').value.trim();
            const unit = document.getElementById('gm-unit').value.trim();
            const weight = parseFloat(document.getElementById('gm-weight').value) || 0;
            const desc = document.getElementById('gm-desc').value.trim();

            if (!title) { showToast("Goal Title is required", "error"); return; }

            const targets = [];
            document.querySelectorAll('.gm-target-inp').forEach(i => targets.push(i.value.trim()));

            const newGoal = {
                title: title,
                weight: weight / 100,
                unit: unit,
                desc: desc,
                comment: "",
                rating: 0,
                targets: targets
            };

            if (editingGoalIndex !== null) {
                // Preserve existing stats/rating if just editing text
                newGoal.rating = targetUser[COL.goals][editingGoalIndex].rating || 0;
                targetUser[COL.goals][editingGoalIndex] = newGoal;
                showToast("Objective updated", "success");
            } else {
                targetUser[COL.goals].push(newGoal);
                showToast("New Objective added", "success");
            }

            closeGoalModal();
            renderGoals(true);
            calc();
            autoSave();
        }

        function updG(i, f, v) {
            // 1. Convert to number if the field is the rating
            if (f === 'rating') v = parseInt(v);

            // 2. Update the data in the array
            targetUser[COL.goals][i][f] = v;

            // 3. ONLY run calc if the rating changed (Efficiency improvement)
            // Comments don't affect the final score, so no need to refresh charts/headers
            if (f === 'rating') calc();

            // 4. Save to Supabase
            autoSave();
        }
        // updT is no longer used directly by inputs, but kept for legacy or potential direct internal usage
        function updT(gi, ti, v) { if (!targetUser[COL.goals][gi].targets) targetUser[COL.goals][gi].targets = Array(6).fill(''); targetUser[COL.goals][gi].targets[ti] = v; autoSave(); }
        function addG() { openGoalModal(); }

        async function delG(i) { if (confirm("Delete goal?")) { targetUser[COL.goals].splice(i, 1); renderGoals(true); calc(); autoSave(); } }

        function calc() {
            if (!targetUser) return;

            // 1. Get User Profile Data & Weights
            const w = getW(targetUser[COL.lvl], targetUser[COL.job]);
            const userDiv = (targetUser[COL.div] || "").trim();
            const userId = (targetUser[COL.id] || "").trim();
            const userComp = getCompany(userId);

            // ============================================================
            // STEP 1: CALCULATE SHARED GOALS (Normalized)
            // ============================================================
            let sContrib = 0;
            let totalSharedAssigned = 0;
            const activeSharedGoals = [];

            // A. Gather Active Shared Goals & Weights
            (masterData.goals || []).forEach(g => {
                let weightForGoal = 0;
                let isAssigned = false;

                // Check Assignments
                (g.assignments || []).forEach(a => {
                    const t = a.target;
                    let weight = Number(a.weight) || 0;

                    // Division Override
                    if (t.startsWith('DIV_') || t === userDiv) {
                        const divName = t.replace('DIV_', '');
                        if (g.division_weights && g.division_weights[divName]) {
                            const cfg = g.division_weights[divName];
                            if (cfg.managers && cfg.managers[userId] != null) {
                                weight = Number(cfg.managers[userId]);
                            } else {
                                weight = Number(cfg.default_weight);
                            }
                        }
                    }

                    // Standard Assignments
                    if (t === 'GLOBAL_ALL' ||
                        t === `COMP_${userComp}` ||
                        t === `DIV_${userDiv}` || t === userDiv ||
                        t === `ID_${userId}` || t === userId) {
                        weightForGoal = weight;
                        isAssigned = true;
                    }
                });

                if (isAssigned) {
                    if (weightForGoal > 1) weightForGoal = weightForGoal / 100;
                    totalSharedAssigned += weightForGoal;
                    activeSharedGoals.push({
                        rating: Number(g.rating) || 0,
                        rawWeight: weightForGoal
                    });
                }
            });

            // B. Normalize Shared Goals (Cap at Category Weight)
            const sharedCap = w.s / 100;
            let sharedScaleFactor = 1;

            // If assigned > Cap (e.g. 15% assigned vs 5% cap), scale down
            if (totalSharedAssigned > sharedCap && sharedCap > 0) {
                sharedScaleFactor = sharedCap / totalSharedAssigned;
            }

            // C. Calculate Final Shared Score
            activeSharedGoals.forEach(g => {
                sContrib += g.rating * (g.rawWeight * sharedScaleFactor);
            });

            // ============================================================
            // STEP 2: CALCULATE INDIVIDUAL GOALS (Normalized to Allocation)
            // ============================================================
            let individualGoalScore = 0;
            let totalIndivWeight = 0;

            // A. Sum Total Weight of Individual Goals
            if (targetUser[COL.goals]) {
                targetUser[COL.goals].forEach(g => {
                    totalIndivWeight += (Number(g.weight) || 0);
                });
            }

            // B. Determine Normalization Factor
            // FIXED: Scale weights to match the employee's individual allocation (w.i / 100)
            // For example, if a manager has 90% individual allocation and goals sum to 100%:
            // - Scale factor = 0.9 / 1.0 = 0.9
            // - Each 25% goal becomes 22.5%, four goals = 90% total
            const individualCap = w.i / 100; // Convert percentage to decimal (90 -> 0.9)
            let indivScaleFactor = 1;
            
            if (totalIndivWeight > 0) {
                // Scale goals to fit within the individual allocation
                indivScaleFactor = individualCap / totalIndivWeight;
            }

            // C. Calculate Weighted Score (Already Scaled to Allocation)
            if (targetUser[COL.goals]) {
                targetUser[COL.goals].forEach(g => {
                    const rawWeight = Number(g.weight) || 0;
                    const rating = Number(g.rating) || 0;

                    // Apply normalization - weights now sum to individualCap (e.g., 0.9)
                    const effectiveWeight = rawWeight * indivScaleFactor;

                    individualGoalScore += rating * effectiveWeight;
                });
            }

            // D. No additional multiplication needed - weights are already scaled to allocation
            // FIXED: Individual score is already properly weighted
            const iContrib = individualGoalScore;

            // ============================================================
            // STEP 3: FINAL TOTAL & UI UPDATE
            // ============================================================
            const total = sContrib + iContrib;

            const currentUid = (user[COL.id] || '').toString();
            const profileUid = (targetUser[COL.id] || '').toString();
            const viewingSelf = (currentUid === profileUid);
            const uRole = getRole(user);

            const statusClean = (targetUser[COL.stat] || '').trim().toLowerCase();
            // Allow admin search mode to see scores even for drafts
            const canSeeScore = (statusClean === 'published') || 
                               (!viewingSelf && (isManager || ['Admin', 'Master'].includes(uRole))) ||
                               isAdminSearchMode;

            const scoreEl = document.getElementById('score');
            const ratingEl = document.getElementById('rating');
            const sharedScoreEl = document.getElementById('shared-contrib-val');
            const indivScoreEl = document.getElementById('indiv-contrib-val');
            const scoreProgress = document.getElementById('score-progress');
            const ratingProgress = document.getElementById('rating-progress');

            if (canSeeScore) {
                if (scoreEl) scoreEl.innerText = total.toFixed(2);
                if (sharedScoreEl) sharedScoreEl.innerText = sContrib.toFixed(2);
                if (indivScoreEl) indivScoreEl.innerText = iContrib.toFixed(2);

                // Update progress bars (max score is 6)
                const scorePercent = Math.min((total / 6) * 100, 100);
                if (scoreProgress) scoreProgress.style.width = scorePercent + '%';

                let lbl = "-";
                let ratingPercent = 0;
                if (total >= 5.5) { lbl = "ASTRONAUT"; ratingPercent = 100; }
                else if (total >= 4.5) { lbl = "FLYER"; ratingPercent = 83; }
                else if (total >= 3.5) { lbl = "RUNNER"; ratingPercent = 67; }
                else if (total >= 2.5) { lbl = "WALKER"; ratingPercent = 50; }
                else if (total >= 1.5) { lbl = "STAGNANT"; ratingPercent = 33; }
                else if (total > 0) { lbl = "IDLE"; ratingPercent = 17; }

                if (ratingEl) ratingEl.innerText = lbl;
                if (ratingProgress) ratingProgress.style.width = ratingPercent + '%';
            } else {
                if (scoreEl) scoreEl.innerHTML = '<i class="fa-solid fa-lock" style="font-size:1.5rem; opacity:0.3;"></i>';
                if (ratingEl) ratingEl.innerText = "Pending HR";
                if (scoreProgress) scoreProgress.style.width = '0%';
                if (ratingProgress) ratingProgress.style.width = '0%';
            }
        }
        function autoSave() {
            showSaving();
            clearTimeout(saveTimer);

            saveTimer = setTimeout(async () => {
                try {
                    // Prepare the data
                    let u = {};
                    u[COL.goals] = targetUser[COL.goals];

                    // --- FIX: ALWAYS INCLUDE THE ID ---
                    // The secure backend needs this to verify permissions!
                    u[COL.id] = targetUser[COL.id];

                    // Send to Backend
                    // We use .upsert() here because it's safer for our new PHP logic
                    // than the old .update() wrapper.
                    const { error } = await db.from('active_list').upsert(u);

                    if (error) {
                        console.error("AutoSave Error:", error);
                        showToast("Save Failed: " + error.message, 'error');
                        // Visual feedback that it failed
                        document.getElementById('save-text').innerText = "Save Failed";
                        document.getElementById('save-dot').style.background = "#ef4444"; // Red
                    } else {
                        showSaved();
                        
                        // --- AUTO-REFRESH: Clear cache and update local data ---
                        // This ensures Reports and Analytics show real-time changes
                        clearDataCache();
                        
                        // Update the local allCompanyData array with the change
                        const idx = allCompanyData.findIndex(x => x[COL.id] === targetUser[COL.id]);
                        if (idx !== -1) {
                            allCompanyData[idx][COL.goals] = targetUser[COL.goals];
                            allCompanyData[idx][COL.stat] = targetUser[COL.stat];
                        }
                        
                        // Refresh notifications to reflect changes
                        if (typeof refreshNotifications === 'function') {
                            refreshNotifications();
                        }
                    }
                } catch (err) {
                    console.error("AutoSave Crash:", err);
                    showToast("Connection Error", 'error');
                }
            }, 500);
        }
        function showSaving() { document.getElementById('save-status').classList.add('show'); document.getElementById('save-dot').className = 'save-dot saving'; document.getElementById('save-text').innerText = "Saving..."; }
        function showSaved() { document.getElementById('save-dot').className = 'save-dot saved'; document.getElementById('save-text').innerText = "All changes saved"; setTimeout(() => document.getElementById('save-status').classList.remove('show'), 2000); }
        async function saveDraft() { autoSave(); }

        async function submitFinal() {
            // --- 1. VALIDATION: Check for 0% Weight Goals ---
            const goals = targetUser[COL.goals] || [];
            let hasZeroWeight = false;
            let zeroWeightTitle = "";

            for (let g of goals) {
                if (!g.weight || parseFloat(g.weight) === 0) {
                    hasZeroWeight = true;
                    zeroWeightTitle = g.title;
                    break;
                }
            }

            if (hasZeroWeight) {
                showToast(`Cannot submit: The goal "${zeroWeightTitle}" has 0% weight.`, 'error');
                return;
            }

            // --- 2. VALIDATION: Total Weight Sum ---
            const w = getW(targetUser[COL.lvl], targetUser[COL.job]);
            const allowedPct = w.i;
            let currentSum = 0;
            goals.forEach(g => currentSum += (g.weight || 0));
            const currentPct = Math.round(currentSum * 100);

            if (currentPct !== allowedPct) {
                showToast(`Total Weight is ${currentPct}%. It must be exactly ${allowedPct}%.`, 'error');
                return;
            }

            // --- 3. AMENDED TRANSITION LOGIC ---
            const myId = (user[COL.id] || '').toString();
            const targetId = (targetUser[COL.id] || '').toString();
            const viewingSelf = (myId === targetId);
            const uRole = getRole(user);
            const stat = targetUser[COL.stat] || 'Draft';

            let confirmTitle = "Confirm Submission";
            let confirmMsg = "Are you sure you want to proceed?";
            let newStatus = "";

            if (viewingSelf) {
                confirmMsg = "Submit to Manager? You won't be able to edit your goals anymore.";
                newStatus = "Submitted to Manager";
            } else if (isDirectSupervisor && stat === 'Submitted to Manager') {
                // --- VALIDATION: Check if manager rated all individual objectives ---
                const goals = targetUser[COL.goals] || [];
                const unratedGoals = goals.filter(g => !g.rating || g.rating === 0 || g.rating === '0');
                
                if (unratedGoals.length > 0) {
                    showToast(`Please rate all individual objectives before submitting. ${unratedGoals.length} objective(s) still need ratings.`, 'error');
                    return;
                }
                
                confirmMsg = "Approve & Submit to HR? Feedback and ratings will be finalized.";
                newStatus = "Submitted to HR";
            } else if ((uRole === 'Admin' || uRole === 'Master') && stat === 'Submitted to HR') {
                confirmTitle = "Final Approval";
                confirmMsg = "Perform Final Approval?";
                newStatus = "Approved";
            }

            if (!newStatus) return;

            showConfirm(confirmTitle, confirmMsg, "Proceed", "primary", async () => {
                const btn = document.getElementById('btn-submit-final');
                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
                }

                // --- FIX: INCLUDE THE ID IN THE PAYLOAD ---
                let u = {};
                u[COL.id] = targetUser[COL.id]; // <--- CRITICAL FIX
                u[COL.goals] = targetUser[COL.goals];
                u[COL.stat] = newStatus;

                // Use UPSERT instead of update because your PHP handle 'upsert' more robustly with IDs
                const { error } = await db.from('active_list').upsert(u);

                if (error) {
                    showToast("Update failed: " + (error.message || "Unauthorized"), 'error');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerText = "Try Again";
                    }
                } else {
                    logActivity('SUBMIT', `Status changed to: ${newStatus}`, targetUser[COL.id]);
                    showToast("Success! Reloading...", 'success');
                    // Small delay to ensure the DB processes before reload
                    setTimeout(() => location.reload(), 1000);
                }
            });
        }
        async function rejectCard() {
            showConfirm("Reject Scorecard", "Return this scorecard to the employee for editing?", "Reject & Return", "danger", async () => {
                const { error } = await db.from('active_list').update({ [COL.stat]: 'Returned' }).eq(COL.id, targetUser[COL.id]);
                if (error) showToast("Error: " + error.message, 'error');
                else {
                    logActivity('REJECT', 'Scorecard returned to employee', targetUser[COL.id]);
                    showToast("Card returned to Employee", 'success');
                    setTimeout(() => location.reload(), 1500);
                }
            });
        }

        function render(h) { document.getElementById('main-view').innerHTML = h; }

        // --- USER MODAL ---
        function openUserModal(id) {
            const isEdit = !!id;
            const modal = document.getElementById('user-modal');
            const title = document.getElementById('um-title');
            const btn = document.getElementById('um-btn');

            // Allow transitions
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('open'), 10);

            if (isEdit) {
                const u = allCompanyData.find(x => x[COL.id] === id);
                if (!u) return;
                title.innerText = "Edit Employee";
                btn.innerText = "Save Changes";
                document.getElementById('um-id').value = u[COL.id];
                document.getElementById('um-id').readOnly = true;
                document.getElementById('um-name').value = u[COL.name];
                document.getElementById('um-job').value = u[COL.job] || '';
                document.getElementById('um-div').value = u[COL.div] || '';
                document.getElementById('um-mgr').value = u[COL.mgr] || '';
                document.getElementById('um-role').value = u[COL.role] || '';
                document.getElementById('um-orig-id').value = u[COL.id];
            } else {
                title.innerText = "Add New Employee";
                btn.innerText = "Create User";
                document.getElementById('um-id').value = '';
                document.getElementById('um-id').readOnly = false;
                document.getElementById('um-name').value = '';
                document.getElementById('um-job').value = '';
                document.getElementById('um-div').value = '';
                document.getElementById('um-mgr').value = '';
                document.getElementById('um-role').value = '';
                document.getElementById('um-orig-id').value = '';
            }
        }

        function closeUserModal() {
            const modal = document.getElementById('user-modal');
            modal.classList.remove('open');
            setTimeout(() => modal.style.display = 'none', 300);
        }

        async function saveUser() {
            // Select inputs using your original IDs (um-)
            const id = document.getElementById('um-id').value.trim();
            const name = document.getElementById('um-name').value.trim();
            const email = document.getElementById('um-email').value.trim(); // New Field
            const phone = document.getElementById('um-phone').value.trim(); // New Field
            const job = document.getElementById('um-job').value.trim();
            const div = document.getElementById('um-div').value.trim();
            const mgr = document.getElementById('um-mgr').value.trim();
            const role = document.getElementById('um-role').value.trim();
            const origId = document.getElementById('um-orig-id').value;

            // Validation
            if (!id || !name) {
                showToast("ID and Name are required", "error");
                return;
            }

            // Build the user object using COL mapping
            let u = {};
            u[COL.id] = id;
            u[COL.name] = name;
            u[COL.email] = email; // New Mapping
            u[COL.phone] = phone; // New Mapping
            u[COL.job] = job;
            u[COL.div] = div;
            u[COL.mgr] = mgr;
            u[COL.role] = role;
            u[COL.pass] = "123"; // Default password as per your original code
            u[COL.lvl] = "L4";    // Default level as per your original code

            let error;
            if (origId) {
                // Update logic using the original ID to match record in Supabase
                const { error: err } = await db.from('active_list').update(u).eq(COL.id, origId);
                error = err;
            } else {
                // Insert logic for brand new records
                const { error: err } = await db.from('active_list').insert([u]);
                error = err;
            }

            if (error) {
                showToast("Error saving user: " + error.message, "error");
            } else {
                showToast("User saved successfully", "success");
                closeUserModal(); // Close modal using your original function name

                allCompanyData = await fetchAllData(); // Refresh the global cache

                // Refresh the Directory Table if it is currently visible
                if (document.getElementById('dir-table')) {
                    const q = document.querySelector('.search-box-container input') ?
                        document.querySelector('.search-box-container input').value : "";
                    searchDirectory(q);
                }
            }
        }
        function renderNav(r) {
            let h = '';
            // Helper for items
            const mkItem = (lbl, icon, fn) => `<div class="nav-item COMP-NAV" onclick="setActiveNav(this); ${fn}"><i class="${icon}"></i> <span>${lbl}</span></div>`;
            // Helper for sections
            const mkSec = (lbl) => `<div style="font-size:0.75rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; padding:16px 12px 8px 12px; margin-top:8px;">${lbl}</div>`;

            // 1. Administration Section
            if (r === 'Admin' || r === 'Master') {
                h += mkSec('Administration');
                h += mkItem('HR Admin', 'fa-solid fa-user-shield', 'loadHRAdmin()');
            }

            // 2. Management Section
            const isMgr = ['Chief', 'Director', 'Senior Manager', 'Manager', 'Admin', 'Master'].includes(r);
            if (isMgr) {
                h += mkSec('Management');
                if (['Chief', 'Director', 'Senior Manager', 'Manager', 'Admin', 'Master'].includes(r)) h += mkItem('My Team', 'fa-solid fa-users', 'loadTeam()');
                if (['Chief', 'Director', 'Senior Manager', 'Manager', 'Admin', 'Master'].includes(r)) h += mkItem('Reports', 'fa-solid fa-chart-line', 'loadReports()');
            }

            // 3. Personal Section (Everyone)
            h += mkSec('Personal');
            h += mkItem('My Scorecard', 'fa-solid fa-address-card', `loadEval('${user[COL.id]}')`);

            document.getElementById('nav-menu').innerHTML = h;
        }
        function setActiveNav(el) {
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        // --- PERFORMANCE HISTORY MODAL ---
        async function showHistory(empId) {
            // Create and show modal
            let modal = document.getElementById('history-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'history-modal';
                modal.innerHTML = `
                    <div style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:9000; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(4px);">
                        <div style="background:white; width:90%; max-width:700px; max-height:90vh; border-radius:20px; overflow:hidden; display:flex; flex-direction:column;">
                            <div style="padding:24px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
                                <h3 style="margin:0; font-size:1.3rem; font-weight:700;"><i class="fa-solid fa-clock-rotate-left" style="color:var(--primary); margin-right:10px;"></i>Performance History</h3>
                                <button onclick="document.getElementById('history-modal').remove()" style="background:none; border:none; font-size:1.3rem; cursor:pointer; color:var(--text-muted);">
                                    <i class="fa-solid fa-xmark"></i>
                                </button>
                            </div>
                            <div id="history-modal-content" style="padding:24px; overflow-y:auto; flex:1;"></div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                modal.style.display = 'block';
            }

            const contentDiv = document.getElementById('history-modal-content');
            contentDiv.innerHTML = '<div class="spinner" style="margin:40px auto;"></div>';

            try {
                const history = await getEmployeeHistory(empId);
                
                if (history.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align:center; padding:60px 20px; color:var(--text-muted);">
                            <i class="fa-solid fa-folder-open" style="font-size:3rem; opacity:0.3; margin-bottom:16px; display:block;"></i>
                            <div style="font-weight:600;">No Historical Records</div>
                            <div style="font-size:0.9rem; margin-top:8px;">This is the first performance cycle for this employee.</div>
                        </div>
                    `;
                    return;
                }

                const emp = history[0];
                let html = `
                    <div style="background:linear-gradient(135deg, #f8fafc, #ffffff); padding:20px; border-radius:12px; margin-bottom:24px; border:1px solid var(--border);">
                        <div style="font-size:1.3rem; font-weight:700; color:var(--text-main);">${escapeHTML(emp.name || 'Unknown Employee')}</div>
                        <div style="color:var(--text-muted); font-size:0.9rem; margin-top:4px;">${escapeHTML(emp.job || 'N/A')}  ${escapeHTML(emp.division || 'N/A')}</div>
                    </div>
                    
                    <div style="font-size:0.8rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; font-weight:700;">
                        ${history.length} Cycle${history.length > 1 ? 's' : ''} Found
                    </div>
                `;

                for (const record of history) {
                    const goals = typeof record.goals === 'string' ? JSON.parse(record.goals || '[]') : (record.goals || []);
                    const status = record.status || 'Draft';
                    const cycle = record.cycle || '2025';
                    
                    // Calculate score
                    let score = 0;
                    let indivScore = 0;
                    if (goals.length > 0) {
                        const totalWeight = goals.reduce((sum, g) => sum + (parseFloat(g.weight) || 0), 0);
                        if (totalWeight > 0) {
                            indivScore = goals.reduce((sum, g) => sum + ((parseFloat(g.rating) || 0) * (parseFloat(g.weight) || 0)), 0);
                        }
                    }
                    
                    // This is simplified - in reality would need shared goals too
                    score = indivScore;
                    
                    let rating = '-';
                    let ratingColor = '#94a3b8';
                    if (score >= 5.5) { rating = 'ASTRONAUT'; ratingColor = '#0f766e'; }
                    else if (score >= 4.5) { rating = 'FLYER'; ratingColor = '#10b981'; }
                    else if (score >= 3.5) { rating = 'RUNNER'; ratingColor = '#3b82f6'; }
                    else if (score >= 2.5) { rating = 'WALKER'; ratingColor = '#f59e0b'; }
                    else if (score >= 1.5) { rating = 'STAGNANT'; ratingColor = '#ef4444'; }
                    else if (score > 0) { rating = 'IDLE'; ratingColor = '#94a3b8'; }

                    const isCurrentCycle = cycle === currentCycle;
                    const isPublished = status === 'Published' || status === 'Approved';

                    html += `
                        <div style="background:white; border:1px solid ${isCurrentCycle ? 'var(--primary)' : 'var(--border)'}; border-radius:16px; padding:20px; margin-bottom:16px; ${isCurrentCycle ? 'box-shadow:0 4px 15px rgba(13,148,136,0.15);' : ''}">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:16px;">
                                <div>
                                    <div style="font-size:1.8rem; font-weight:800; color:${isCurrentCycle ? 'var(--primary)' : 'var(--text-main)'};">
                                        ${cycle}
                                        ${isCurrentCycle ? '<span style="font-size:0.6rem; background:var(--primary); color:white; padding:3px 8px; border-radius:10px; margin-left:8px; vertical-align:middle;">CURRENT</span>' : ''}
                                    </div>
                                </div>
                                <span style="background:${isPublished ? '#d1fae5' : '#f1f5f9'}; color:${isPublished ? '#059669' : '#64748b'}; padding:6px 14px; border-radius:20px; font-size:0.8rem; font-weight:600;">
                                    ${escapeHTML(status)}
                                </span>
                            </div>
                            
                            ${isPublished ? `
                            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:20px; background:#f8fafc; padding:16px; border-radius:12px;">
                                <div style="text-align:center;">
                                    <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Final Score</div>
                                    <div style="font-size:2rem; font-weight:800; color:var(--text-main);">${score > 0 ? score.toFixed(2) : '-'}</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Rating</div>
                                    <div style="font-size:1.1rem; font-weight:800; color:${ratingColor}; margin-top:8px;">${rating}</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Objectives</div>
                                    <div style="font-size:2rem; font-weight:800; color:var(--text-main);">${goals.length}</div>
                                </div>
                            </div>
                            ` : `
                            <div style="text-align:center; padding:20px; color:var(--text-muted); background:#f8fafc; border-radius:12px;">
                                <i class="fa-solid fa-lock" style="font-size:1.5rem; opacity:0.3; margin-bottom:8px; display:block;"></i>
                                <div style="font-size:0.9rem;">Results will be visible after publishing</div>
                            </div>
                            `}
                        </div>
                    `;
                }

                contentDiv.innerHTML = html;
            } catch (e) {
                console.error('Error loading history:', e);
                contentDiv.innerHTML = `
                    <div style="text-align:center; padding:40px; color:var(--danger);">
                        <i class="fa-solid fa-exclamation-triangle" style="font-size:2rem; margin-bottom:12px; display:block;"></i>
                        <div>Error loading history</div>
                        <div style="font-size:0.85rem; margin-top:8px;">${escapeHTML(e.message)}</div>
                    </div>
                `;
            }
        }

        // --- GLOBAL UI HELPERS ---
        function showToast(msg, type = 'success') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            // SECURITY: Auto-escape message to prevent XSS
            const safeMsg = escapeHTML(msg);
            t.innerHTML = `<div class="toast-icon"><i class="fa-solid ${type == 'success' ? 'fa-circle-check' : 'fa-circle-exclamation'}"></i></div><div class="toast-msg">${safeMsg}</div>`;
            c.appendChild(t);
            // Force reflow
            void t.offsetWidth;
            requestAnimationFrame(() => t.classList.add('show'));
            setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 400); }, 4000);
        }

        let confirmCallback = null;
        function showConfirm(title, msg, yesText, type = 'primary', cb) {
            document.getElementById('conf-title').innerText = title;
            document.getElementById('conf-msg').innerText = msg;
            const btn = document.getElementById('conf-btn-yes');
            btn.innerText = yesText;
            btn.className = `btn btn-${type}`;
            // Fix icon based on type
            const icon = type === 'danger' ? '<i class="fa-solid fa-triangle-exclamation"></i> ' : '<i class="fa-solid fa-check"></i> ';
            btn.innerHTML = icon + yesText;

            confirmCallback = cb;
            document.getElementById('confirm-overlay').classList.add('open');
        }
        function closeConfirm() { document.getElementById('confirm-overlay').classList.remove('open'); confirmCallback = null; }
        function doConfirm() { if (confirmCallback) confirmCallback(); closeConfirm(); }

        function getRole(u, isManagerByReports) {
            if (!u) return 'Staff';

            // 1. CLEAN THE DATA
            // Convert to string, trim spaces, and make uppercase for comparison
            const job = (u[COL.job] || "").toString().trim().toUpperCase();

            // 2. DEFINE THE ONLY ALLOWED ADMIN TITLE
            const masterTitle = "HEAD OF EMPLOYEE GROWTH AND RELATION DEPARTMENT";

            // 3. STRICT CHECK
            // Only return 'Master' if the job matches EXACTLY.
            // We strictly ignore the 'access_role' column here.
            if (job === masterTitle) {
                return 'Master';
            }

            // 4. CHECK FOR OTHER ROLES
            // If they manage people (have reports), they are at least a Manager
            if (isManagerByReports) return 'Manager';

            // Check levels for standard hierarchy
            const l = (u[COL.lvl] || "").toUpperCase();
            if (l.includes('L1')) return 'Chief';
            if (l.includes('L2')) return 'Director';
            if (l.includes('L3')) return 'Senior Manager';
            if (l.includes('L4')) return 'Manager';

            return 'Staff';
        }

        function getW(l, j) {
            const job = (j || "").toLowerCase().trim();
            const levelStr = (l || "").toUpperCase();
            const is = (role) => new RegExp(`\\b${role}\\b`).test(job);

            if (is('ceo') || job === 'chief executive officer') return { s: 100, i: 0 };
            if (is('cfo') || job === 'chief financial officer') return { s: 50, i: 50 };
            if (is('cco') || job === 'chief commercial officer' || is('cto') || job === 'chief technology officer') { return { s: 30, i: 70 }; }
            if (job.includes('chief')) return { s: 20, i: 80 };
            if (levelStr.includes('2') && job.includes('director')) return { s: 15, i: 85 };
            if ((levelStr.includes('3') || levelStr.includes('4')) && (job.includes('manager') || job.includes('head') || job.includes('senior'))) { return { s: 10, i: 90 }; }
            return { s: 5, i: 95 };
        }
        // --- HELPER: Recursive Downstream Lookup ---
        function getDownstream(managerId, allData) {
            if (!managerId) return [];

            const targetId = managerId.toString().toLowerCase().trim();

            // 1. Find Direct Reports
            const directReports = allData.filter(u => {
                const mRaw = u[COL.mgr] || "";
                const m = mRaw.toString().toLowerCase();
                // Matches if the column contains the ID (handles "Name (ID)" format)
                return m.includes(targetId);
            });

            let totalTeam = [...directReports];

            // 2. Recursively find reports for each direct report
            directReports.forEach(sub => {
                const subId = (sub[COL.id] || "").toString();

                // Prevent infinite loops (e.g. if someone accidentally reports to themselves)
                if (subId.toLowerCase() !== targetId) {
                    const deepReports = getDownstream(subId, allData);
                    totalTeam = totalTeam.concat(deepReports);
                }
            });

            // 3. Remove duplicates (unique by ID)
            const uniqueIds = new Set();
            return totalTeam.filter(item => {
                const id = item[COL.id];
                if (!uniqueIds.has(id)) {
                    uniqueIds.add(id);
                    return true;
                }
                return false;
            });
        }
        document.addEventListener('click', (e) => {
            // 1. Check if the clicked element is our button
            const btn = e.target.closest('.div-weights-btn');
            if (!btn) return;

            // 2. Get the data stored in the button attributes
            const goalIndex = Number(btn.getAttribute('data-goal'));
            const divName = btn.getAttribute('data-div');

            // 3. EXECUTE THE FUNCTION
            // This opens the modal that shows the manager list and weight boxes
            openDivisionWeights(goalIndex, divName);
        });
    </script>

    <!-- GLOBAL UI CONTAINERS -->
    <div id="toast-container"></div>

    <div id="confirm-overlay">
        <div class="confirm-card">
            <div style="font-size:3rem; color:var(--text-muted); margin-bottom:16px;"><i
                    class="fa-regular fa-circle-question"></i></div>
            <h3 id="conf-title" style="margin:0 0 8px 0; font-size:1.4rem;">Confirm Action</h3>
            <p id="conf-msg" style="color:var(--text-muted); margin-bottom:32px; line-height:1.5;">Are you sure you want
                to proceed?</p>
            <div style="display:flex; justify-content:center; gap:16px;">
                <button class="btn btn-outline" onclick="closeConfirm()">Cancel</button>
                <button id="conf-btn-yes" class="btn btn-primary" onclick="doConfirm()">Confirm</button>
            </div>
        </div>
    </div>

    <!-- USER MANAGEMENT MODAL -->
    <div id="user-modal" class="modal-overlay"
        style="position:fixed; inset:0; z-index:9000; display:none; align-items:center; justify-content:center; transition: opacity 0.3s;">
        <div class="modal-card"
            style="background:white; width:90%; max-width:600px; padding:32px; border-radius:20px; transform:scale(0.95); opacity:0; transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h3 id="um-title" style="margin:0; font-size:1.4rem; font-weight:700;">Edit Employee</h3>
                <button onclick="closeUserModal()"
                    style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text-muted);"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>

            <input type="hidden" id="um-orig-id">

            <div class="dash-grid" style="grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px;">

                <div style="grid-column:1/-1;">
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Full
                        Name</label>
                    <input id="um-name" class="login-input" style="margin-top:4px;" placeholder="Full Name">
                </div>

                <div style="grid-column:1/-1;">
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Email
                        Address</label>
                    <input id="um-email" class="login-input" style="margin-top:4px;" placeholder="employee@zain.com">
                </div>

                <div>
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Phone
                        Number</label>
                    <input id="um-phone" class="login-input" style="margin-top:4px;" placeholder="077XXXXXXXX">
                </div>

                <div>
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Employee
                        ID</label>
                    <input id="um-id" class="login-input" style="margin-top:4px;" placeholder="ID (e.g. ZIQ...)">
                </div>

                <div>
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Division</label>
                    <input id="um-div" class="login-input" style="margin-top:4px;" placeholder="e.g. Technology">
                </div>

                <div>
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Direct
                        Manager</label>
                    <input id="um-mgr" class="login-input" style="margin-top:4px;" placeholder="Manager Name or ID">
                </div>

            </div>
            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn btn-outline" onclick="closeUserModal()">Cancel</button>
                <button id="um-btn" class="btn btn-primary" onclick="saveUser()">Save Changes</button>
            </div>
        </div>
    </div>
    <!-- CUSTOM CSS FOR MODAL ANIMATION -->
    <style>
        #user-modal.open {
            opacity: 1 !important;
            pointer-events: auto;
        }

        #user-modal.open .modal-card {
            transform: scale(1) !important;
            opacity: 1 !important;
        }
    </style>
    <div id="goal-modal" class="modal-overlay"
        style="position:fixed; inset:0; z-index:9000; display:none; align-items:center; justify-content:center; transition: opacity 0.3s;">
        <div class="modal-card"
            style="background:white; width:90%; max-width:800px; padding:32px; border-radius:20px; transform:scale(0.95); opacity:0; transition:all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); max-height:90vh; overflow-y:auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h3 id="gm-title" style="margin:0; font-size:1.4rem; font-weight:700;">Add New Objective</h3>
                <button onclick="closeGoalModal()"
                    style="background:none; border:none; font-size:1.2rem; cursor:pointer; color:var(--text-muted);"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="dash-grid" style="grid-template-columns:2fr 1fr 1fr; gap:20px; margin-bottom:24px;">
                <div>
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Objective
                        Title</label>
                    <input id="gm-title-inp" class="login-input" style="margin-top:4px;"
                        placeholder="e.g. Increase Market Share">
                </div>
                <div>
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Unit</label>
                    <input id="gm-unit" class="login-input" style="margin-top:4px;" placeholder="e.g. %, USD, #">
                </div>
                <div>
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Weight
                        (%)</label>
                    <input id="gm-weight" type="number" class="login-input" style="margin-top:4px;"
                        placeholder="e.g. 20">
                </div>
                <div style="grid-column:1/-1;">
                    <label
                        style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase;">Description
                        & KPI</label>
                    <textarea id="gm-desc" class="login-input" rows="3"
                        style="margin-top:4px; height:auto; padding:12px;"
                        placeholder="Describe the objective and how it is measured..."></textarea>
                </div>
            </div>

            <div style="margin-bottom:24px;">
                <label
                    style="font-size:0.8rem; font-weight:700; color:var(--text-muted); text-transform:uppercase; display:block; margin-bottom:8px;">Target
                    Definition (KPI Levels)</label>
                <div style="display:grid; grid-template-columns:repeat(6, 1fr); gap:8px;">
                    <div style="text-align:center;">
                        <div class="pro-target-header"
                            style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">IDLE
                        </div>
                        <input class="gm-target-inp login-input"
                            style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header"
                            style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">
                            STAGNANT</div>
                        <input class="gm-target-inp login-input"
                            style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header"
                            style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">
                            WALKER</div>
                        <input class="gm-target-inp login-input"
                            style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header"
                            style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0; background:var(--primary-soft); color:var(--primary);">
                            RUNNER (Target)</div>
                        <input class="gm-target-inp login-input"
                            style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem; border-color:var(--primary-light); background:var(--primary-soft);"
                            placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header"
                            style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">FLYER
                        </div>
                        <input class="gm-target-inp login-input"
                            style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                    <div style="text-align:center;">
                        <div class="pro-target-header"
                            style="border:1px solid var(--border); border-bottom:none; border-radius:8px 8px 0 0;">
                            ASTRONAUT</div>
                        <input class="gm-target-inp login-input"
                            style="border-radius:0 0 8px 8px; text-align:center; font-size:0.85rem;" placeholder="-">
                    </div>
                </div>
            </div>

            <div style="display:flex; justify-content:flex-end; gap:12px;">
                <button class="btn btn-outline" onclick="closeGoalModal()">Cancel</button>
                <button id="gm-btn" class="btn btn-primary" onclick="saveGoal()">Save Objective</button>
            </div>
        </div>
    </div>
    <style>
        #goal-modal.open {
            opacity: 1 !important;
            pointer-events: auto;
        }

        #goal-modal.open .modal-card {
            transform: scale(1) !important;
            opacity: 1 !important;
        }
    </style>
</body>

</html>
